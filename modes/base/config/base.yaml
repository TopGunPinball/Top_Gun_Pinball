#config_version=6

# Base mode that starts at the beginning of each ball
# and stops at the end of each ball.
# Slides at 50(Video Background) and 0 (no video Playing)
#
# IMPORTANT: This mode stops on ball_ending. When pilot mission modes are active
# during a drain, they use queue_relay_player with high priority (1000) to hold
# ball_ending until cleanup is complete, so this mode stays alive long enough
# for pilot_mission_qualifier to properly clear pause flags when pilot modes stop.

mode:
  start_events: ball_starting
  stop_events: ball_ending
  priority: 100

event_player:
  mode_base_started:
    - start_mode_bumpers
  mode_base_will_stop:
    - stop_mode_bumpers

variable_player:
  ##############################################
  ## Total Scoring Multiplier - FIXED VERSION
  ## Initialize on BOTH player_added AND mode start
  ##############################################

  # Initialize on player added (in case base mode already running)
  player_added:
    total_scoring_multiplier:
      action: set
      float: 1.0
    bonus_switches_count:
      action: set
      int: 0
    bonus_ramps_count:
      action: set
      int: 0
    bonus_highest_mach:
      action: set
      int: 0
    # Initialize mode-active tracking variables (used for music control)
    # These are set to 1 by respective modes when they start
    training_mission_active:
      action: set
      int: 0
    hard_deck_active:
      action: set
      int: 0

  # ALSO initialize when base mode starts (this is the key fix!)
  # Reset per-ball bonus counters AND bonus multiplier
  mode_base_started:
    total_scoring_multiplier:
      action: set
      float: current_player.mach_level * (1 + current_player.x2_multiplier)
    bonus_switches_count:
      action: set
      int: 0
    bonus_ramps_count:
      action: set
      int: 0
    bonus_highest_mach:
      action: set
      int: 0
    bonus_multiplier:
      action: set
      int: 1

  # Recalculate whenever mach_level changes
  player_mach_level:
    total_scoring_multiplier:
      action: set
      float: current_player.mach_level * (1 + current_player.x2_multiplier)
  
  # Track highest mach level reached this ball
  player_mach_level{value > current_player.bonus_highest_mach}:
    bonus_highest_mach:
      action: set
      int: current_player.mach_level
  
  # Recalculate whenever x2_multiplier changes
  player_x2_multiplier:
    total_scoring_multiplier:
      action: set
      float: current_player.mach_level * (1 + current_player.x2_multiplier)

## BASE SCORING - Add to your base mode YAML
## Priority: 100 (can be blocked by higher priority modes)
##
## Scoring Philosophy:
## - Basic switches: 500-2,000 points
## - Skill shots (ramps, orbits): 5,000-10,000 points
## - Targets: 1,000-3,000 points
## - Mode shots: 150,000-1,000,000 points (defined in mode files)
##


  ##############################################
  ## SLINGSHOTS - Quick, frequent hits
  ##############################################
  s_slingshot_left_active:
    score:
      action: add
      int: 500 * current_player.total_scoring_multiplier
    bonus_switches_count:
      action: add
      int: 1
  
  s_slingshot_right_active:
    score:
      action: add
      int: 500 * current_player.total_scoring_multiplier
    bonus_switches_count:
      action: add
      int: 1
  
  ##############################################
  ## POP BUMPERS - Frequent hits
  ##############################################
  s_bumper_left_active:
    score:
      action: add
      int: 1000 * current_player.total_scoring_multiplier
    bonus_switches_count:
      action: add
      int: 1
  
  s_bumper_center_active:
    score:
      action: add
      int: 1000 * current_player.total_scoring_multiplier
    bonus_switches_count:
      action: add
      int: 1
  
  s_bumper_right_active:
    score:
      action: add
      int: 1000 * current_player.total_scoring_multiplier
    bonus_switches_count:
      action: add
      int: 1
  
  ##############################################
  ## SPINNER - Per spin (can rack up quickly)
  ##############################################
  s_spinner_active:
    score:
      action: add
      int: 1000 * current_player.total_scoring_multiplier
    bonus_switches_count:
      action: add
      int: 1
  
  ##############################################
  ## INLANES - Lower scoring (often lit for letters)
  ##############################################
  s_inlane_left_active:
    score:
      action: add
      int: 2000 * current_player.total_scoring_multiplier
    bonus_switches_count:
      action: add
      int: 1
  
  s_inner_inlane_right_active:
    score:
      action: add
      int: 2000 * current_player.total_scoring_multiplier
    bonus_switches_count:
      action: add
      int: 1
  
  s_outer_inlane_right_active:
    score:
      action: add
      int: 2000 * current_player.total_scoring_multiplier
    bonus_switches_count:
      action: add
      int: 1
  
  ##############################################
  ## OUTLANES - Higher value (ball save risk)
  ##############################################
  s_outlane_left_active:
    score:
      action: add
      int: 2000 * current_player.total_scoring_multiplier
    bonus_switches_count:
      action: add
      int: 1
  
  s_outlane_right_active:
    score:
      action: add
      int: 2000 * current_player.total_scoring_multiplier
    bonus_switches_count:
      action: add
      int: 1
  
  ##############################################
  ## MIG LANES - Skill shot area
  ##############################################
  s_mig_lane_left_active:
    score:
      action: add
      int: 5000 * current_player.total_scoring_multiplier
    bonus_switches_count:
      action: add
      int: 1
  
  s_mig_lane_right_active:
    score:
      action: add
      int: 5000 * current_player.total_scoring_multiplier
    bonus_switches_count:
      action: add
      int: 1
  
  ##############################################
  ## ICEMAN TARGETS - Standup targets (6 total)
  ##############################################
  s_i_iceman_target_active:
    score:
      action: add
      int: 2000 * current_player.total_scoring_multiplier
    bonus_switches_count:
      action: add
      int: 1
  
  s_c_iceman_target_active:
    score:
      action: add
      int: 2000 * current_player.total_scoring_multiplier
    bonus_switches_count:
      action: add
      int: 1
  
  s_e_iceman_target_active:
    score:
      action: add
      int: 2000 * current_player.total_scoring_multiplier
    bonus_switches_count:
      action: add
      int: 1
  
  s_m_iceman_target_active:
    score:
      action: add
      int: 2000 * current_player.total_scoring_multiplier
    bonus_switches_count:
      action: add
      int: 1
  
  s_a_iceman_target_active:
    score:
      action: add
      int: 2000 * current_player.total_scoring_multiplier
    bonus_switches_count:
      action: add
      int: 1
  
  s_n_iceman_target_active:
    score:
      action: add
      int: 2000 * current_player.total_scoring_multiplier
    bonus_switches_count:
      action: add
      int: 1
  
  ##############################################
  ## LOCK TARGETS - Standup targets (4 total)
  ##############################################
  s_l_lock_target_active:
    score:
      action: add
      int: 2500 * current_player.total_scoring_multiplier
    bonus_switches_count:
      action: add
      int: 1
  
  s_o_lock_target_active:
    score:
      action: add
      int: 2500 * current_player.total_scoring_multiplier
    bonus_switches_count:
      action: add
      int: 1
  
  s_c_lock_target_active:
    score:
      action: add
      int: 2500 * current_player.total_scoring_multiplier
    bonus_switches_count:
      action: add
      int: 1
  
  s_k_lock_target_active:
    score:
      action: add
      int: 2500 * current_player.total_scoring_multiplier
    bonus_switches_count:
      action: add
      int: 1
  
  ##############################################
  ## SPECIAL TARGETS
  ##############################################
  s_barrier_target_active:
    score:
      action: add
      int: 3000 * current_player.total_scoring_multiplier
    bonus_switches_count:
      action: add
      int: 1
  
  s_flight_gear_target_active:
    score:
      action: add
      int: 3000 * current_player.total_scoring_multiplier
    bonus_switches_count:
      action: add
      int: 1
  
  ##############################################
  ## RAMPS - Major shots
  ##############################################
  s_ramp_left_exit_active:
    score:
      action: add
      int: 10000 * current_player.total_scoring_multiplier
    bonus_switches_count:
      action: add
      int: 1
    bonus_ramps_count:
      action: add
      int: 1
  
  s_ramp_right_exit_active:
    score:
      action: add
      int: 10000 * current_player.total_scoring_multiplier
    bonus_switches_count:
      action: add
      int: 1
    bonus_ramps_count:
      action: add
      int: 1
  
  s_ramp_inner_exit_active:
    score:
      action: add
      int: 10000 * current_player.total_scoring_multiplier
    bonus_switches_count:
      action: add
      int: 1
    bonus_ramps_count:
      action: add
      int: 1
  
  s_ramp_tower_exit_active:
    score:
      action: add
      int: 15000 * current_player.total_scoring_multiplier
    bonus_switches_count:
      action: add
      int: 1
    bonus_ramps_count:
      action: add
      int: 1
  
  ##############################################
  ## ORBITS - Major shots
  ##############################################
  s_orbit_left_active:
    score:
      action: add
      int: 8000 * current_player.total_scoring_multiplier
    bonus_switches_count:
      action: add
      int: 1
  
  s_orbit_right_active:
    score:
      action: add
      int: 8000 * current_player.total_scoring_multiplier
    bonus_switches_count:
      action: add
      int: 1
  
  s_orbit_upper_active:
    score:
      action: add
      int: 10000 * current_player.total_scoring_multiplier
    bonus_switches_count:
      action: add
      int: 1
  
  s_orbit_lower_active:
    score:
      action: add
      int: 10000 * current_player.total_scoring_multiplier
    bonus_switches_count:
      action: add
      int: 1
  
  ##############################################
  ## LANES - Feed shots
  ##############################################
  s_lane_left_active:
    score:
      action: add
      int: 5000 * current_player.total_scoring_multiplier
    bonus_switches_count:
      action: add
      int: 1
  
  s_lane_right_active:
    score:
      action: add
      int: 5000 * current_player.total_scoring_multiplier
    bonus_switches_count:
      action: add
      int: 1
  
  ##############################################
  ## LOCK SWITCHES - Special shots
  ##############################################
  s_lock_mav_active:
    score:
      action: add
      int: 25000 * current_player.total_scoring_multiplier
    bonus_switches_count:
      action: add
      int: 1
  
  s_lock_goose_active:
    score:
      action: add
      int: 25000 * current_player.total_scoring_multiplier
    bonus_switches_count:
      action: add
      int: 1
  
  ##############################################
  ## NO SCORING for these switches:
  ## - Flippers (s_flipper_left, s_flipper_right, etc.)
  ## - Flipper EOS switches
  ## - Trough switches (s_trough_1-6, s_jam)
  ## - Shooter lane (s_shooter_lane) - typically only scores on skillshot
  ## - Lock plunger (s_lock_plunger) - mechanical
  ## - Cabinet switches (coin door, service, tilt)
  ##############################################

slide_player:
  mode_base_started: base_slide
  
  # Handle skillshot videos in base mode so they continue after skillshot mode ends
  show_skillshot_mig_video:
    skillshot_mig_hit:
      action: play
      expire: 3.5s  # Auto-remove after 5 seconds
  show_skillshot_miramar_video:
    skillshot_miramar:
      action: play
      expire: 3.5s  # Auto-remove after 5 seconds
  show_skillshot_tower_video:
    skillshot_tower:
      action: play
      expire: 5s  # Auto-remove after 5 seconds
  show_skillshot_inverted_video:
    skillshot_inverted:
      action: play
      expire: 8s  # Auto-remove after 5 seconds

sound_player:
  # Start base music when playfield becomes active (not during any special mode)
  # Uses player variables instead of checking each mode individually:
  # - pilot_mode_active: Set to 1 when any pilot mission is running
  # - training_mission_active: Set to 1 when any training mission is running
  # - hard_deck_active: Set to 1 when any hard deck mode is running
  # - multiball_active: Set to 1 when any multiball is running
  # Add additional variables as needed for future mode types
  playfield_active{current_player.pilot_mode_active==0 and current_player.training_mission_active==0 and current_player.hard_deck_active==0 and current_player.multiball_active==0}:
    music_danger_zone:
      bus: music
      loops: -1
  
  # Restart base music after bonus mode completes
  mode_bonus_stopped:
    music_danger_zone:
      bus: music
      loops: -1

#################################################################################### 
  # CRITICAL: Mode Scoop Silence - Works for BOTH rescue_cougar AND rise_of_phoenix
  # NO CONDITIONAL - This plays silence whenever ball enters mode scoop
  # EXCEPTION: battle_jester step 6 - music keeps playing during that scoop entry
####################################################################################

  # Silence for all modes EXCEPT battle_jester step 6
  s_mode_start_active{mode.battle_jester.active==False or current_player.battle_jester_step!=5}:
    silence:
      bus: music
      loops: 0

#################################################################################### 
  # Rescue Cougar Mode Music Handler
####################################################################################
  
  balldevice_bd_mode_scoop_ball_eject_success{mode.rescue_cougar.active==True}:
    music_rescue_cougar_1:
      bus: music
      loops: -1
  
  # Step 6 - force stop music_1 by playing silence briefly, then music_2
  rescue_cougar_step_7_complete:
    silence:
      bus: music
      loops: 0
  
  rescue_cougar_setup_step_8:
    music_rescue_cougar_2:
      bus: music
      loops: -1
  
  mode_rescue_cougar_stopped:
    music_danger_zone:
      bus: music
      loops: -1

#################################################################################### 
  # Rise of Phoenix Mode Music Handler
####################################################################################

  # When ball ejects from scoop (after intro video), start Phoenix music
  balldevice_bd_mode_scoop_ball_eject_success{mode.rise_of_phoenix.active==True}:
    rise_of_phoenix_music:
      bus: music
      loops: -1
  
  mode_rise_of_phoenix_stopped:
    music_danger_zone:
      bus: music
      loops: -1

#################################################################################### 
  # Battle Jester Mode Music Handler
####################################################################################

  # Start music when ball is released from scoop (after intro video or step 6 video)
  battle_jester_ball_released:
    battle_jester_music:
      bus: music
      loops: -1
  
  # Silence music during step 11 decision (Risk points? YES/NO)
  battle_jester_step_11_complete:
    silence:
      bus: music
      loops: 0
  
  # If player chooses NO - music stays silent, won video plays, mode ends
  # (mode_battle_jester_stopped handles restarting danger_zone)
  
  # If player chooses YES - restart mode music for tower challenge
  battle_jester_choice_yes:
    battle_jester_music:
      bus: music
      loops: -1
  
  # Silence music when lost/won videos play (before mode stops)
  battle_jester_failed:
    silence:
      bus: music
      loops: 0
  
  battle_jester_complete:
    silence:
      bus: music
      loops: 0
  
  battle_jester_tower_won:
    silence:
      bus: music
      loops: 0
  
  battle_jester_tower_lost:
    silence:
      bus: music
      loops: 0
  
  # Restart base music when battle_jester mode stops
  # This handles both won (where bonus doesn't run) and lost scenarios
  mode_battle_jester_stopped:
    music_danger_zone:
      bus: music
      loops: -1

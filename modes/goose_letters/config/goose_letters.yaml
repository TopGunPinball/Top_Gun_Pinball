#config_version=6

##
## GOOSE Letters Mode - Pure YAML
## Lights letters via lane switches, rotates via flipper buttons
## Progressive completion tracking with mystery awards and eject mode qualification
##
## GODOT SLIDE SETUP:
## - ejection_shots_completed: Variable Type = player_var, Variable Name = ejection_shots_completed
## - ejection_shots_needed: Variable Type = player_var, Variable Name = ejection_shots_needed
## - ejection_seat_active: No variable needed (static slide)
##

mode:
  start_events: mode_base_started
  stop_events: mode_base_stopped
  priority: 210
  game_mode: true

##############################################
## Player Variables - Track Progress
##############################################

variable_player:
  # Initialize persistent tracking variables when mode starts
  # These will be set to their starting values when the mode first starts
  mode_goose_letters_started:
    # Only initialize on first mode start - check if completions is 0
    ejection_shots_completed{current_player.goose_completions==0}:
      action: set
      int: 0
    ejection_shots_needed{current_player.goose_completions==0}:
      action: set
      int: 3
    goose_milestone{current_player.goose_completions==0}:
      action: set
      int: 3

  player_added:
    # Individual letter states (0=off, 1=lit) - reset each ball
    goose_letter_g:
      action: set
      int: 0
    goose_letter_o_left:
      action: set
      int: 0
    goose_letter_e:
      action: set
      int: 0
    goose_letter_o_right:
      action: set
      int: 0
    goose_letter_s:
      action: set
      int: 0
    # Total GOOSE completions - persists across balls
    goose_completions:
      action: set
      int: 0
    # Eject mode qualified flag - persists across balls
    eject_mode_qualified:
      action: set
      int: 0
    # Flag to block lane hits during completion
    goose_completing:
      action: set
      int: 0
    # Track which letter was last collected (1=G, 2=O_left, 3=E, 4=O_right, 5=S)
    goose_last_letter_collected:
      action: set
      int: 0

  ##############################################
  ## Light Letters When Lane Switches Hit
  ##############################################

  # G - Left outlane (goose_last_letter_collected = 1)
  s_outlane_left_active{current_player.goose_letter_g==0 and current_player.goose_completing==0}:
    goose_letter_g:
      action: set
      int: 1
    goose_last_letter_collected:
      action: set
      int: 1

  # Left O - Left inlane (goose_last_letter_collected = 2)
  s_inlane_left_active{current_player.goose_letter_o_left==0 and current_player.goose_completing==0}:
    goose_letter_o_left:
      action: set
      int: 1
    goose_last_letter_collected:
      action: set
      int: 2

  # E - Right outlane (goose_last_letter_collected = 3)
  s_outlane_right_active{current_player.goose_letter_e==0 and current_player.goose_completing==0}:
    goose_letter_e:
      action: set
      int: 1
    goose_last_letter_collected:
      action: set
      int: 3

  # Right O - Inner right inlane (goose_last_letter_collected = 4)
  s_inner_inlane_right_active{current_player.goose_letter_o_right==0 and current_player.goose_completing==0}:
    goose_letter_o_right:
      action: set
      int: 1
    goose_last_letter_collected:
      action: set
      int: 4

  # S - Outer right inlane (goose_last_letter_collected = 5)
  s_outer_inlane_right_active{current_player.goose_letter_s==0 and current_player.goose_completing==0}:
    goose_letter_s:
      action: set
      int: 1
    goose_last_letter_collected:
      action: set
      int: 5

  ##############################################
  ## Completion Tracking - Increment completed counter
  ##############################################

  goose_complete:
    goose_completing:
      action: set
      int: 1
    goose_completions:
      action: add
      int: 1
    ejection_shots_completed:
      action: add
      int: 1
    score:
      action: add
      int: 48000 * current_player.total_scoring_multiplier
      block: true

  # Reset letters after short delay
  goose_reset_letters:
    goose_letter_g:
      action: set
      int: 0
    goose_letter_o_left:
      action: set
      int: 0
    goose_letter_e:
      action: set
      int: 0
    goose_letter_o_right:
      action: set
      int: 0
    goose_letter_s:
      action: set
      int: 0
    goose_completing:
      action: set
      int: 0

  ##############################################
  ## Save current letter states before rotation
  ##############################################
  
  s_flipper_left_active:
    goose_temp_g:
      action: set
      int: current_player.goose_letter_g
    goose_temp_o_left:
      action: set
      int: current_player.goose_letter_o_left
    goose_temp_e:
      action: set
      int: current_player.goose_letter_e
    goose_temp_o_right:
      action: set
      int: current_player.goose_letter_o_right
    goose_temp_s:
      action: set
      int: current_player.goose_letter_s

  s_flipper_right_active:
    goose_temp_g:
      action: set
      int: current_player.goose_letter_g
    goose_temp_o_left:
      action: set
      int: current_player.goose_letter_o_left
    goose_temp_e:
      action: set
      int: current_player.goose_letter_e
    goose_temp_o_right:
      action: set
      int: current_player.goose_letter_o_right
    goose_temp_s:
      action: set
      int: current_player.goose_letter_s

  ##############################################
  ## LEFT FLIPPER ROTATIONS - Clockwise
  ##############################################

  goose_rotate_left_execute:
    goose_letter_g:
      action: set
      int: current_player.goose_temp_o_left
    goose_letter_o_left:
      action: set
      int: current_player.goose_temp_o_right
    goose_letter_o_right:
      action: set
      int: current_player.goose_temp_s
    goose_letter_s:
      action: set
      int: current_player.goose_temp_e
    goose_letter_e:
      action: set
      int: current_player.goose_temp_g

  ##############################################
  ## RIGHT FLIPPER ROTATIONS - Counterclockwise
  ##############################################

  goose_rotate_right_execute:
    goose_letter_g:
      action: set
      int: current_player.goose_temp_e
    goose_letter_e:
      action: set
      int: current_player.goose_temp_s
    goose_letter_s:
      action: set
      int: current_player.goose_temp_o_right
    goose_letter_o_right:
      action: set
      int: current_player.goose_temp_o_left
    goose_letter_o_left:
      action: set
      int: current_player.goose_temp_g

  ##############################################
  ## Progressive Milestones
  ##############################################

  # 3 completions - Qualify eject mode
  goose_milestone_3:
    eject_mode_qualified:
      action: set
      int: 1
    goose_milestone:
      action: set
      int: 5
    ejection_shots_needed:
      action: set
      int: 5

  # 5 completions - Light mystery
  goose_milestone_5:
    goose_milestone:
      action: set
      int: 10
    ejection_shots_needed:
      action: set
      int: 10

  # 10 completions - Qualify eject or mystery
  goose_milestone_10_eject:
    eject_mode_qualified:
      action: set
      int: 1
    goose_milestone:
      action: set
      int: 15
    ejection_shots_needed:
      action: set
      int: 15

  goose_milestone_10_mystery:
    goose_milestone:
      action: set
      int: 15
    ejection_shots_needed:
      action: set
      int: 15

  # 15 completions - Light mystery
  goose_milestone_15:
    goose_milestone:
      action: set
      int: 20
    ejection_shots_needed:
      action: set
      int: 20

  # 20 completions - Light extra ball and qualify eject (or mystery if already qualified)
  goose_milestone_20_eject:
    eject_mode_qualified:
      action: set
      int: 1
    goose_milestone:
      action: set
      int: 30
    ejection_shots_needed:
      action: set
      int: 30

  goose_milestone_20_mystery:
    goose_milestone:
      action: set
      int: 30
    ejection_shots_needed:
      action: set
      int: 30

  # 30 completions - Light goose mode
  goose_milestone_30:
    goose_milestone:
      action: set
      int: 50
    ejection_shots_needed:
      action: set
      int: 50

  # 50 completions - Qualify eject or mystery
  goose_milestone_50_eject:
    eject_mode_qualified:
      action: set
      int: 1
    goose_milestone:
      action: set
      int: 100
    ejection_shots_needed:
      action: set
      int: 100

  goose_milestone_50_mystery:
    goose_milestone:
      action: set
      int: 100
    ejection_shots_needed:
      action: set
      int: 100

  # 100 completions - Qualify eject or mystery
  goose_milestone_100_eject:
    eject_mode_qualified:
      action: set
      int: 1

  ##############################################
  ## Clear eject qualification when mode starts
  ##############################################

  mode_ejection_seat_started:
    eject_mode_qualified:
      action: set
      int: 0

  ##############################################
  ## Reset Letter Progress on Ball End
  ##############################################

  ball_ending:
    goose_letter_g:
      action: set
      int: 0
    goose_letter_o_left:
      action: set
      int: 0
    goose_letter_e:
      action: set
      int: 0
    goose_letter_o_right:
      action: set
      int: 0
    goose_letter_s:
      action: set
      int: 0
    goose_completing:
      action: set
      int: 0

##############################################
## Timers
##############################################

timers:
  goose_reset:
    start_value: 0
    end_value: 1
    tick_interval: 500ms
    direction: up
    control_events:
      - event: goose_complete
        action: restart

##############################################
## Event Player - Check Completion
##############################################

event_player:
  # Timer completion triggers the reset
  timer_goose_reset_complete:
    goose_reset_letters

  # Flipper rotations
  s_flipper_left_active{current_player.goose_completing==0}:
    goose_rotate_left_execute
  
  s_flipper_right_active{current_player.goose_completing==0}:
    goose_rotate_right_execute

  ##############################################
  ## Ejection Seat Mode Trigger
  ##############################################
  # Start ejection seat mode when qualified and ball enters left outlane
  s_outlane_left_active{current_player.eject_mode_qualified==1}:
    - start_mode_ejection_seat

  # Also start ejection seat if G was the letter that completed GOOSE and qualified eject
  # (The ball is already in the outlane, so we need to start immediately)
  eject_mode_qualified_event{current_player.goose_last_letter_collected==1}:
    - start_mode_ejection_seat

  # Check if GOOSE is complete after each lane hit
  s_outlane_left_active{current_player.goose_letter_g==0 and current_player.goose_completing==0}: check_goose_complete
  s_inlane_left_active{current_player.goose_letter_o_left==0 and current_player.goose_completing==0}: check_goose_complete
  s_outlane_right_active{current_player.goose_letter_e==0 and current_player.goose_completing==0}: check_goose_complete
  s_inner_inlane_right_active{current_player.goose_letter_o_right==0 and current_player.goose_completing==0}: check_goose_complete
  s_outer_inlane_right_active{current_player.goose_letter_s==0 and current_player.goose_completing==0}: check_goose_complete

  # Post completion event if all letters are lit
  check_goose_complete{current_player.goose_letter_g==1 and current_player.goose_letter_o_left==1 and current_player.goose_letter_e==1 and current_player.goose_letter_o_right==1 and current_player.goose_letter_s==1}:
    goose_complete:
      priority: 100

  ##############################################
  ## Milestone Events - Check total completion count
  ##############################################

  # When completions reach milestone, trigger award
  player_goose_completions{value==3}:
    - eject_mode_qualified_event
    - goose_milestone_3

  player_goose_completions{value==5}:
    - light_mystery_award
    - goose_milestone_5

  player_goose_completions{value==10 and current_player.eject_mode_qualified==0}:
    - eject_mode_qualified_event
    - goose_milestone_10_eject

  player_goose_completions{value==10 and current_player.eject_mode_qualified==1}:
    - light_mystery_award
    - goose_milestone_10_mystery

  player_goose_completions{value==15}:
    - light_mystery_award
    - goose_milestone_15

  player_goose_completions{value==20 and current_player.eject_mode_qualified==0}:
    - eject_mode_qualified_event
    - light_extra_ball
    - goose_milestone_20_eject

  player_goose_completions{value==20 and current_player.eject_mode_qualified==1}:
    - light_mystery_award
    - light_extra_ball
    - goose_milestone_20_mystery

  player_goose_completions{value==30}:
    - light_goose_mode
    - goose_milestone_30

  player_goose_completions{value==50 and current_player.eject_mode_qualified==0}:
    - eject_mode_qualified_event
    - goose_milestone_50_eject

  player_goose_completions{value==50 and current_player.eject_mode_qualified==1}:
    - light_mystery_award
    - goose_milestone_50_mystery

  player_goose_completions{value==100 and current_player.eject_mode_qualified==0}:
    - eject_mode_qualified_event
    - goose_milestone_100_eject

  player_goose_completions{value==100 and current_player.eject_mode_qualified==1}:
    - light_mystery_award

##############################################
## Random Event Player - Randomize GOOSE Collected Slides
##############################################

random_event_player:
  # Only play goose collected slides when NOT qualifying eject or extra ball
  # Check if the CURRENT count + 1 (after this completion) will be a milestone
  # So we check if current count is NOT 2, 9, 19, 49, or 99 (one before milestones)
  goose_complete{current_player.goose_completions!=2 and current_player.goose_completions!=9 and current_player.goose_completions!=19 and current_player.goose_completions!=49 and current_player.goose_completions!=99}:
    events:
      - goose_collected_slide_01
      - goose_collected_slide_02
      - goose_collected_slide_03
      - goose_collected_slide_04
      - goose_collected_slide_05

##############################################
## Slide Player - Progress Tracking & Videos
##############################################

slide_player:
  # Show progress slides when mode starts (if not qualified)
  mode_goose_letters_started{current_player.eject_mode_qualified==0}:
    ejection_shots_completed:
      action: play
      priority: 210
    ejection_shots_needed:
      action: play
      priority: 210

  # Show qualified slide when mode starts (if qualified)
  mode_goose_letters_started{current_player.eject_mode_qualified==1}:
    ejection_seat_active:
      action: play
      priority: 210

  # When eject mode qualifies, remove progress slides and show active slide
  # EXCEPTION: If G was the qualifying letter (goose_last_letter_collected==1),
  # skip the qualified scene since ejection seat mode starts immediately
  eject_mode_qualified_event{current_player.goose_last_letter_collected!=1}:
    ejection_shots_completed:
      action: remove
    ejection_shots_needed:
      action: remove
    ejection_seat_active:
      action: play
      priority: 210
    ejection_seat_qualified:
      action: play
      priority: 220

  # When G qualifies eject, just remove progress slides (mode starts immediately)
  eject_mode_qualified_event{current_player.goose_last_letter_collected==1}:
    ejection_shots_completed:
      action: remove
    ejection_shots_needed:
      action: remove

  # When eject mode starts, remove active slide and restore progress tracking
  mode_ejection_seat_started:
    ejection_seat_active:
      action: remove
    ejection_shots_completed:
      action: play
      priority: 210
    ejection_shots_needed:
      action: play
      priority: 210

  # Clean up on mode stop
  mode_goose_letters_stopped:
    ejection_shots_completed:
      action: remove
    ejection_shots_needed:
      action: remove
    ejection_seat_active:
      action: remove
  
  # Play one of 5 randomized slides when GOOSE is collected
  goose_collected_slide_01:
    goose_collected_01:
      action: play
      priority: 230
  
  goose_collected_slide_02:
    goose_collected_02:
      action: play
      priority: 230
  
  goose_collected_slide_03:
    goose_collected_03:
      action: play
      priority: 230
  
  goose_collected_slide_04:
    goose_collected_04:
      action: play
      priority: 230
  
  goose_collected_slide_05:
    goose_collected_05:
      action: play
      priority: 230
  
  # Play extra ball video when extra ball is lit
  light_extra_ball:
    extra_ball_lit_video:
      action: play
      priority: 240

##############################################
## Light Player - GOOSE Letters & Awards
##############################################

light_player:
  # Turn off all lights when mode starts
  mode_goose_letters_started:
    l_goose_g:
      color: off
    l_goose_o_left:
      color: off
    l_goose_e:
      color: off
    l_goose_o_right:
      color: off
    l_goose_s:
      color: off

  ##############################################
  ## Light Letters on Lane Hit
  ##############################################

  s_outlane_left_active{current_player.goose_letter_g==0 and current_player.goose_completing==0}:
    l_goose_g:
      color: white
      fade: 0ms

  s_inlane_left_active{current_player.goose_letter_o_left==0 and current_player.goose_completing==0}:
    l_goose_o_left:
      color: white
      fade: 0ms

  s_outlane_right_active{current_player.goose_letter_e==0 and current_player.goose_completing==0}:
    l_goose_e:
      color: white
      fade: 0ms

  s_inner_inlane_right_active{current_player.goose_letter_o_right==0 and current_player.goose_completing==0}:
    l_goose_o_right:
      color: white
      fade: 0ms

  s_outer_inlane_right_active{current_player.goose_letter_s==0 and current_player.goose_completing==0}:
    l_goose_s:
      color: white
      fade: 0ms

  ##############################################
  ## Update Lights Based on Player Variables
  ##############################################

  player_goose_letter_g{value==1}:
    l_goose_g:
      color: white

  player_goose_letter_g{value==0}:
    l_goose_g:
      color: off

  player_goose_letter_o_left{value==1}:
    l_goose_o_left:
      color: white

  player_goose_letter_o_left{value==0}:
    l_goose_o_left:
      color: off

  player_goose_letter_e{value==1}:
    l_goose_e:
      color: white

  player_goose_letter_e{value==0}:
    l_goose_e:
      color: off

  player_goose_letter_o_right{value==1}:
    l_goose_o_right:
      color: white

  player_goose_letter_o_right{value==0}:
    l_goose_o_right:
      color: off

  player_goose_letter_s{value==1}:
    l_goose_s:
      color: white

  player_goose_letter_s{value==0}:
    l_goose_s:
      color: off

  ##############################################
  ## Eject Light Control
  ##############################################

  # Light eject when qualified (solid white)
  eject_mode_qualified_event:
    l_eject:
      color: yellow
      fade: 0ms

  # Turn off eject light when mode starts
  mode_ejection_seat_started:
    l_eject:
      color: off

  # Restore eject light on ball start if already qualified
  mode_goose_letters_started{current_player.eject_mode_qualified==1}:
    l_eject:
      color: yellow
      fade: 0ms

  ##############################################
  ## Mystery Award Light - Purple Pulse
  ##############################################

  light_mystery_award:
    l_mystery_lit:
      color: cyan
      fade: 0ms
  
  light_extra_ball:
    l_extra_ball_lit:
      color: orange
      fade: 0ms

##############################################
## Coil Player - Barrier Control
##############################################

coil_player:
  # Drop and hold barrier when mystery is lit
  light_mystery_award:
    c_mode_barrier:
      action: pulse
      hold_power: 1.0
  
  # Release barrier when mystery is collected or disabled
  # (Add your specific event here for when to release, e.g., mystery_collected)
  # mystery_collected:
  #   c_mode_barrier:
  #     action: disable

##############################################
## Show Player - Purple Pulse for Mystery
##############################################

show_player:
  # Removed pulse show - mystery light now stays solid via light_player

  # Play Goose collect show when GOOSE collected
  goose_complete:
    goose_collected:
      loops: 0
      speed: 40
      sync_ms: true

shows:
  pulse_purple:
    - duration: 0.5s
      lights:
        (led): (color)
    - duration: 0.5s
      lights:
        (led): off

##############################################
## Sound Player (Optional)
##############################################

# sound_player:
#   s_outlane_left_active{current_player.goose_letter_g==0}:
#     sfx_goose_letter:
#       action: play
#   s_inlane_left_active{current_player.goose_letter_o_left==0}:
#     sfx_goose_letter:
#       action: play
#   s_outlane_right_active{current_player.goose_letter_e==0}:
#     sfx_goose_letter:
#       action: play
#   s_inner_inlane_right_active{current_player.goose_letter_o_right==0}:
#     sfx_goose_letter:
#       action: play
#   s_outer_inlane_right_active{current_player.goose_letter_s==0}:
#     sfx_goose_letter:
#       action: play
#   
#   goose_complete:
#     sfx_goose_complete:
#       action: play
#   
#   eject_mode_qualified_event:
#     sfx_eject_qualified:
#       action: play
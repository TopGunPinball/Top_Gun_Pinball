#config_version=6

##
## ICEMAN Letters Mode - Pure YAML
## Lights letters via standup targets to qualify pilot training missions
## Cycles qualified missions with pop bumpers
## Persists progress across balls
##

mode:
  start_events: mode_base_started
  stop_events: mode_base_stopped
  priority: 200
  game_mode: true

##############################################
## Player Variables - Track Progress
##############################################

variable_player:
  player_added:
    # Individual ICEMAN letter states (0=off, 1=lit)
    iceman_letter_i:
      action: set
      int: 0
    iceman_letter_c:
      action: set
      int: 0
    iceman_letter_e:
      action: set
      int: 0
    iceman_letter_m:
      action: set
      int: 0
    iceman_letter_a:
      action: set
      int: 0
    iceman_letter_n:
      action: set
      int: 0
    # Flag to block target hits during completion
    iceman_completing:
      action: set
      int: 0
    # Which training mission is qualified (0=none, 1-5=mission number)
    training_mission_qualified:
      action: set
      int: 0
    # Track which training missions are complete (0 or 1)
    training_inverted_complete:
      action: set
      int: 0
    training_missles_complete:
      action: set
      int: 0
    training_afterburner_complete:
      action: set
      int: 0
    training_wingman_complete:
      action: set
      int: 0
    training_dogfight_complete:
      action: set
      int: 0
    # MIG post lockout tracking
    right_post_locked_out:
      action: set
      int: 0

  ##############################################
  ## Light Letters When Standup Targets Hit
  ##############################################

  # I target
  s_i_iceman_target_active{current_player.iceman_letter_i==0 and current_player.iceman_completing==0 and current_player.letter_collection_paused==0}:
    iceman_letter_i:
      action: set
      int: 1

  # C target
  s_c_iceman_target_active{current_player.iceman_letter_c==0 and current_player.iceman_completing==0 and current_player.letter_collection_paused==0}:
    iceman_letter_c:
      action: set
      int: 1

  # E target
  s_e_iceman_target_active{current_player.iceman_letter_e==0 and current_player.iceman_completing==0 and current_player.letter_collection_paused==0}:
    iceman_letter_e:
      action: set
      int: 1

  # M target
  s_m_iceman_target_active{current_player.iceman_letter_m==0 and current_player.iceman_completing==0 and current_player.letter_collection_paused==0}:
    iceman_letter_m:
      action: set
      int: 1

  # A target
  s_a_iceman_target_active{current_player.iceman_letter_a==0 and current_player.iceman_completing==0 and current_player.letter_collection_paused==0}:
    iceman_letter_a:
      action: set
      int: 1

  # N target
  s_n_iceman_target_active{current_player.iceman_letter_n==0 and current_player.iceman_completing==0 and current_player.letter_collection_paused==0}:
    iceman_letter_n:
      action: set
      int: 1

  ##############################################
  ## Qualify Training Missions on ICEMAN Complete
  ## Only qualify if no mission is currently qualified
  ##############################################

  # Default: qualify mission 1 (Inverted) if nothing qualified yet
  qualify_training_mission:
    training_mission_qualified:
      action: set
      int: 1

  # Override based on what's been completed
  # Mission 2 if mission 1 is complete
  qualify_training_mission{current_player.training_inverted_complete==1 and current_player.training_missles_complete==0}:
    training_mission_qualified:
      action: set
      int: 2

  # Mission 3 if missions 1-2 are complete
  qualify_training_mission{current_player.training_inverted_complete==1 and current_player.training_missles_complete==1 and current_player.training_afterburner_complete==0}:
    training_mission_qualified:
      action: set
      int: 3

  # Mission 4 if missions 1-3 are complete
  qualify_training_mission{current_player.training_inverted_complete==1 and current_player.training_missles_complete==1 and current_player.training_afterburner_complete==1 and current_player.training_wingman_complete==0}:
    training_mission_qualified:
      action: set
      int: 4

  # Mission 5 (Dogfight) if missions 1-4 are all complete
  qualify_training_mission{current_player.training_inverted_complete==1 and current_player.training_missles_complete==1 and current_player.training_afterburner_complete==1 and current_player.training_wingman_complete==1 and current_player.training_dogfight_complete==0}:
    training_mission_qualified:
      action: set
      int: 5

  ##############################################
  ## Handle ICEMAN Completion
  ##############################################

  iceman_complete:
    iceman_completing:
      action: set
      int: 1
    iceman_total_completions:
      action: add
      int: 1
    score:
      action: add
      int: 73000 * current_player.total_scoring_multiplier
      block: true

  ##############################################
  ## Reset Letters After Completion
  ##############################################

  iceman_reset_letters:
    iceman_letter_i:
      action: set
      int: 0
    iceman_letter_c:
      action: set
      int: 0
    iceman_letter_e:
      action: set
      int: 0
    iceman_letter_m:
      action: set
      int: 0
    iceman_letter_a:
      action: set
      int: 0
    iceman_letter_n:
      action: set
      int: 0
    iceman_completing:
      action: set
      int: 0

  ##############################################
  ## Clear Qualified Mission When Started
  ##############################################

  mode_pilot_training_mission_inverted_started:
    training_mission_qualified:
      action: set
      int: 0

  mode_pilot_training_mission_missiles_started:
    training_mission_qualified:
      action: set
      int: 0

  mode_pilot_training_mission_afterburner_started:
    training_mission_qualified:
      action: set
      int: 0

  mode_pilot_training_mission_wingman_started:
    training_mission_qualified:
      action: set
      int: 0

  mode_training_dogfight_started:
    training_mission_qualified:
      action: set
      int: 0

  ##############################################
  ## Rotate Qualified Mission on Pop Bumper Hits
  ##############################################

  # Rotate mission forward: 1->2->3->4->5 via bumpers
  # When value reaches 5, wrap_mission_to_one handlers (below) wrap back to 1
  # Using <5 instead of <4 so value==4 (wingman) persists until next bumper hit
  s_bumper_left_active{current_player.training_mission_qualified>0 and current_player.training_mission_qualified<5 and current_player.training_mission_active==0}:
    training_mission_qualified:
      action: add
      int: 1

  s_bumper_center_active{current_player.training_mission_qualified>0 and current_player.training_mission_qualified<5 and current_player.training_mission_active==0}:
    training_mission_qualified:
      action: add
      int: 1

  s_bumper_right_active{current_player.training_mission_qualified>0 and current_player.training_mission_qualified<5 and current_player.training_mission_active==0}:
    training_mission_qualified:
      action: add
      int: 1

  # Wrap mission value back to 1 if missions 1-4 aren't complete
  wrap_mission_to_one:
    training_mission_qualified:
      action: set
      int: 1

  ##############################################
  ## MIG Post Lockout Logic
  ##############################################

  # Set lockout flag when ball comes from right side
  s_orbit_right_active:
    right_post_locked_out:
      action: set
      int: 1

  s_ramp_inner_exit_active:
    right_post_locked_out:
      action: set
      int: 1

  s_orbit_upper_active:
    right_post_locked_out:
      action: set
      int: 1

  s_spinner_active:
    right_post_locked_out:
      action: set
      int: 1

  # Clear lockout when timer expires
  timer_right_orbit_lockout_timer_complete:
    right_post_locked_out:
      action: set
      int: 0

  ##############################################
  ## INVERTED PERK: Set inverted_perk_active on mode win
  ## training_inverted_mode_over fires 500ms after mode stops
  ## Only sets perk if training mission was won
  ##############################################
  training_inverted_mode_over{current_player.training_mission_inverted_perk_active==1}:
    inverted_perk_active:
      action: set
      int: 1

  ##############################################
  ## INVERTED PERK: Double ICEMAN Letters
  ## Awards the next uncollected letter in I→C→E→M→A→N chain
  ## Each target that sets a letter also triggers the bonus chain
  ##############################################
  inverted_award_iceman_i:
    iceman_letter_i:
      action: set
      int: 1
  inverted_award_iceman_c:
    iceman_letter_c:
      action: set
      int: 1
  inverted_award_iceman_e:
    iceman_letter_e:
      action: set
      int: 1
  inverted_award_iceman_m:
    iceman_letter_m:
      action: set
      int: 1
  inverted_award_iceman_a:
    iceman_letter_a:
      action: set
      int: 1
  inverted_award_iceman_n:
    iceman_letter_n:
      action: set
      int: 1

##############################################
## Timers
##############################################

timers:
  iceman_reset:
    start_value: 0
    end_value: 1
    tick_interval: 500ms
    direction: up
    control_events:
      - event: iceman_complete
        action: restart
  
  # Left MIG post - holds for 2 seconds after spinner hit
  left_mig_post_timer:
    start_value: 0
    end_value: 2000  # 2000ms = 2 seconds (adjust as needed during testing)
    direction: up
    tick_interval: 100ms
    start_running: false
  
  # Right MIG post - holds for 2 seconds after left orbit hit
  right_mig_post_timer:
    start_value: 0
    end_value: 2000  # 2000ms = 2 seconds (adjust as needed during testing)
    direction: up
    tick_interval: 100ms
    start_running: false
  
  # Lockout timer - prevents right post activation if ball came from right side
  right_orbit_lockout_timer:
    start_value: 0
    end_value: 3000  # 3 seconds lockout
    direction: up
    tick_interval: 100ms
    start_running: false

##############################################
## Event Player - Check for Completion & Handle Logic
##############################################

event_player:
  ##############################################
  ## Training Mode Insert Light + Perk Slide (Delayed to Survive Clear)
  ##############################################

  # Fire delayed event to set insert light and show perk slide after mode stops
  # MUST be delayed 500ms to survive the 'clear' event that fires right after mode_stopped
  mode_pilot_training_mission_inverted_stopped:
    - training_inverted_mode_over|500ms

  mode_pilot_training_mission_missiles_stopped:
    - training_missiles_mode_over|500ms

  mode_pilot_training_mission_afterburner_stopped:
    - training_afterburner_mode_over|500ms

  mode_pilot_training_mission_wingman_stopped:
    - training_wingman_mode_over|500ms

  ##############################################
  ## INVERTED PERK: Double ICEMAN Letters
  ## When inverted_perk_active==1, each ICEMAN target hit also awards
  ## the next uncollected letter in I→C→E→M→A→N order
  ##############################################
  
  # Each target hit triggers the bonus chain (same conditions as normal collection)
  s_i_iceman_target_active{current_player.iceman_letter_i==0 and current_player.iceman_completing==0 and current_player.letter_collection_paused==0 and current_player.inverted_perk_active==1}:
    - inverted_bonus_iceman_letter
  s_c_iceman_target_active{current_player.iceman_letter_c==0 and current_player.iceman_completing==0 and current_player.letter_collection_paused==0 and current_player.inverted_perk_active==1}:
    - inverted_bonus_iceman_letter
  s_e_iceman_target_active{current_player.iceman_letter_e==0 and current_player.iceman_completing==0 and current_player.letter_collection_paused==0 and current_player.inverted_perk_active==1}:
    - inverted_bonus_iceman_letter
  s_m_iceman_target_active{current_player.iceman_letter_m==0 and current_player.iceman_completing==0 and current_player.letter_collection_paused==0 and current_player.inverted_perk_active==1}:
    - inverted_bonus_iceman_letter
  s_a_iceman_target_active{current_player.iceman_letter_a==0 and current_player.iceman_completing==0 and current_player.letter_collection_paused==0 and current_player.inverted_perk_active==1}:
    - inverted_bonus_iceman_letter
  s_n_iceman_target_active{current_player.iceman_letter_n==0 and current_player.iceman_completing==0 and current_player.letter_collection_paused==0 and current_player.inverted_perk_active==1}:
    - inverted_bonus_iceman_letter

  # Chain logic: award first uncollected letter in I→C→E→M→A→N order
  inverted_bonus_iceman_letter{current_player.iceman_letter_i==0}:
    - inverted_award_iceman_i
  inverted_bonus_iceman_letter{current_player.iceman_letter_i==1 and current_player.iceman_letter_c==0}:
    - inverted_award_iceman_c
  inverted_bonus_iceman_letter{current_player.iceman_letter_i==1 and current_player.iceman_letter_c==1 and current_player.iceman_letter_e==0}:
    - inverted_award_iceman_e
  inverted_bonus_iceman_letter{current_player.iceman_letter_i==1 and current_player.iceman_letter_c==1 and current_player.iceman_letter_e==1 and current_player.iceman_letter_m==0}:
    - inverted_award_iceman_m
  inverted_bonus_iceman_letter{current_player.iceman_letter_i==1 and current_player.iceman_letter_c==1 and current_player.iceman_letter_e==1 and current_player.iceman_letter_m==1 and current_player.iceman_letter_a==0}:
    - inverted_award_iceman_a
  inverted_bonus_iceman_letter{current_player.iceman_letter_i==1 and current_player.iceman_letter_c==1 and current_player.iceman_letter_e==1 and current_player.iceman_letter_m==1 and current_player.iceman_letter_a==1 and current_player.iceman_letter_n==0}:
    - inverted_award_iceman_n

  # After each bonus award, check if ICEMAN is now complete
  inverted_award_iceman_i: check_ice_man_complete
  inverted_award_iceman_c: check_ice_man_complete
  inverted_award_iceman_e: check_ice_man_complete
  inverted_award_iceman_m: check_ice_man_complete
  inverted_award_iceman_a: check_ice_man_complete
  inverted_award_iceman_n: check_ice_man_complete

  ##############################################
  ## Start Training Missions via Left Lane
  ##############################################
  
  # Start Inverted training mission when left lane hit with mission 1 qualified
  # Only start if not already completed and no pilot mode active
  s_lane_left_active{current_player.training_mission_qualified==1 and current_player.training_inverted_complete==0 and current_player.pilot_mode_active==0 and current_player.hard_deck_qualified_mode==0}:
    - start_mode_pilot_training_mission_inverted
  
  # Start Missiles training mission when left lane hit with mission 2 qualified
  # Only start if not already completed and no pilot mode active
  s_lane_left_active{current_player.training_mission_qualified==2 and current_player.training_missles_complete==0 and current_player.pilot_mode_active==0 and current_player.hard_deck_qualified_mode==0}:
    - start_mode_pilot_training_mission_missiles
  
  # Start Afterburner training mission when left lane hit with mission 3 qualified
  # Only start if not already completed and no pilot mode active
  s_lane_left_active{current_player.training_mission_qualified==3 and current_player.training_afterburner_complete==0 and current_player.pilot_mode_active==0 and current_player.hard_deck_qualified_mode==0}:
    - start_mode_pilot_training_mission_afterburner
  
  # Start Wingman training mission when left lane hit with mission 4 qualified
  s_lane_left_active{current_player.training_mission_qualified==4 and current_player.training_wingman_complete==0 and current_player.pilot_mode_active==0 and current_player.hard_deck_qualified_mode==0}:
    - start_mode_training_wingman
  
  # Start Dogfight training mission when left lane hit with mission 5 qualified
  s_lane_left_active{current_player.training_mission_qualified==5 and current_player.pilot_mode_active==0 and current_player.hard_deck_qualified_mode==0}:
    - start_mode_training_dogfight

  # Timer completion triggers the reset
  timer_iceman_reset_complete:
    iceman_reset_letters

  # Check if ICE or MAN is complete after any letter lights
  s_i_iceman_target_active{current_player.iceman_letter_i==0 and current_player.iceman_completing==0}: check_ice_man_complete
  s_c_iceman_target_active{current_player.iceman_letter_c==0 and current_player.iceman_completing==0}: check_ice_man_complete
  s_e_iceman_target_active{current_player.iceman_letter_e==0 and current_player.iceman_completing==0}: check_ice_man_complete
  s_m_iceman_target_active{current_player.iceman_letter_m==0 and current_player.iceman_completing==0}: check_ice_man_complete
  s_a_iceman_target_active{current_player.iceman_letter_a==0 and current_player.iceman_completing==0}: check_ice_man_complete
  s_n_iceman_target_active{current_player.iceman_letter_n==0 and current_player.iceman_completing==0}: check_ice_man_complete

  # Post ICE complete if I-C-E are lit
  check_ice_man_complete{current_player.iceman_letter_i==1 and current_player.iceman_letter_c==1 and current_player.iceman_letter_e==1}:
    ice_complete:
      priority: 100

  # Post MAN complete if M-A-N are lit
  check_ice_man_complete{current_player.iceman_letter_m==1 and current_player.iceman_letter_a==1 and current_player.iceman_letter_n==1}:
    man_complete:
      priority: 100

  # Post ICEMAN complete if all 6 letters are lit
  check_ice_man_complete{current_player.iceman_letter_i==1 and current_player.iceman_letter_c==1 and current_player.iceman_letter_e==1 and current_player.iceman_letter_m==1 and current_player.iceman_letter_a==1 and current_player.iceman_letter_n==1}:
    iceman_complete:
      priority: 110

  # Qualify training mission ONLY if not already qualified (prevents double qualification)
  iceman_complete{current_player.training_mission_qualified==0}:
    qualify_training_mission

  # Restore qualified mission state on ball start
  mode_iceman_letters_started:
    - restore_training_mission_light

  # Wrap mission back to 1 if it somehow reaches 5 during rotation
  player_training_mission_qualified{value==5 and current_player.training_inverted_complete==0}:
    wrap_mission_to_one
  player_training_mission_qualified{value==5 and current_player.training_missles_complete==0}:
    wrap_mission_to_one
  player_training_mission_qualified{value==5 and current_player.training_afterburner_complete==0}:
    wrap_mission_to_one
  player_training_mission_qualified{value==5 and current_player.training_wingman_complete==0}:
    wrap_mission_to_one

  # Auto-skip completed missions during pop bumper rotation
  # If rotation lands on a completed mission, advance to next
  player_training_mission_qualified{value==1 and current_player.training_inverted_complete==1}:
    training_mission_qualified:
      action: set
      int: 2
  player_training_mission_qualified{value==2 and current_player.training_missles_complete==1}:
    training_mission_qualified:
      action: set
      int: 3
  player_training_mission_qualified{value==3 and current_player.training_afterburner_complete==1}:
    training_mission_qualified:
      action: set
      int: 4
  player_training_mission_qualified{value==4 and current_player.training_wingman_complete==1}:
    training_mission_qualified:
      action: set
      int: 5

  # Stop all pulse shows when any training mission starts
  mode_pilot_training_mission_inverted_started:
    stop_all_training_pulse_shows
  mode_pilot_training_mission_missiles_started:
    stop_all_training_pulse_shows
  mode_pilot_training_mission_afterburner_started:
    stop_all_training_pulse_shows
  mode_pilot_training_mission_wingman_started:
    stop_all_training_pulse_shows
  mode_training_dogfight_started:
    stop_all_training_pulse_shows

  ##############################################
  ## MIG Post Timer Control Events
  ##############################################

  # Start left post timer when spinner hit (if training qualified and no training mission running)
  s_spinner_active{current_player.training_mission_qualified>0 and current_player.training_mission_active==0}:
    - restart_left_mig_post_timer

  # Start right post timer when left orbit hit (if training qualified, NOT locked out, and no training mission running)
  s_orbit_left_active{current_player.training_mission_qualified>0 and current_player.right_post_locked_out==0 and current_player.training_mission_active==0}:
    - restart_right_mig_post_timer

  # Start lockout timer when right-side switches hit
  s_orbit_right_active:
    - restart_right_orbit_lockout_timer

  s_ramp_inner_exit_active:
    - restart_right_orbit_lockout_timer

  s_orbit_upper_active:
    - restart_right_orbit_lockout_timer

  # Custom events to restart timers
  restart_left_mig_post_timer:
    - timer_left_mig_post_timer_stop
    - timer_left_mig_post_timer_start

  restart_right_mig_post_timer:
    - timer_right_mig_post_timer_stop
    - timer_right_mig_post_timer_start

  restart_right_orbit_lockout_timer:
    - timer_right_orbit_lockout_timer_stop
    - timer_right_orbit_lockout_timer_start

##############################################
## Coil Player - Control Barrier Target & MIG Posts
##############################################

coil_player:
  # Training missions do NOT use the barrier - removed barrier pulse from qualification
  # Barrier is only used for pilot mission modes (rescue_cougar, etc.)

  # Safety: release barrier when training mission starts (ensure barrier is down)
  mode_pilot_training_mission_inverted_started:
    c_mode_barrier:
      action: off
  mode_pilot_training_mission_missiles_started:
    c_mode_barrier:
      action: off
  mode_pilot_training_mission_afterburner_started:
    c_mode_barrier:
      action: off
  mode_pilot_training_mission_wingman_started:
    c_mode_barrier:
      action: off
  mode_training_dogfight_started:
    c_mode_barrier:
      action: off

  ##############################################
  ## MIG Post Control
  ##############################################

  # LEFT MIG POST - Activate when spinner hit and training mission qualified (not during active training)
  s_spinner_active{current_player.training_mission_qualified>0 and current_player.training_mission_active==0}:
    c_left_mig_up_post:
      action: pulse
      hold_power: 0.125

  # Hold left post while timer is running
  timer_left_mig_post_timer_started:
    c_left_mig_up_post:
      action: enable
      hold_power: 0.125

  # Release left post when timer completes
  timer_left_mig_post_timer_complete:
    c_left_mig_up_post:
      action: disable

  # RIGHT MIG POST - Activate when left orbit hit, NOT locked out, training qualified, and not during active training
  s_orbit_left_active{current_player.training_mission_qualified>0 and current_player.right_post_locked_out==0 and current_player.training_mission_active==0}:
    c_right_mig_up_post:
      action: pulse
      hold_power: 0.125

  # Hold right post while timer is running
  timer_right_mig_post_timer_started:
    c_right_mig_up_post:
      action: enable
      hold_power: 0.125

  # Release right post when timer completes
  timer_right_mig_post_timer_complete:
    c_right_mig_up_post:
      action: disable

##############################################
## Show Player - Pulse Qualified Missions & Pop Bumpers
##############################################

show_player:
  # Stop all shows when mode stops
  mode_iceman_letters_stopped:
    iceman_inverted_pulse:
      action: stop
    iceman_missles_pulse:
      action: stop
    iceman_afterburner_pulse:
      action: stop
    iceman_wingman_pulse:
      action: stop
    iceman_dogfight_pulse:
      action: stop
    iceman_pop_bumpers_fade:
      action: stop

  # Stop all pulse shows before starting a new one
  stop_all_training_pulse_shows:
    iceman_inverted_pulse:
      action: stop
    iceman_missles_pulse:
      action: stop
    iceman_afterburner_pulse:
      action: stop
    iceman_wingman_pulse:
      action: stop
    iceman_dogfight_pulse:
      action: stop

  # Start pulsing and pop bumper fade when mission is qualified
  # Use the player variable change event to trigger shows AFTER variable is set
  # Stop all other pulse shows first, then start the correct one
  # CRITICAL: Only start iceman_inverted_pulse if mode hasn't been played yet
  player_training_mission_qualified{value==1 and current_player.training_inverted_complete==0}:
    iceman_missles_pulse:
      action: stop
    iceman_afterburner_pulse:
      action: stop
    iceman_wingman_pulse:
      action: stop
    iceman_dogfight_pulse:
      action: stop
    iceman_inverted_pulse:
      loops: -1
      speed: 1
      show_tokens:
        led: l_mode_inverted
        color: cyan
      key: iceman_inverted_pulse
    iceman_pop_bumpers_fade:
      loops: -1
      speed: 1
      key: iceman_pop_bumpers_fade

  player_training_mission_qualified{value==2 and current_player.training_missles_complete==0}:
    iceman_inverted_pulse:
      action: stop
    iceman_afterburner_pulse:
      action: stop
    iceman_wingman_pulse:
      action: stop
    iceman_dogfight_pulse:
      action: stop
    iceman_missles_pulse:
      loops: -1
      speed: 1
      show_tokens:
        led: l_mode_missles
        color: cyan
      key: iceman_missles_pulse
    iceman_pop_bumpers_fade:
      loops: -1
      speed: 1
      key: iceman_pop_bumpers_fade

  player_training_mission_qualified{value==3 and current_player.training_afterburner_complete==0}:
    iceman_inverted_pulse:
      action: stop
    iceman_missles_pulse:
      action: stop
    iceman_wingman_pulse:
      action: stop
    iceman_dogfight_pulse:
      action: stop
    iceman_afterburner_pulse:
      loops: -1
      speed: 1
      show_tokens:
        led: l_mode_afterburner
        color: cyan
      key: iceman_afterburner_pulse
    iceman_pop_bumpers_fade:
      loops: -1
      speed: 1
      key: iceman_pop_bumpers_fade

  player_training_mission_qualified{value==4 and current_player.training_wingman_complete==0}:
    iceman_inverted_pulse:
      action: stop
    iceman_missles_pulse:
      action: stop
    iceman_afterburner_pulse:
      action: stop
    iceman_dogfight_pulse:
      action: stop
    iceman_wingman_pulse:
      loops: -1
      speed: 1
      show_tokens:
        led: l_mode_wingman
        color: cyan
      key: iceman_wingman_pulse
    iceman_pop_bumpers_fade:
      loops: -1
      speed: 1
      key: iceman_pop_bumpers_fade

  # Dogfight - only show if ALL 4 standard missions are complete
  player_training_mission_qualified{value==5 and current_player.training_inverted_complete==1 and current_player.training_missles_complete==1 and current_player.training_afterburner_complete==1 and current_player.training_wingman_complete==1}:
    iceman_inverted_pulse:
      action: stop
    iceman_missles_pulse:
      action: stop
    iceman_afterburner_pulse:
      action: stop
    iceman_wingman_pulse:
      action: stop
    iceman_dogfight_pulse:
      loops: -1
      speed: 1
      show_tokens:
        led: l_mode_dogfight
        color: cyan
      key: iceman_dogfight_pulse
    iceman_pop_bumpers_fade:
      loops: -1
      speed: 1
      key: iceman_pop_bumpers_fade

  # Restore pulsing show on ball start if mission is qualified
  restore_training_mission_light{current_player.training_mission_qualified==1 and current_player.training_inverted_complete==0}:
    iceman_inverted_pulse:
      loops: -1
      speed: 1
      show_tokens:
        led: l_mode_inverted
        color: cyan
      key: iceman_inverted_pulse
    iceman_pop_bumpers_fade:
      loops: -1
      speed: 1
      key: iceman_pop_bumpers_fade

  restore_training_mission_light{current_player.training_mission_qualified==2 and current_player.training_missles_complete==0}:
    iceman_missles_pulse:
      loops: -1
      speed: 1
      show_tokens:
        led: l_mode_missles
        color: cyan
      key: iceman_missles_pulse
    iceman_pop_bumpers_fade:
      loops: -1
      speed: 1
      key: iceman_pop_bumpers_fade

  restore_training_mission_light{current_player.training_mission_qualified==3 and current_player.training_afterburner_complete==0}:
    iceman_afterburner_pulse:
      loops: -1
      speed: 1
      show_tokens:
        led: l_mode_afterburner
        color: cyan
      key: iceman_afterburner_pulse
    iceman_pop_bumpers_fade:
      loops: -1
      speed: 1
      key: iceman_pop_bumpers_fade

  restore_training_mission_light{current_player.training_mission_qualified==4 and current_player.training_wingman_complete==0}:
    iceman_wingman_pulse:
      loops: -1
      speed: 1
      show_tokens:
        led: l_mode_wingman
        color: cyan
      key: iceman_wingman_pulse
    iceman_pop_bumpers_fade:
      loops: -1
      speed: 1
      key: iceman_pop_bumpers_fade

  restore_training_mission_light{current_player.training_mission_qualified==5 and current_player.training_dogfight_complete==0}:
    iceman_dogfight_pulse:
      loops: -1
      speed: 1
      show_tokens:
        led: l_mode_dogfight
        color: cyan
      key: iceman_dogfight_pulse
    iceman_pop_bumpers_fade:
      loops: -1
      speed: 1
      key: iceman_pop_bumpers_fade

  # Stop pop bumper fade and pilot training lit fade when training mission starts
  mode_pilot_training_mission_inverted_started:
    iceman_pop_bumpers_fade:
      action: stop
  mode_pilot_training_mission_missiles_started:
    iceman_pop_bumpers_fade:
      action: stop
  # Stop pulse show when missiles mode ends (before setting solid white)
  training_missiles_mode_over:
    iceman_missles_pulse:
      action: stop
      key: iceman_missles_pulse
  mode_pilot_training_mission_afterburner_started:
    iceman_pop_bumpers_fade:
      action: stop
  # Stop pulse show when afterburner mode ends (before setting solid white)
  training_afterburner_mode_over:
    iceman_afterburner_pulse:
      action: stop
      key: iceman_afterburner_pulse
  mode_pilot_training_mission_wingman_started:
    iceman_pop_bumpers_fade:
      action: stop
  # Stop pulse show when wingman mode ends (before setting solid white)
  training_wingman_mode_over:
    iceman_wingman_pulse:
      action: stop
      key: iceman_wingman_pulse
  mode_training_dogfight_started:
    iceman_pop_bumpers_fade:
      action: stop

  # TODO: Add light show when letters are collected
  # s_i_iceman_target_active{current_player.iceman_letter_i==0}:
  #   iceman_letter_collect_show:
  #     loops: 1
  #     speed: 1

  # TODO: Add light show when ICEMAN is completed
  # iceman_complete:
  #   iceman_complete_show:
  #     loops: 1
  #     speed: 1

shows:
  iceman_inverted_pulse:
    - duration: 1s
      lights:
        (led):
          color: (color)
          fade: 0ms
    - duration: 1s
      lights:
        (led):
          color: off
          fade: 0ms

  iceman_missles_pulse:
    - duration: 1s
      lights:
        (led):
          color: (color)
          fade: 0ms
    - duration: 1s
      lights:
        (led):
          color: off
          fade: 0ms

  iceman_afterburner_pulse:
    - duration: 1s
      lights:
        (led):
          color: (color)
          fade: 0ms
    - duration: 1s
      lights:
        (led):
          color: off
          fade: 0ms

  iceman_wingman_pulse:
    - duration: 1s
      lights:
        (led):
          color: (color)
          fade: 0ms
    - duration: 1s
      lights:
        (led):
          color: off
          fade: 0ms

  iceman_dogfight_pulse:
    - duration: 1s
      lights:
        (led):
          color: (color)
          fade: 0ms
    - duration: 1s
      lights:
        (led):
          color: off
          fade: 0ms

  iceman_pop_bumpers_fade:
    - duration: 1s
      lights:
        l_gi_light_pop_left:
          color: cyan
          fade: 0ms
        l_gi_light_pop_right:
          color: cyan
          fade: 0ms
        l_gi_light_pop_bottom:
          color: cyan
          fade: 0ms
    - duration: 1s
      lights:
        l_gi_light_pop_left:
          color: off
          fade: 0ms
        l_gi_light_pop_right:
          color: off
          fade: 0ms
        l_gi_light_pop_bottom:
          color: off
          fade: 0ms


##############################################
## Light Player - Control ICEMAN Letter Lights
##############################################

light_player:
  # Restore ICEMAN letter lights on mode start based on player variables
  mode_iceman_letters_started{current_player.iceman_letter_i==1}:
    l_iceman_i:
      color: cyan

  mode_iceman_letters_started{current_player.iceman_letter_c==1}:
    l_iceman_c:
      color: cyan

  mode_iceman_letters_started{current_player.iceman_letter_e==1}:
    l_iceman_e:
      color: cyan

  mode_iceman_letters_started{current_player.iceman_letter_m==1}:
    l_iceman_m:
      color: cyan

  mode_iceman_letters_started{current_player.iceman_letter_a==1}:
    l_iceman_a:
      color: cyan

  mode_iceman_letters_started{current_player.iceman_letter_n==1}:
    l_iceman_n:
      color: cyan

  # Turn off all ICEMAN lights when mode stops
  mode_iceman_letters_stopped:
    l_iceman_i:
      color: off
    l_iceman_c:
      color: off
    l_iceman_e:
      color: off
    l_iceman_m:
      color: off
    l_iceman_a:
      color: off
    l_iceman_n:
      color: off
    l_pilot_training_lit:
      color: off

  ##############################################
  ## Light Letters on Target Hit (only when not paused)
  ##############################################

  s_i_iceman_target_active{current_player.iceman_letter_i==0 and current_player.iceman_completing==0 and current_player.letter_collection_paused==0}:
    l_iceman_i:
      color: cyan
      fade: 0ms

  s_c_iceman_target_active{current_player.iceman_letter_c==0 and current_player.iceman_completing==0 and current_player.letter_collection_paused==0}:
    l_iceman_c:
      color: cyan
      fade: 0ms

  s_e_iceman_target_active{current_player.iceman_letter_e==0 and current_player.iceman_completing==0 and current_player.letter_collection_paused==0}:
    l_iceman_e:
      color: cyan
      fade: 0ms

  s_m_iceman_target_active{current_player.iceman_letter_m==0 and current_player.iceman_completing==0 and current_player.letter_collection_paused==0}:
    l_iceman_m:
      color: cyan
      fade: 0ms

  s_a_iceman_target_active{current_player.iceman_letter_a==0 and current_player.iceman_completing==0 and current_player.letter_collection_paused==0}:
    l_iceman_a:
      color: cyan
      fade: 0ms

  s_n_iceman_target_active{current_player.iceman_letter_n==0 and current_player.iceman_completing==0 and current_player.letter_collection_paused==0}:
    l_iceman_n:
      color: cyan
      fade: 0ms

  ##############################################
  ## INVERTED PERK: Light Bonus ICEMAN Letters
  ## Same cyan color as normal collection
  ##############################################
  inverted_award_iceman_i:
    l_iceman_i:
      color: cyan
      fade: 0ms
  inverted_award_iceman_c:
    l_iceman_c:
      color: cyan
      fade: 0ms
  inverted_award_iceman_e:
    l_iceman_e:
      color: cyan
      fade: 0ms
  inverted_award_iceman_m:
    l_iceman_m:
      color: cyan
      fade: 0ms
  inverted_award_iceman_a:
    l_iceman_a:
      color: cyan
      fade: 0ms
  inverted_award_iceman_n:
    l_iceman_n:
      color: cyan
      fade: 0ms

  ##############################################
  ## Turn Off All Letters When Collection Paused
  ##############################################

  player_letter_collection_paused{value==1}:
    l_iceman_i:
      color: off
    l_iceman_c:
      color: off
    l_iceman_e:
      color: off
    l_iceman_m:
      color: off
    l_iceman_a:
      color: off
    l_iceman_n:
      color: off

  ##############################################
  ## Restore Letters When Collection Unpaused
  ##############################################

  player_letter_collection_paused{value==0 and current_player.iceman_letter_i==1}:
    l_iceman_i:
      color: cyan

  player_letter_collection_paused{value==0 and current_player.iceman_letter_c==1}:
    l_iceman_c:
      color: cyan

  player_letter_collection_paused{value==0 and current_player.iceman_letter_e==1}:
    l_iceman_e:
      color: cyan

  player_letter_collection_paused{value==0 and current_player.iceman_letter_m==1}:
    l_iceman_m:
      color: cyan

  player_letter_collection_paused{value==0 and current_player.iceman_letter_a==1}:
    l_iceman_a:
      color: cyan

  player_letter_collection_paused{value==0 and current_player.iceman_letter_n==1}:
    l_iceman_n:
      color: cyan

  ##############################################
  ## Update Lights Based on Player Variables
  ##############################################

  player_iceman_letter_i{value==1}:
    l_iceman_i:
      color: cyan

  player_iceman_letter_i{value==0}:
    l_iceman_i:
      color: off

  player_iceman_letter_c{value==1}:
    l_iceman_c:
      color: cyan

  player_iceman_letter_c{value==0}:
    l_iceman_c:
      color: off

  player_iceman_letter_e{value==1}:
    l_iceman_e:
      color: cyan

  player_iceman_letter_e{value==0}:
    l_iceman_e:
      color: off

  player_iceman_letter_m{value==1}:
    l_iceman_m:
      color: cyan

  player_iceman_letter_m{value==0}:
    l_iceman_m:
      color: off

  player_iceman_letter_a{value==1}:
    l_iceman_a:
      color: cyan

  player_iceman_letter_a{value==0}:
    l_iceman_a:
      color: off

  player_iceman_letter_n{value==1}:
    l_iceman_n:
      color: cyan

  player_iceman_letter_n{value==0}:
    l_iceman_n:
      color: off

  ##############################################
  ## Pilot Training Lit Light Control
  ##############################################

  # Light pilot training lit when mission is qualified
  qualify_training_mission:
    l_pilot_training_lit:
      color: cyan
      fade: 0ms

  # Restore pilot training lit on ball start if qualified
  mode_iceman_letters_started{current_player.training_mission_qualified>0}:
    l_pilot_training_lit:
      color: cyan
      fade: 0ms

  # Turn off pilot training lit and pop bumpers when mission starts
  # Note: l_mode_inverted is handled by the mode's own show_player (pulsing during play)
  mode_pilot_training_mission_inverted_started:
    l_pilot_training_lit:
      color: off
    l_gi_light_pop_left:
      color: off
      fade: 0ms
    l_gi_light_pop_right:
      color: off
      fade: 0ms
    l_gi_light_pop_bottom:
      color: off
      fade: 0ms

  # Delayed light setting - fires 500ms after mode stop to survive the 'clear' event
  # Solid white indicates mode has been played (regardless of win/loss)
  training_inverted_mode_over:
    l_mode_inverted:
      color: white
      fade: 0ms

  # Delayed light setting for missiles - solid white after mode played
  training_missiles_mode_over:
    l_mode_missles:
      color: white
      fade: 0ms

  # Delayed light setting for afterburner - solid white after mode played
  training_afterburner_mode_over:
    l_mode_afterburner:
      color: white
      fade: 0ms

  # Delayed light setting for wingman - solid white after mode played
  training_wingman_mode_over:
    l_mode_wingman:
      color: white
      fade: 0ms

  mode_pilot_training_mission_missiles_started:
    l_pilot_training_lit:
      color: off
    l_gi_light_pop_left:
      color: off
      fade: 0ms
    l_gi_light_pop_right:
      color: off
      fade: 0ms
    l_gi_light_pop_bottom:
      color: off
      fade: 0ms

  mode_pilot_training_mission_afterburner_started:
    l_pilot_training_lit:
      color: off
    l_mode_afterburner:
      color: cyan
      fade: 0ms
    l_gi_light_pop_left:
      color: off
      fade: 0ms
    l_gi_light_pop_right:
      color: off
      fade: 0ms
    l_gi_light_pop_bottom:
      color: off
      fade: 0ms

  mode_pilot_training_mission_wingman_started:
    l_pilot_training_lit:
      color: off
    l_mode_wingman:
      color: cyan
      fade: 0ms
    l_gi_light_pop_left:
      color: off
      fade: 0ms
    l_gi_light_pop_right:
      color: off
      fade: 0ms
    l_gi_light_pop_bottom:
      color: off
      fade: 0ms

  mode_training_dogfight_started:
    l_pilot_training_lit:
      color: off
    l_mode_dogfight:
      color: cyan
      fade: 0ms
    l_gi_light_pop_left:
      color: off
      fade: 0ms
    l_gi_light_pop_right:
      color: off
      fade: 0ms
    l_gi_light_pop_bottom:
      color: off
      fade: 0ms

  ##############################################
  ## Training Mission Light Control
  ##############################################

  # Turn off all mission lights after shows are stopped
  # BUT keep inverted light if mode was already played (won=green, lost=red)
  stop_all_training_pulse_shows{current_player.training_inverted_complete==0}:
    l_mode_inverted:
      color: off
  stop_all_training_pulse_shows{current_player.training_missles_complete==0}:
    l_mode_missles:
      color: off
  stop_all_training_pulse_shows{current_player.training_afterburner_complete==0}:
    l_mode_afterburner:
      color: off
  stop_all_training_pulse_shows{current_player.training_wingman_complete==0}:
    l_mode_wingman:
      color: off
  stop_all_training_pulse_shows:
    l_mode_dogfight:
      color: off

  # Restore mission light on ball start (pulsing handled by show_player)
  # Only restore inverted light if mode not yet completed
  restore_training_mission_light{current_player.training_mission_qualified==1 and current_player.training_inverted_complete==0}:
    l_mode_inverted:
      color: cyan
  # If inverted mode has been played, show solid white on ball start
  restore_training_mission_light{current_player.training_inverted_complete==1}:
    l_mode_inverted:
      color: white
      fade: 0ms
  # If missiles mode has been played, show solid white on ball start
  restore_training_mission_light{current_player.training_missles_complete==1}:
    l_mode_missles:
      color: white
      fade: 0ms
  restore_training_mission_light{current_player.training_mission_qualified==2 and current_player.training_missles_complete==0}:
    l_mode_missles:
      color: cyan
  # If afterburner mode has been played, show solid white on ball start
  restore_training_mission_light{current_player.training_afterburner_complete==1}:
    l_mode_afterburner:
      color: white
      fade: 0ms
  restore_training_mission_light{current_player.training_mission_qualified==3 and current_player.training_afterburner_complete==0}:
    l_mode_afterburner:
      color: cyan
  # If wingman mode has been played, show solid white on ball start
  restore_training_mission_light{current_player.training_wingman_complete==1}:
    l_mode_wingman:
      color: white
      fade: 0ms
  restore_training_mission_light{current_player.training_mission_qualified==4 and current_player.training_wingman_complete==0}:
    l_mode_wingman:
      color: cyan
  restore_training_mission_light{current_player.training_mission_qualified==5}:
    l_mode_dogfight:
      color: cyan

  # Reset inverted insert to white on ball end (perk slide removed by slide_player)
  ball_will_end{current_player.training_inverted_complete==1}:
    l_mode_inverted:
      color: white
      fade: 0ms

  # Reset missiles insert to white on ball end
  ball_will_end{current_player.training_missles_complete==1}:
    l_mode_missles:
      color: white
      fade: 0ms

  # Reset afterburner insert to white on ball end
  ball_will_end{current_player.training_afterburner_complete==1}:
    l_mode_afterburner:
      color: white
      fade: 0ms

  # Reset wingman insert to white on ball end
  ball_will_end{current_player.training_wingman_complete==1}:
    l_mode_wingman:
      color: white
      fade: 0ms

  # Initial light when qualified (will be overridden by pulsing show)
  # Use player variable change event
  # Turn off all mission lights first, then turn on the qualified one
  # BUT don't change inverted/missiles light if mode already completed
  player_training_mission_qualified{value==1 and current_player.training_inverted_complete==0}:
    l_mode_inverted:
      color: cyan
  player_training_mission_qualified{value==1 and current_player.training_missles_complete==0}:
    l_mode_missles:
      color: off
  player_training_mission_qualified{value==1 and current_player.training_wingman_complete==0}:
    l_mode_wingman:
      color: off
    l_mode_dogfight:
      color: off
  player_training_mission_qualified{value==1 and current_player.training_afterburner_complete==0}:
    l_mode_afterburner:
      color: off
  
  player_training_mission_qualified{value==2 and current_player.training_inverted_complete==0}:
    l_mode_inverted:
      color: off
  player_training_mission_qualified{value==2 and current_player.training_missles_complete==0}:
    l_mode_missles:
      color: cyan
  player_training_mission_qualified{value==2 and current_player.training_wingman_complete==0}:
    l_mode_wingman:
      color: off
    l_mode_dogfight:
      color: off
  player_training_mission_qualified{value==2 and current_player.training_afterburner_complete==0}:
    l_mode_afterburner:
      color: off
  
  player_training_mission_qualified{value==3 and current_player.training_inverted_complete==0}:
    l_mode_inverted:
      color: off
  player_training_mission_qualified{value==3 and current_player.training_missles_complete==0}:
    l_mode_missles:
      color: off
  player_training_mission_qualified{value==3 and current_player.training_afterburner_complete==0}:
    l_mode_afterburner:
      color: cyan
  player_training_mission_qualified{value==3 and current_player.training_wingman_complete==0}:
    l_mode_wingman:
      color: off
  player_training_mission_qualified{value==3}:
    l_mode_dogfight:
      color: off
  
  player_training_mission_qualified{value==4 and current_player.training_inverted_complete==0}:
    l_mode_inverted:
      color: off
  player_training_mission_qualified{value==4 and current_player.training_missles_complete==0}:
    l_mode_missles:
      color: off
  player_training_mission_qualified{value==4 and current_player.training_wingman_complete==0}:
    l_mode_wingman:
      color: cyan
    l_mode_dogfight:
      color: off
  player_training_mission_qualified{value==4 and current_player.training_afterburner_complete==0}:
    l_mode_afterburner:
      color: off
  
  player_training_mission_qualified{value==5 and current_player.training_inverted_complete==0}:
    l_mode_inverted:
      color: off
  # Dogfight light - only show if ALL 4 standard missions are complete
  player_training_mission_qualified{value==5 and current_player.training_inverted_complete==1 and current_player.training_missles_complete==1 and current_player.training_afterburner_complete==1 and current_player.training_wingman_complete==1}:
    l_mode_missles:
      color: off
    l_mode_afterburner:
      color: off
    l_mode_wingman:
      color: off
    l_mode_dogfight:
      color: cyan

##############################################
## Slide Player - Perk Active Slide
##############################################

slide_player:
  # Show inverted perk slide when mode ends with win
  # Must be in iceman_letters (persistent mode) so it survives the mode stopping
  training_inverted_mode_over{current_player.training_mission_inverted_perk_active==1}:
    inverted_perk_active:
      action: play
      priority: 750

  # Show missiles perk slide when mode ends with win
  training_missiles_mode_over{current_player.missiles_perk_active==1}:
    missiles_perk_active:
      action: play
      priority: 750

  # Remove perk slides when ball ends
  ball_will_end:
    inverted_perk_active:
      action: remove
    missiles_perk_active:
      action: remove

##############################################
## Sound Player
##############################################

sound_player:
  # Training mission qualified voice callout
  qualify_training_mission:
    voice_pilot_training_qualified:
      bus: voice
      loops: 0

  # Individual letter hits
  # s_i_iceman_target_active{current_player.iceman_letter_i==0}:
  #   sfx_iceman_letter:
  #     bus: effects
  #     loops: 0
  # s_c_iceman_target_active{current_player.iceman_letter_c==0}:
  #   sfx_iceman_letter:
  #     bus: effects
  #     loops: 0
  # s_e_iceman_target_active{current_player.iceman_letter_e==0}:
  #   sfx_iceman_letter:
  #     bus: effects
  #     loops: 0
  # s_m_iceman_target_active{current_player.iceman_letter_m==0}:
  #   sfx_iceman_letter:
  #     bus: effects
  #     loops: 0
  # s_a_iceman_target_active{current_player.iceman_letter_a==0}:
  #   sfx_iceman_letter:
  #     bus: effects
  #     loops: 0
  # s_n_iceman_target_active{current_player.iceman_letter_n==0}:
  #   sfx_iceman_letter:
  #     bus: effects
  #     loops: 0
  # 
  # # ICE completed
  # ice_complete:
  #   sfx_ice_complete:
  #     bus: effects
  #     loops: 0
  # 
  # # MAN completed
  # man_complete:
  #   sfx_man_complete:
  #     bus: effects
  #     loops: 0
  # 
  # # ICEMAN completed
  # iceman_complete:
  #   sfx_iceman_complete:
  #     bus: effects
  #     loops: 0
  # 
  # # Mission rotation
  # s_pop_bumper_left_active{current_player.training_mission_qualified>0}:
  #   sfx_mission_rotate:
  #     bus: effects
  #     loops: 0
  # s_pop_bumper_right_active{current_player.training_mission_qualified>0}:
  #   sfx_mission_rotate:
  #     bus: effects
  #     loops: 0
  # s_pop_bumper_bottom_active{current_player.training_mission_qualified>0}:
  #   sfx_mission_rotate:
  #     bus: effects
  #     loops: 0

##############################################
## Slide Player (Placeholders - Uncomment when slides are ready)
##############################################

# slide_player:
#   # ICEMAN completed slide
#   iceman_complete:
#     iceman_complete_slide:
#       expire: 3s
#       priority: 300

# slides:
#   iceman_complete_slide:
#     widgets:
#       - type: text
#         text: "ICEMAN COMPLETE!"
#         font_size: 60
#         color: cyan
#       - type: text
#         text: "PILOT TRAINING QUALIFIED"
#         font_size: 40
#         color: cyan
#         y: -50

# sounds:
#   sfx_iceman_letter:
#     file: iceman_letter.wav
#     streaming: false
#   sfx_ice_complete:
#     file: ice_complete.wav
#     streaming: false
#   sfx_man_complete:
#     file: man_complete.wav
#     streaming: false
#   sfx_iceman_complete:
#     file: iceman_complete.wav
#     streaming: false
#   sfx_mission_rotate:
#     file: mission_rotate.wav
#     streaming: false
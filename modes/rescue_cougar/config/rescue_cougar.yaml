#config_version=6

####################################################################################
# RESCUE COUGAR - PILOT MISSION MODE
# Timer: 90 seconds countdown
# Total Steps: 11 shots to complete
# Can stack with multiball: Yes
# GI Color: Blue

# Adjustable Timing Values:
# - Mode timer: 90 seconds (line 59386)
# - Intro Video Delay: (line 407)
# - Barrier delay: 750ms (line 417)
# - Mode Switch Debounce: 150ms (line 430)
# - MIG post hold: 2 seconds (lines 400 - 483)
# - Left lane post hold: 3 seconds (lines 400 - 483)
# - Shot lockout timers: 2-3 seconds (lines 400 - 483)
####################################################################################

mode:
  start_events: start_mode_rescue_cougar
  stop_events: 
    - timer_rescue_cougar_complete_delay_complete
    - timer_rescue_cougar_failed_delay_complete
    - rescue_cougar_drain_cleanup_complete
  priority: 600
  game_mode: true
  use_wait_queue: true

# Mode can stack with multiball
mode_settings:
  can_stack_with_multiball: true

####################################################################################
# BALL HOLDS - Control when the mode scoop releases the ball
####################################################################################
# The mode scoop should HOLD the ball during intro video,
# then release it when the video completes (or player skips with flippers).
# This prevents MPF from auto-ejecting the ball before the video finishes.

ball_holds:
  rescue_cougar_scoop_hold:
    balls_to_hold: 1
    hold_devices: bd_mode_scoop
    # Enable the hold when mode starts
    enable_events: 
      - mode_rescue_cougar_started
    # Release one ball when ball_released event fires (this triggers the eject)
    release_one_events: 
      - rescue_cougar_ball_released
    # Also release all on mode stop (safety)
    release_all_events:
      - mode_rescue_cougar_will_stop

####################################################################################
# QUEUE RELAY PLAYER - Hold ball_ending until mode cleanup completes
####################################################################################
# This is CRITICAL for proper drain handling:
# - When ball drains, we need time to play the failure video BEFORE bonus starts
# - queue_relay_player intercepts ball_ending and holds it
# - We release it when rescue_cougar_drain_cleanup_complete fires
# - Priority 1000 ensures this runs BEFORE bonus mode (priority 500) can start

queue_relay_player:
  ball_ending{mode.rescue_cougar.active==True}:
    post: rescue_cougar_ball_ending_hold
    wait_for: rescue_cougar_drain_cleanup_complete
    priority: 1000


####################################################################################
# SOUNDS - Define in Main Machine Config (NOT here)
####################################################################################
# MPF 0.80+ requires sounds to be defined in your main machine config file,
# not in mode configs. Add these to your main sounds: section:
#
# sounds:
#   rescue_cougar_music_base:
#     file: music/rescue_cougar_music_base.ogg
#     volume: 0.8
#     streaming: true
#   rescue_cougar_music_2:
#     file: music/rescue_cougar_music_2.ogg
#     volume: 0.8
#     streaming: true

####################################################################################
# VARIABLE PLAYER - Initialize mode variables
####################################################################################

variable_player:
  mode_rescue_cougar_started:
    # Universal pilot mode tracking - set when any pilot mode starts
    pilot_mode_active:
      action: set
      int: 1
    # Pause TOPGUN and ICEMAN letter collection during this mode
    letter_collection_paused:
      action: set
      int: 1
    rescue_cougar_step:
      action: set
      int: 0
    rescue_cougar_complete_flag:
      action: set
      int: 0
    pilot_missions_played:
      action: add
      int: 1
    rescue_cougar_shots_remaining:
      action: set
      int: 11
    mode_points_scored:
      action: set
      int: 0

  # Ball drain during mode - award points and mark drain pending
  ball_will_end{mode.rescue_cougar.active==True}:
    # Mark that drain happened during pilot mode - triggers bonus after cleanup
    pilot_mode_drain_pending:
      action: set
      int: 1

  # Step completion tracking - also decrement shots remaining
  rescue_cougar_step_1_complete:
    rescue_cougar_step:
      action: set
      int: 1
    score: 100000 * current_player.total_scoring_multiplier
    mode_points_scored:
      action: set
      int: 100000 * current_player.total_scoring_multiplier
    rescue_cougar_shots_remaining:
      action: add
      int: -1
      
  rescue_cougar_step_2_complete:
    rescue_cougar_step:
      action: set
      int: 2
    score: 125000 * current_player.total_scoring_multiplier
    mode_points_scored:
      action: set
      int: 125000 * current_player.total_scoring_multiplier
    rescue_cougar_shots_remaining:
      action: add
      int: -1
      
  rescue_cougar_step_3_complete:
    rescue_cougar_step:
      action: set
      int: 3
    score: 150000 * current_player.total_scoring_multiplier
    mode_points_scored:
      action: set
      int: 150000 * current_player.total_scoring_multiplier
    rescue_cougar_shots_remaining:
      action: add
      int: -1
      
  rescue_cougar_step_4_complete:
    rescue_cougar_step:
      action: set
      int: 4
    score: 175000 * current_player.total_scoring_multiplier
    mode_points_scored:
      action: set
      int: 175000 * current_player.total_scoring_multiplier
    rescue_cougar_shots_remaining:
      action: add
      int: -1
      
  rescue_cougar_step_5_complete:
    rescue_cougar_step:
      action: set
      int: 5
    score: 200000 * current_player.total_scoring_multiplier
    mode_points_scored:
      action: set
      int: 200000 * current_player.total_scoring_multiplier
    rescue_cougar_shots_remaining:
      action: add
      int: -1
      
  rescue_cougar_step_6_complete:
    rescue_cougar_step:
      action: set
      int: 6
    score: 225000 * current_player.total_scoring_multiplier
    mode_points_scored:
      action: set
      int: 225000 * current_player.total_scoring_multiplier
    rescue_cougar_shots_remaining:
      action: add
      int: -1
      
  rescue_cougar_step_7_complete:
    rescue_cougar_step:
      action: set
      int: 7
    score: 250000 * current_player.total_scoring_multiplier
    mode_points_scored:
      action: set
      int: 250000 * current_player.total_scoring_multiplier
    rescue_cougar_shots_remaining:
      action: add
      int: -1
      
  rescue_cougar_step_8_complete:
    rescue_cougar_step:
      action: set
      int: 8
    score: 275000 * current_player.total_scoring_multiplier
    mode_points_scored:
      action: set
      int: 275000 * current_player.total_scoring_multiplier
    rescue_cougar_shots_remaining:
      action: add
      int: -1
      
  rescue_cougar_step_9_complete:
    rescue_cougar_step:
      action: set
      int: 9
    score: 300000 * current_player.total_scoring_multiplier
    mode_points_scored:
      action: set
      int: 300000 * current_player.total_scoring_multiplier
    rescue_cougar_shots_remaining:
      action: add
      int: -1
      
  rescue_cougar_step_10_complete:
    rescue_cougar_step:
      action: set
      int: 10
    score: 325000 * current_player.total_scoring_multiplier
    mode_points_scored:
      action: set
      int: 325000 * current_player.total_scoring_multiplier
    rescue_cougar_shots_remaining:
      action: add
      int: -1
      
  rescue_cougar_step_11_complete:
    rescue_cougar_step:
      action: set
      int: 11
    rescue_cougar_complete_flag:
      action: set
      int: 1
    score: 350000 * current_player.total_scoring_multiplier
    mode_points_scored:
      action: set
      int: 350000 * current_player.total_scoring_multiplier
    pilot_missions_won:
      action: add
      int: 1
    rescue_cougar_shots_remaining:
      action: add
      int: -1
    # Save and disable missiles perk to prevent visual firing during victory video
    missiles_perk_saved:
      action: set
      int: current_player.missiles_perk_active
    missiles_perk_active:
      action: set
      int: 0

####################################################################################
# SLIDE PLAYER - Mode Slides (GODOT 4.1.1 Format)
####################################################################################

slide_player:
  mode_rescue_cougar_started:
    rescue_cougar_shots_remaining:
      action: play
      priority: 1000
    rescue_cougar_intro_video:
      action: play
      priority: 900
    rescue_cougar_step_1_instructions:
      action: play
      priority: 850  # Below main video, above background

  # Show normal timer when perk is NOT active
  mode_rescue_cougar_started{current_player.afterburner_perk_active==0}:
    rescue_cougar_timer:
      action: play
      priority: 1000

  # Show perk slides when perk IS active (immediately on mode start)
  mode_rescue_cougar_started{current_player.afterburner_perk_active==1}:
    afterburner_perk_active:
      action: play
      priority: 850
    timer_perk_activated:
      action: play
      priority: 1000

  # Cancel intro video when both flippers pressed
  rescue_cougar_skip_intro:
    rescue_cougar_intro_video:
      action: remove

  rescue_cougar_cleanup:
    timer_perk_activated:
      action: remove

  # Step 3 starts - turn off step 1 instructions, show step 3 instructions
  rescue_cougar_setup_step_3:
    rescue_cougar_step_1_instructions:
      action: remove
    rescue_cougar_step_3_instructions:
      action: play
      priority: 850

  # Step 6 starts - turn off step 3 instructions, show step 6 instructions
  rescue_cougar_setup_step_6:
    rescue_cougar_step_3_instructions:
      action: remove
    rescue_cougar_step_6_instructions:
      action: play
      priority: 850

  # Step 7 starts - turn off step 6 instructions, show step 7 instructions
  rescue_cougar_setup_step_7:
    rescue_cougar_step_6_instructions:
      action: remove
    rescue_cougar_step_7_instructions:
      action: play
      priority: 850

  # Step 8 starts - turn off step 7 instructions, show step 8 instructions
  rescue_cougar_setup_step_8:
    rescue_cougar_step_7_instructions:
      action: remove
    rescue_cougar_step_8_instructions:
      action: play
      priority: 850

  # Step 9 starts - turn off step 8 instructions
  rescue_cougar_setup_step_9:
    rescue_cougar_step_8_instructions:
      action: remove

  rescue_cougar_complete:
    rescue_cougar_timer:
      action: remove
    rescue_cougar_shots_remaining:
      action: remove
    rescue_cougar_intro_video:
      action: remove
    rescue_cougar_step_1_instructions:
      action: remove
    rescue_cougar_step_3_instructions:
      action: remove
    rescue_cougar_step_6_instructions:
      action: remove
    rescue_cougar_step_7_instructions:
      action: remove
    rescue_cougar_step_8_instructions:
      action: remove
    # Step videos - ensure none linger (missile rapid-fire cleanup)
    rescue_cougar_step_1:
      action: remove
    rescue_cougar_step_2:
      action: remove
    rescue_cougar_step_3:
      action: remove
    rescue_cougar_step_4:
      action: remove
    rescue_cougar_step_5:
      action: remove
    rescue_cougar_step_6:
      action: remove
    rescue_cougar_step_7:
      action: remove
    rescue_cougar_step_8:
      action: remove
    rescue_cougar_step_9:
      action: remove
    rescue_cougar_step_10:
      action: remove
    rescue_cougar_step_11:
      action: remove
    rescue_cougar_won:
      action: play
      priority: 900
      expire: 8s  # Match complete_delay timer

  rescue_cougar_failed:
    rescue_cougar_timer:
      action: remove
    rescue_cougar_shots_remaining:
      action: remove
    rescue_cougar_intro_video:
      action: remove
    rescue_cougar_step_1_instructions:
      action: remove
    rescue_cougar_step_3_instructions:
      action: remove
    rescue_cougar_step_6_instructions:
      action: remove
    rescue_cougar_step_7_instructions:
      action: remove
    rescue_cougar_step_8_instructions:
      action: remove
    # Step videos - ensure none linger (missile rapid-fire cleanup)
    rescue_cougar_step_1:
      action: remove
    rescue_cougar_step_2:
      action: remove
    rescue_cougar_step_3:
      action: remove
    rescue_cougar_step_4:
      action: remove
    rescue_cougar_step_5:
      action: remove
    rescue_cougar_step_6:
      action: remove
    rescue_cougar_step_7:
      action: remove
    rescue_cougar_step_8:
      action: remove
    rescue_cougar_step_9:
      action: remove
    rescue_cougar_step_10:
      action: remove
    rescue_cougar_step_11:
      action: remove
    rescue_cougar_lost:
      action: play
      priority: 900
      expire: 16s  # Match failed_delay timer

  mode_rescue_cougar_stopped:
    rescue_cougar_timer:
      action: remove
    rescue_cougar_shots_remaining:
      action: remove
    rescue_cougar_step_1_instructions:
      action: remove
    rescue_cougar_step_3_instructions:
      action: remove
    rescue_cougar_step_6_instructions:
      action: remove
    rescue_cougar_step_7_instructions:
      action: remove
    rescue_cougar_step_8_instructions:
      action: remove
    # Step videos - ensure none linger (missile rapid-fire cleanup)
    rescue_cougar_step_1:
      action: remove
    rescue_cougar_step_2:
      action: remove
    rescue_cougar_step_3:
      action: remove
    rescue_cougar_step_4:
      action: remove
    rescue_cougar_step_5:
      action: remove
    rescue_cougar_step_6:
      action: remove
    rescue_cougar_step_7:
      action: remove
    rescue_cougar_step_8:
      action: remove
    rescue_cougar_step_9:
      action: remove
    rescue_cougar_step_10:
      action: remove
    rescue_cougar_step_11:
      action: remove


  # Step videos - play when shot is hit, remove previous
  rescue_cougar_step_1_shot_hit:
    rescue_cougar_step_1:
      action: play
      priority: 800
    mode_points_scored:
      action: play
      priority: 840
      expire: 2s

  rescue_cougar_step_2_shot_hit:
    rescue_cougar_step_1:
      action: remove
    rescue_cougar_step_2:
      action: play
      priority: 800
    mode_points_scored:
      action: play
      priority: 840
      expire: 2s

  rescue_cougar_step_3_shot_hit:
    rescue_cougar_step_2:
      action: remove
    rescue_cougar_step_3:
      action: play
      priority: 800
    mode_points_scored:
      action: play
      priority: 840
      expire: 2s

  rescue_cougar_step_4_shot_hit:
    rescue_cougar_step_3:
      action: remove
    rescue_cougar_step_4:
      action: play
      priority: 800
    mode_points_scored:
      action: play
      priority: 840
      expire: 2s

  rescue_cougar_step_5_shot_hit:
    rescue_cougar_step_4:
      action: remove
    rescue_cougar_step_5:
      action: play
      priority: 800
    mode_points_scored:
      action: play
      priority: 840
      expire: 2s

  rescue_cougar_step_6_shot_hit:
    rescue_cougar_step_5:
      action: remove
    rescue_cougar_step_6:
      action: play
      priority: 800
    mode_points_scored:
      action: play
      priority: 840
      expire: 2s

  rescue_cougar_step_7_shot_hit:
    rescue_cougar_step_6:
      action: remove
    rescue_cougar_step_7:
      action: play
      priority: 800
    mode_points_scored:
      action: play
      priority: 840
      expire: 2s

  rescue_cougar_step_8_shot_hit:
    rescue_cougar_step_7:
      action: remove
    rescue_cougar_step_8:
      action: play
      priority: 800
    mode_points_scored:
      action: play
      priority: 840
      expire: 2s

  rescue_cougar_step_9_shot_hit:
    rescue_cougar_step_8:
      action: remove
    rescue_cougar_step_9:
      action: play
      priority: 800
    mode_points_scored:
      action: play
      priority: 840
      expire: 2s

  rescue_cougar_step_10_shot_hit:
    rescue_cougar_step_9:
      action: remove
    rescue_cougar_step_10:
      action: play
      priority: 800
    mode_points_scored:
      action: play
      priority: 840
      expire: 2s

  rescue_cougar_step_11_shot_hit:
    rescue_cougar_step_10:
      action: remove
    rescue_cougar_step_11:
      action: play
      priority: 800
    mode_points_scored:
      action: play
      priority: 840
      expire: 2s


####################################################################################
# TIMERS
####################################################################################

timers:
  rescue_cougar_timer:
    start_value: 90
    end_value: 0
    direction: down
    tick_interval: 1s
    start_running: false
    control_events:
      - event: s_mode_start_inactive
        action: start
      - event: timer_rescue_cougar_complete_delay_start
        action: stop
      - event: timer_rescue_cougar_failed_delay_start
        action: stop
      - event: s_lane_left_active
        action: pause
      - event: s_lane_left_inactive
        action: start
      - event: afterburner_extend_rescue_cougar_timer
        action: jump
        value: 9999

  # INTRO VIDEO TIMER - Match battle_jester pattern EXACTLY
  # Auto-starts on mode_started, tick_interval in seconds, control_events to start
  rescue_cougar_intro_video_delay:
    start_value: 0
    end_value: 24
    direction: up
    tick_interval: 1s
    control_events:
      - event: mode_rescue_cougar_started
        action: start
      - event: rescue_cougar_skip_intro
        action: stop

  # BARRIER RAISE DELAY - Time after ball successfully leaves mode scoop
  # Timer starts when debounce completes (confirming ball actually left)
  # After 750ms, barrier raises
  rescue_cougar_barrier_delay:
    start_value: 0
    end_value: 750  # 750ms - ADJUST THIS for ball clearance time
    direction: up
    tick_interval: 1ms
    start_running: false
    control_events:
      - event: timer_rescue_cougar_eject_debounce_complete
        action: restart

  # Debounce timer - Ensures ball actually left before starting main delay
  # Prevents false starts on failed ejects or ball bouncing back
  rescue_cougar_eject_debounce:
    start_value: 0
    end_value: 150  # 150ms debounce - ball must stay away from switch
    direction: up
    tick_interval: 1ms
    start_running: false
    control_events:
      - event: s_mode_start_inactive
        action: restart  # Restart on each inactive (resets if ball bounces back)
      - event: s_mode_start_active
        action: stop     # Stop if ball goes back to switch

  # MIG post activation timers (2 second hold)
  rescue_cougar_left_mig_post_timer:
    start_value: 3
    end_value: 0
    direction: down
    tick_interval: 1s
    start_running: false
    control_events:
      - event: rescue_cougar_activate_left_mig_post
        action: start

  rescue_cougar_right_mig_post_timer:
    start_value: 3
    end_value: 0
    direction: down
    tick_interval: 1s
    start_running: false
    control_events:
      - event: rescue_cougar_activate_right_mig_post
        action: start

  # Left lane post timer (2 second hold)
  rescue_cougar_left_lane_post_timer:
    start_value: 27
    end_value: 0
    direction: down
    tick_interval: 1s
    start_running: false
    control_events:
      - event: rescue_cougar_activate_left_lane_post
        action: start

  # Shot lockout timers (prevent repeated hits during post activation)
  rescue_cougar_left_orbit_lockout:
    start_value: 2
    end_value: 0
    direction: down
    tick_interval: 1s
    start_running: false

  rescue_cougar_right_orbit_lockout:
    start_value: 2
    end_value: 0
    direction: down
    tick_interval: 1s
    start_running: false

  rescue_cougar_left_lane_lockout:
    start_value: 7
    end_value: 0
    direction: down
    tick_interval: 1s
    start_running: false
  
  # End video delay timers
  rescue_cougar_complete_delay:
    start_value: 8
    end_value: 0
    direction: down
    tick_interval: 1s
    start_running: false
    control_events:
      - event: timer_rescue_cougar_complete_delay_start
        action: start
  
  rescue_cougar_failed_delay:
    start_value: 16
    end_value: 0
    direction: down
    tick_interval: 1s
    start_running: false
    control_events:
      - event: timer_rescue_cougar_failed_delay_start
        action: start

  # DRAIN DELAY TIMER - Holds ball_ending until lost video plays
  # Uses queue_relay_player to hold the ball_ending process
  rescue_cougar_drain_delay:
    start_value: 0
    end_value: 16
    direction: up
    tick_interval: 1s
    control_events:
      - event: rescue_cougar_drain_detected
        action: start

####################################################################################
# EVENT PLAYER
####################################################################################

event_player:
  ##############################################
  ## AFTERBURNER PERK: Pause Mode Timer
  ## Jumps timer to 9999s making it effectively infinite
  ## 500ms delay ensures timer has started before jump fires
  ##############################################
  rescue_cougar_ball_released{current_player.afterburner_perk_active==1}:
    - afterburner_extend_rescue_cougar_timer|500ms

  ##############################################
  ## DRAIN HANDLING - Critical for proper cleanup
  ## queue_relay_player holds ball_ending until we're ready
  ## This ensures pilot_mission_qualifier stays active to clear pause flags
  ##############################################
  
  # When ball_ending is held by queue_relay_player, this fires
  # Start the drain delay timer and trigger failure routine
  rescue_cougar_ball_ending_hold:
    - rescue_cougar_failed
    - rescue_cougar_drain_detected
  
  # When drain delay timer completes, signal cleanup complete to release queue
  timer_rescue_cougar_drain_delay_complete:
    - rescue_cougar_drain_cleanup_complete
    - rescue_cougar_cleanup

  mode_rescue_cougar_started:
    - reset_topgun_letters  # Reset TOPGUN collection for duration of mode
    # Timer auto-starts via control_events (like battle_jester)
    # Shots setup when timer_rescue_cougar_intro_video_delay_complete fires

  # NORMAL PATH: Intro video delay completes → release ball AND setup shots
  timer_rescue_cougar_intro_video_delay_complete:
    - rescue_cougar_ball_released
    - rescue_cougar_setup_shots

  # SKIP PATH: Both flippers pressed → stop intro timer, release ball, setup shots
  rescue_cougar_skip_intro:
    - rescue_cougar_ball_released  # Release ball immediately
    - rescue_cougar_setup_shots  # Setup shots immediately

  # DEBOUNCE: Timer automatically starts barrier delay when complete
  # (configured in timer control_events)

  # BOTH PATHS: After ball clears barrier area → raise barrier
  # Uses standardized barrier_raise event (handled by pilot_mission_qualifier)
  timer_rescue_cougar_barrier_delay_complete:
    - barrier_raise

  # Skip intro video with both flippers (match battle_jester pattern)
  s_flipper_left_active{current_player.rescue_cougar_step==0 and device.timers.rescue_cougar_intro_video_delay.running}:
    - rescue_cougar_check_skip_intro
  s_flipper_right_active{current_player.rescue_cougar_step==0 and device.timers.rescue_cougar_intro_video_delay.running}:
    - rescue_cougar_check_skip_intro
    
  rescue_cougar_check_skip_intro{device.switches.s_flipper_left.state and device.switches.s_flipper_right.state}:
    - rescue_cougar_skip_intro

  # Step progression
  rescue_cougar_step_6_complete:
    - rescue_cougar_setup_step_7

  rescue_cougar_step_7_complete:
    - rescue_cougar_setup_step_8

  # Timer expired (only fail if afterburner perk is NOT active)
  timer_rescue_cougar_timer_complete{current_player.afterburner_perk_active==0}:
    - rescue_cougar_failed

  # Step 1 and 2 - Left and Right Orbits (using entrance switches for MIG post shots)
  # These steps use single switch detection since the MIG posts stop the ball
  # s_orbit_left triggers RIGHT MIG post, s_orbit_right triggers LEFT MIG post
  s_orbit_left_active{current_player.rescue_cougar_step==0 and device.timers.rescue_cougar_left_orbit_lockout.running==False}:
    - rescue_cougar_step_1_complete
    - rescue_cougar_activate_right_mig_post
    - rescue_cougar_step_1_shot_hit

  s_orbit_right_active{current_player.rescue_cougar_step==0 and device.timers.rescue_cougar_right_orbit_lockout.running==False}:
    - rescue_cougar_step_1_complete
    - rescue_cougar_activate_left_mig_post
    - rescue_cougar_step_1_shot_hit

  s_orbit_left_active{current_player.rescue_cougar_step==1 and device.timers.rescue_cougar_left_orbit_lockout.running==False}:
    - rescue_cougar_step_2_complete
    - rescue_cougar_activate_right_mig_post
    - rescue_cougar_step_2_shot_hit

  s_orbit_right_active{current_player.rescue_cougar_step==1 and device.timers.rescue_cougar_right_orbit_lockout.running==False}:
    - rescue_cougar_step_2_complete
    - rescue_cougar_activate_left_mig_post
    - rescue_cougar_step_2_shot_hit

  # Step 3, 4, 5 - Left Ramp, Upper Orbit, Inner Ramp, Right Ramp
  s_ramp_left_exit_active{current_player.rescue_cougar_step==2}:
    - rescue_cougar_step_3_complete
    - rescue_cougar_step_3_shot_hit

  s_orbit_upper_active{current_player.rescue_cougar_step==2}:
    - rescue_cougar_step_3_complete
    - rescue_cougar_step_3_shot_hit

  s_ramp_inner_exit_active{current_player.rescue_cougar_step==2}:
    - rescue_cougar_step_3_complete
    - rescue_cougar_step_3_shot_hit

  s_ramp_right_exit_active{current_player.rescue_cougar_step==2}:
    - rescue_cougar_step_3_complete
    - rescue_cougar_step_3_shot_hit

  s_ramp_left_exit_active{current_player.rescue_cougar_step==3}:
    - rescue_cougar_step_4_complete
    - rescue_cougar_step_4_shot_hit

  s_orbit_upper_active{current_player.rescue_cougar_step==3}:
    - rescue_cougar_step_4_complete
    - rescue_cougar_step_4_shot_hit

  s_ramp_inner_exit_active{current_player.rescue_cougar_step==3}:
    - rescue_cougar_step_4_complete
    - rescue_cougar_step_4_shot_hit

  s_ramp_right_exit_active{current_player.rescue_cougar_step==3}:
    - rescue_cougar_step_4_complete
    - rescue_cougar_step_4_shot_hit

  s_ramp_left_exit_active{current_player.rescue_cougar_step==4}:
    - rescue_cougar_step_5_complete
    - rescue_cougar_step_5_shot_hit

  s_orbit_upper_active{current_player.rescue_cougar_step==4}:
    - rescue_cougar_step_5_complete
    - rescue_cougar_step_5_shot_hit

  s_ramp_inner_exit_active{current_player.rescue_cougar_step==4}:
    - rescue_cougar_step_5_complete
    - rescue_cougar_step_5_shot_hit

  s_ramp_right_exit_active{current_player.rescue_cougar_step==4}:
    - rescue_cougar_step_5_complete
    - rescue_cougar_step_5_shot_hit

  # Step 6 - Left Lane
  s_lane_left_active{current_player.rescue_cougar_step==5 and device.timers.rescue_cougar_left_lane_lockout.running==False}:
    - rescue_cougar_step_6_complete
    - rescue_cougar_activate_left_lane_post
    - rescue_cougar_step_6_shot_hit

  # Step 7 - Right Orbit
  right_orbit_shot_hit{current_player.rescue_cougar_step==6 and device.timers.rescue_cougar_right_orbit_lockout.running==False}:
    - rescue_cougar_step_7_complete
    - rescue_cougar_step_7_shot_hit

  # Step 8 - Left Orbit or Spinner
  left_orbit_shot_hit{current_player.rescue_cougar_step==7 and device.timers.rescue_cougar_left_orbit_lockout.running==False}:
    - rescue_cougar_step_8_complete
    - rescue_cougar_step_8_shot_hit

  spinner_shot_made{current_player.rescue_cougar_step==7}:
    - rescue_cougar_step_8_complete
    - rescue_cougar_step_8_shot_hit

  # Step 9 - Upper Orbit or Flight Gear Target
  s_orbit_upper_active{current_player.rescue_cougar_step==8}:
    - rescue_cougar_step_9_complete
    - rescue_cougar_step_9_shot_hit

  s_flight_gear_target_active{current_player.rescue_cougar_step==8}:
    - rescue_cougar_step_9_complete
    - rescue_cougar_step_9_shot_hit

  # Step 10 - Spinner or Tower Ramp
  spinner_shot_made{current_player.rescue_cougar_step==9}:
    - rescue_cougar_step_10_complete
    - rescue_cougar_step_10_shot_hit

  s_ramp_tower_exit_active{current_player.rescue_cougar_step==9}:
    - rescue_cougar_step_10_complete
    - rescue_cougar_step_10_shot_hit

  # Step 11 - Left Orbit or Lower Orbit (FINAL SHOT)
  left_orbit_shot_hit{current_player.rescue_cougar_step==10 and device.timers.rescue_cougar_left_orbit_lockout.running==False}:
    - rescue_cougar_step_11_complete
    - rescue_cougar_step_11_shot_hit
    - rescue_cougar_complete

  s_orbit_lower_active{current_player.rescue_cougar_step==10}:
    - rescue_cougar_step_11_complete
    - rescue_cougar_step_11_shot_hit
    - rescue_cougar_complete

  # MIG post deactivation
  timer_rescue_cougar_left_mig_post_timer_complete:
    - rescue_cougar_deactivate_left_mig_post

  timer_rescue_cougar_right_mig_post_timer_complete:
    - rescue_cougar_deactivate_right_mig_post

  # Left lane post deactivation - also re-enable ball search
  timer_rescue_cougar_left_lane_post_timer_complete:
    - rescue_cougar_deactivate_left_lane_post
    - ball_search_unblock

  # Shot lockout timer completions
  timer_rescue_cougar_left_orbit_lockout_complete:
    - rescue_cougar_left_orbit_available

  timer_rescue_cougar_right_orbit_lockout_complete:
    - rescue_cougar_right_orbit_available

  timer_rescue_cougar_left_lane_lockout_complete:
    - rescue_cougar_left_lane_available

  # Step completion events to set up next step
  rescue_cougar_step_1_complete:
    - rescue_cougar_setup_step_2

  rescue_cougar_step_2_complete:
    - rescue_cougar_setup_step_3

  rescue_cougar_step_3_complete:
    - rescue_cougar_setup_step_4

  rescue_cougar_step_4_complete:
    - rescue_cougar_setup_step_5

  rescue_cougar_step_5_complete:
    - rescue_cougar_setup_step_6
    - left_orbit_diverter_open

  rescue_cougar_step_8_complete:
    - rescue_cougar_setup_step_9

  rescue_cougar_step_9_complete:
    - rescue_cougar_setup_step_10

  rescue_cougar_step_10_complete:
    - rescue_cougar_setup_step_11

  ##############################################
  ## MISSILE PERK - Auto-complete current step
  ## Fires step_complete + step_shot_hit for current step
  ## Step chains in event_player handle setup_next_step automatically
  ## NOTE: MIG posts and left lane post are NOT activated by missiles
  ##############################################

  missiles_perk_complete_shot{current_player.rescue_cougar_step==0 and current_player.rescue_cougar_complete_flag==0}:
    - rescue_cougar_step_1_complete
    - rescue_cougar_step_1_shot_hit

  missiles_perk_complete_shot{current_player.rescue_cougar_step==1 and current_player.rescue_cougar_complete_flag==0}:
    - rescue_cougar_step_2_complete
    - rescue_cougar_step_2_shot_hit

  missiles_perk_complete_shot{current_player.rescue_cougar_step==2 and current_player.rescue_cougar_complete_flag==0}:
    - rescue_cougar_step_3_complete
    - rescue_cougar_step_3_shot_hit

  missiles_perk_complete_shot{current_player.rescue_cougar_step==3 and current_player.rescue_cougar_complete_flag==0}:
    - rescue_cougar_step_4_complete
    - rescue_cougar_step_4_shot_hit

  missiles_perk_complete_shot{current_player.rescue_cougar_step==4 and current_player.rescue_cougar_complete_flag==0}:
    - rescue_cougar_step_5_complete
    - rescue_cougar_step_5_shot_hit

  missiles_perk_complete_shot{current_player.rescue_cougar_step==5 and current_player.rescue_cougar_complete_flag==0}:
    - rescue_cougar_step_6_complete
    - rescue_cougar_step_6_shot_hit

  missiles_perk_complete_shot{current_player.rescue_cougar_step==6 and current_player.rescue_cougar_complete_flag==0}:
    - rescue_cougar_step_7_complete
    - rescue_cougar_step_7_shot_hit

  missiles_perk_complete_shot{current_player.rescue_cougar_step==7 and current_player.rescue_cougar_complete_flag==0}:
    - rescue_cougar_step_8_complete
    - rescue_cougar_step_8_shot_hit

  missiles_perk_complete_shot{current_player.rescue_cougar_step==8 and current_player.rescue_cougar_complete_flag==0}:
    - rescue_cougar_step_9_complete
    - rescue_cougar_step_9_shot_hit

  missiles_perk_complete_shot{current_player.rescue_cougar_step==9 and current_player.rescue_cougar_complete_flag==0}:
    - rescue_cougar_step_10_complete
    - rescue_cougar_step_10_shot_hit

  missiles_perk_complete_shot{current_player.rescue_cougar_step==10 and current_player.rescue_cougar_complete_flag==0}:
    - rescue_cougar_step_11_complete
    - rescue_cougar_step_11_shot_hit
    - rescue_cougar_complete

  # Mode completion and failure - start delay timers
  rescue_cougar_complete:
    - rescue_cougar_cleanup
    - timer_rescue_cougar_complete_delay_start
    - left_orbit_diverter_closed
    - missiles_perk_unload

  rescue_cougar_failed:
    - rescue_cougar_cleanup
    - timer_rescue_cougar_failed_delay_start
    - left_orbit_diverter_closed
    - missiles_perk_unload
  
  # Post completion/failure events after videos finish (for base mode to use)
  timer_rescue_cougar_complete_delay_complete:
    - rescue_cougar_video_complete
    - pilot_mode_cleanup_complete
  
  timer_rescue_cougar_failed_delay_complete:
    - rescue_cougar_video_complete
    - pilot_mode_cleanup_complete
  
  # Skip left lane post hold with both flippers (player can skip if they want)
  s_flipper_left_active{device.switches.s_flipper_right.state and device.timers.rescue_cougar_left_lane_post_timer.running}:
    - rescue_cougar_skip_left_lane_post
  
  s_flipper_right_active{device.switches.s_flipper_left.state and device.timers.rescue_cougar_left_lane_post_timer.running}:
    - rescue_cougar_skip_left_lane_post
  
  rescue_cougar_skip_left_lane_post:
    - timer_rescue_cougar_left_lane_post_timer_stop
    - rescue_cougar_deactivate_left_lane_post
    - ball_search_unblock   # Re-enable ball search when post drops

  # Ball search control - disable when post holds ball, re-enable when released
  rescue_cougar_activate_left_lane_post:
    - timer_rescue_cougar_left_lane_lockout_start
    - left_orbit_diverter_closed
    - ball_search_block  # Prevent ball search while ball is held on post

  # Additional events for post activations with lockout timers
  # Post timers now auto-start via control_events when these events fire
  rescue_cougar_activate_left_mig_post:
    - timer_rescue_cougar_right_orbit_lockout_start

  rescue_cougar_activate_right_mig_post:
    - timer_rescue_cougar_left_orbit_lockout_start

  ##############################################
  ## SERVO EVENTS - Control ramp servo positions
  ## These events trigger the servos defined in config_servos.yaml
  ##############################################
  
  # Ball released from scoop - raise right ramp for steps 1-2
  rescue_cougar_ball_released:
    - right_ramp_up
  
  # Step 3 setup - lower right ramp (steps 3-5 use other shots)
  rescue_cougar_setup_step_3:
    - right_ramp_down
  
  # Step 6 setup - raise right ramp (for left lane shot)
  rescue_cougar_setup_step_6:
    - right_ramp_up
  
  # Step 7 shot hit - lower right ramp
  rescue_cougar_step_7_shot_hit:
    - right_ramp_down
  
  # Step 11 setup - raise top/inner ramp
  rescue_cougar_setup_step_11:
    - top_ramp_up
  
  # Mode cleanup - ensure ramps are lowered and ball search is re-enabled
  rescue_cougar_cleanup:
    - right_ramp_down
    - top_ramp_down
    - ball_search_unblock  # Re-enable ball search in case it was disabled

####################################################################################
# SHOW PLAYER - Light Shows Only (Videos should use video_player)
####################################################################################

#show_player:
  #   mode_rescue_cougar_started:
    #     rescue_cougar_main_video:
    #       loops: -1  # Loop main video
    #       priority: 1000
    # rescue_cougar_main_show:  # Uncomment when light show is ready
    #   loops: -1
    #   priority: 1000

  # Step completion videos and shows (commented out until created)
  # rescue_cougar_step_1_shot_hit:
  #   rescue_cougar_step_1:
  #     priority: 2000
  #   rescue_cougar_step_1_show:
  #     priority: 2000

  # rescue_cougar_step_2_shot_hit:
  #   rescue_cougar_step_2:
  #     priority: 2000
  #   rescue_cougar_step_2_show:
  #     priority: 2000

  # rescue_cougar_step_3_shot_hit:
  #   rescue_cougar_step_3:
  #     priority: 2000
  #   rescue_cougar_step_3_show:
  #     priority: 2000

  # rescue_cougar_step_4_shot_hit:
  #   rescue_cougar_step_4:
  #     priority: 2000
  #   rescue_cougar_step_4_show:
  #     priority: 2000

  # rescue_cougar_step_5_shot_hit:
  #   rescue_cougar_step_5:
  #     priority: 2000
  #   rescue_cougar_step_5_show:
  #     priority: 2000

  # rescue_cougar_step_6_shot_hit:
  #   rescue_cougar_step_6:
  #     priority: 2000
  #   rescue_cougar_step_6_show:
  #     priority: 2000

  # rescue_cougar_step_7_shot_hit:
  #   rescue_cougar_step_7:
  #     priority: 2000
  #   rescue_cougar_step_7_show:
  #     priority: 2000

  # rescue_cougar_step_8_shot_hit:
  #   rescue_cougar_step_8:
  #     priority: 2000
  #   rescue_cougar_step_8_show:
  #     priority: 2000

  # rescue_cougar_step_9_shot_hit:
  #   rescue_cougar_step_9:
  #     priority: 2000
  #   rescue_cougar_step_9_show:
  #     priority: 2000

  # rescue_cougar_step_10_shot_hit:
  #   rescue_cougar_step_10:
  #     priority: 2000
  #   rescue_cougar_step_10_show:
  #     priority: 2000

  # rescue_cougar_step_11_shot_hit:
  #   rescue_cougar_step_11:
  #     priority: 2000
  #   rescue_cougar_step_11_show:
  #     priority: 2000

  # Mode won video and show
  #   rescue_cougar_complete:
    #     rescue_cougar_main_video:
    #       action: stop
    # rescue_cougar_won_video:  # Uncomment when video is ready
    #   priority: 3000
    # rescue_cougar_won_show:  # Uncomment when light show is ready
    #   priority: 3000

  # Mode failed video
  #   rescue_cougar_failed:
    #     rescue_cougar_main_video:
    #       action: stop
    # rescue_cougar_lost_video:  # Uncomment when video is ready
    #   priority: 3000

####################################################################################
# SOUND PLAYER - Delay base music restart until after win/loss video
####################################################################################

sound_player:
  # Play silence during win/loss videos so base music doesn't interfere
  rescue_cougar_complete:
    silence:
      bus: music
      loops: 0
  
  rescue_cougar_failed:
    silence:
      bus: music
      loops: 0

####################################################################################
# SHOWS - Flashing light patterns
####################################################################################

shows:
  # NOTE: flash_green and flash_red removed - now using sync_flash_mode from base.yaml
  
  # GI blue flash - quick flash on shot hits (2 flashes over 500ms)
  # NOTE: GI lights require hex codes, not color names (MPF bug workaround)
  # Includes apron lights which may not be in gi_lights tag
  rescue_cougar_gi_flash:
    - duration: 125ms
      lights:
        (led):
          color: 0000FF
          fade: 0ms
        l_apron_light_1:
          color: 0000FF
          fade: 0ms
        l_apron_light_2:
          color: 0000FF
          fade: 0ms
        l_apron_light_3:
          color: 0000FF
          fade: 0ms
        l_apron_light_4:
          color: 0000FF
          fade: 0ms
    - duration: 125ms
      lights:
        (led):
          color: off
          fade: 0ms
        l_apron_light_1:
          color: off
          fade: 0ms
        l_apron_light_2:
          color: off
          fade: 0ms
        l_apron_light_3:
          color: off
          fade: 0ms
        l_apron_light_4:
          color: off
          fade: 0ms
    - duration: 125ms
      lights:
        (led):
          color: 0000FF
          fade: 0ms
        l_apron_light_1:
          color: 0000FF
          fade: 0ms
        l_apron_light_2:
          color: 0000FF
          fade: 0ms
        l_apron_light_3:
          color: 0000FF
          fade: 0ms
        l_apron_light_4:
          color: 0000FF
          fade: 0ms
    - duration: 125ms
      lights:
        (led):
          color: off
          fade: 0ms
        l_apron_light_1:
          color: off
          fade: 0ms
        l_apron_light_2:
          color: off
          fade: 0ms
        l_apron_light_3:
          color: off
          fade: 0ms
        l_apron_light_4:
          color: off
          fade: 0ms

####################################################################################
# SHOW PLAYER - Control flashing lights for mode shots
####################################################################################

show_player:
  ##############################################
  ## STEP 1-2: Left and Right Orbit (GREEN)
  ## Uses sync_flash_mode from base.yaml with sync_ms for multiball stacking
  ##############################################
  rescue_cougar_setup_shots:
    left_orbit_mode_flash:
      show: sync_flash_mode
      key: mode_l_shot_left_orbit
      sync_ms: 1000
      loops: -1
      show_tokens:
        led: l_shot_left_orbit
        color: 00FF00
    right_orbit_mode_flash:
      show: sync_flash_mode
      key: mode_l_shot_right_orbit
      sync_ms: 1000
      loops: -1
      show_tokens:
        led: l_shot_right_orbit
        color: 00FF00

  rescue_cougar_setup_step_2:
    left_orbit_mode_flash:
      show: sync_flash_mode
      key: mode_l_shot_left_orbit
      sync_ms: 1000
      loops: -1
      show_tokens:
        led: l_shot_left_orbit
        color: 00FF00
    right_orbit_mode_flash:
      show: sync_flash_mode
      key: mode_l_shot_right_orbit
      sync_ms: 1000
      loops: -1
      show_tokens:
        led: l_shot_right_orbit
        color: 00FF00

  # Stop orbit flashing when shots are hit (steps 1-2)
  left_orbit_shot_hit{current_player.rescue_cougar_step==0 or current_player.rescue_cougar_step==1}:
    stop_left_orbit:
      show: sync_flash_mode
      action: stop
      key: mode_l_shot_left_orbit

  right_orbit_shot_hit{current_player.rescue_cougar_step==0 or current_player.rescue_cougar_step==1}:
    stop_right_orbit:
      show: sync_flash_mode
      action: stop
      key: mode_l_shot_right_orbit

  ##############################################
  ## STEP 3-5: Ramps and Orbits (RED)
  ##############################################
  rescue_cougar_setup_step_3:
    # Stop green flashing from previous steps
    stop_left_orbit:
      show: sync_flash_mode
      action: stop
      key: mode_l_shot_left_orbit
    stop_right_orbit:
      show: sync_flash_mode
      action: stop
      key: mode_l_shot_right_orbit
    # Start red flashing for new shots
    left_ramp_mode_flash:
      show: sync_flash_mode
      key: mode_l_shot_left_ramp
      sync_ms: 1000
      loops: -1
      show_tokens:
        led: l_shot_left_ramp
        color: FF0000
    upper_orbit_mode_flash:
      show: sync_flash_mode
      key: mode_l_shot_upper_orbit
      sync_ms: 1000
      loops: -1
      show_tokens:
        led: l_shot_upper_orbit
        color: FF0000
    middle_ramp_mode_flash:
      show: sync_flash_mode
      key: mode_l_shot_middle_ramp
      sync_ms: 1000
      loops: -1
      show_tokens:
        led: l_shot_middle_ramp
        color: FF0000
    right_orbit_red_flash:
      show: sync_flash_mode
      key: mode_l_shot_right_orbit
      sync_ms: 1000
      loops: -1
      show_tokens:
        led: l_shot_right_orbit
        color: FF0000

  rescue_cougar_setup_step_4:
    left_ramp_mode_flash:
      show: sync_flash_mode
      key: mode_l_shot_left_ramp
      sync_ms: 1000
      loops: -1
      show_tokens:
        led: l_shot_left_ramp
        color: FF0000
    upper_orbit_mode_flash:
      show: sync_flash_mode
      key: mode_l_shot_upper_orbit
      sync_ms: 1000
      loops: -1
      show_tokens:
        led: l_shot_upper_orbit
        color: FF0000
    middle_ramp_mode_flash:
      show: sync_flash_mode
      key: mode_l_shot_middle_ramp
      sync_ms: 1000
      loops: -1
      show_tokens:
        led: l_shot_middle_ramp
        color: FF0000
    right_orbit_red_flash:
      show: sync_flash_mode
      key: mode_l_shot_right_orbit
      sync_ms: 1000
      loops: -1
      show_tokens:
        led: l_shot_right_orbit
        color: FF0000

  rescue_cougar_setup_step_5:
    left_ramp_mode_flash:
      show: sync_flash_mode
      key: mode_l_shot_left_ramp
      sync_ms: 1000
      loops: -1
      show_tokens:
        led: l_shot_left_ramp
        color: FF0000
    upper_orbit_mode_flash:
      show: sync_flash_mode
      key: mode_l_shot_upper_orbit
      sync_ms: 1000
      loops: -1
      show_tokens:
        led: l_shot_upper_orbit
        color: FF0000
    middle_ramp_mode_flash:
      show: sync_flash_mode
      key: mode_l_shot_middle_ramp
      sync_ms: 1000
      loops: -1
      show_tokens:
        led: l_shot_middle_ramp
        color: FF0000
    right_orbit_red_flash:
      show: sync_flash_mode
      key: mode_l_shot_right_orbit
      sync_ms: 1000
      loops: -1
      show_tokens:
        led: l_shot_right_orbit
        color: FF0000

  ##############################################
  ## STEP 6: Left Lane (GREEN)
  ##############################################
  rescue_cougar_setup_step_6:
    # Stop red flashing from previous steps
    stop_left_ramp:
      show: sync_flash_mode
      action: stop
      key: mode_l_shot_left_ramp
    stop_upper_orbit:
      show: sync_flash_mode
      action: stop
      key: mode_l_shot_upper_orbit
    stop_middle_ramp:
      show: sync_flash_mode
      action: stop
      key: mode_l_shot_middle_ramp
    stop_right_orbit:
      show: sync_flash_mode
      action: stop
      key: mode_l_shot_right_orbit
    # Start left lane flash
    left_lane_mode_flash:
      show: sync_flash_mode
      key: mode_l_shot_left_lane
      sync_ms: 1000
      loops: -1
      show_tokens:
        led: l_shot_left_lane
        color: 00FF00

  ##############################################
  ## STEP 7: Right Orbit (GREEN)
  ##############################################
  rescue_cougar_setup_step_7:
    stop_left_lane:
      show: sync_flash_mode
      action: stop
      key: mode_l_shot_left_lane
    right_orbit_mode_flash:
      show: sync_flash_mode
      key: mode_l_shot_right_orbit
      sync_ms: 1000
      loops: -1
      show_tokens:
        led: l_shot_right_orbit
        color: 00FF00

  ##############################################
  ## STEP 8: Left Orbit + Spinner (GREEN)
  ##############################################
  rescue_cougar_setup_step_8:
    stop_right_orbit:
      show: sync_flash_mode
      action: stop
      key: mode_l_shot_right_orbit
    left_orbit_mode_flash:
      show: sync_flash_mode
      key: mode_l_shot_left_orbit
      sync_ms: 1000
      loops: -1
      show_tokens:
        led: l_shot_left_orbit
        color: 00FF00
    spinner_mode_flash:
      show: sync_flash_mode
      key: mode_l_shot_spinner
      sync_ms: 1000
      loops: -1
      show_tokens:
        led: l_shot_spinner
        color: 00FF00

  ##############################################
  ## STEP 9: Upper Orbit + Pilot Gear (GREEN)
  ##############################################
  rescue_cougar_setup_step_9:
    stop_left_orbit:
      show: sync_flash_mode
      action: stop
      key: mode_l_shot_left_orbit
    stop_spinner:
      show: sync_flash_mode
      action: stop
      key: mode_l_shot_spinner
    upper_orbit_mode_flash:
      show: sync_flash_mode
      key: mode_l_shot_upper_orbit
      sync_ms: 1000
      loops: -1
      show_tokens:
        led: l_shot_upper_orbit
        color: 00FF00
    pilot_gear_mode_flash:
      show: sync_flash_mode
      key: mode_l_shot_pilot_gear
      sync_ms: 1000
      loops: -1
      show_tokens:
        led: l_shot_pilot_gear
        color: 00FF00

  ##############################################
  ## STEP 10: Spinner + Tower Ramp (GREEN)
  ##############################################
  rescue_cougar_setup_step_10:
    stop_upper_orbit:
      show: sync_flash_mode
      action: stop
      key: mode_l_shot_upper_orbit
    stop_pilot_gear:
      show: sync_flash_mode
      action: stop
      key: mode_l_shot_pilot_gear
    spinner_mode_flash:
      show: sync_flash_mode
      key: mode_l_shot_spinner
      sync_ms: 1000
      loops: -1
      show_tokens:
        led: l_shot_spinner
        color: 00FF00
    tower_ramp_mode_flash:
      show: sync_flash_mode
      key: mode_l_shot_tower_ramp
      sync_ms: 1000
      loops: -1
      show_tokens:
        led: l_shot_tower_ramp
        color: 00FF00

  ##############################################
  ## STEP 11: Left Orbit + Middle Ramp (GREEN) - FINAL
  ##############################################
  rescue_cougar_setup_step_11:
    stop_spinner:
      show: sync_flash_mode
      action: stop
      key: mode_l_shot_spinner
    stop_tower_ramp:
      show: sync_flash_mode
      action: stop
      key: mode_l_shot_tower_ramp
    left_orbit_mode_flash:
      show: sync_flash_mode
      key: mode_l_shot_left_orbit
      sync_ms: 1000
      loops: -1
      show_tokens:
        led: l_shot_left_orbit
        color: 00FF00
    middle_ramp_mode_flash:
      show: sync_flash_mode
      key: mode_l_shot_middle_ramp
      sync_ms: 1000
      loops: -1
      show_tokens:
        led: l_shot_middle_ramp
        color: 00FF00

  ##############################################
  ## MODE END - Stop all flashing
  ##############################################
  rescue_cougar_complete:
    stop_all_1:
      show: sync_flash_mode
      action: stop
      key: mode_l_shot_left_orbit
    stop_all_2:
      show: sync_flash_mode
      action: stop
      key: mode_l_shot_right_orbit
    stop_all_3:
      show: sync_flash_mode
      action: stop
      key: mode_l_shot_left_ramp
    stop_all_4:
      show: sync_flash_mode
      action: stop
      key: mode_l_shot_upper_orbit
    stop_all_5:
      show: sync_flash_mode
      action: stop
      key: mode_l_shot_middle_ramp
    stop_all_6:
      show: sync_flash_mode
      action: stop
      key: mode_l_shot_left_lane
    stop_all_7:
      show: sync_flash_mode
      action: stop
      key: mode_l_shot_spinner
    stop_all_8:
      show: sync_flash_mode
      action: stop
      key: mode_l_shot_pilot_gear
    stop_all_9:
      show: sync_flash_mode
      action: stop
      key: mode_l_shot_tower_ramp

  rescue_cougar_failed:
    stop_fail_1:
      show: sync_flash_mode
      action: stop
      key: mode_l_shot_left_orbit
    stop_fail_2:
      show: sync_flash_mode
      action: stop
      key: mode_l_shot_right_orbit
    stop_fail_3:
      show: sync_flash_mode
      action: stop
      key: mode_l_shot_left_ramp
    stop_fail_4:
      show: sync_flash_mode
      action: stop
      key: mode_l_shot_upper_orbit
    stop_fail_5:
      show: sync_flash_mode
      action: stop
      key: mode_l_shot_middle_ramp
    stop_fail_6:
      show: sync_flash_mode
      action: stop
      key: mode_l_shot_left_lane
    stop_fail_7:
      show: sync_flash_mode
      action: stop
      key: mode_l_shot_spinner
    stop_fail_8:
      show: sync_flash_mode
      action: stop
      key: mode_l_shot_pilot_gear
    stop_fail_9:
      show: sync_flash_mode
      action: stop
      key: mode_l_shot_tower_ramp

  ##############################################
  ## GI FLASH - Flash GI blue on each shot hit
  ##############################################
  rescue_cougar_step_1_shot_hit:
    gi_flash:
      show: rescue_cougar_gi_flash
      key: gi_effect
      loops: 0
      show_tokens:
        led: gi_lights

  rescue_cougar_step_2_shot_hit:
    gi_flash:
      show: rescue_cougar_gi_flash
      key: gi_effect
      loops: 0
      show_tokens:
        led: gi_lights

  rescue_cougar_step_3_shot_hit:
    gi_flash:
      show: rescue_cougar_gi_flash
      key: gi_effect
      loops: 0
      show_tokens:
        led: gi_lights

  rescue_cougar_step_4_shot_hit:
    gi_flash:
      show: rescue_cougar_gi_flash
      key: gi_effect
      loops: 0
      show_tokens:
        led: gi_lights

  rescue_cougar_step_5_shot_hit:
    gi_flash:
      show: rescue_cougar_gi_flash
      key: gi_effect
      loops: 0
      show_tokens:
        led: gi_lights

  rescue_cougar_step_6_shot_hit:
    gi_flash:
      show: rescue_cougar_gi_flash
      key: gi_effect
      loops: 0
      show_tokens:
        led: gi_lights

  rescue_cougar_step_7_shot_hit:
    gi_flash:
      show: rescue_cougar_gi_flash
      key: gi_effect
      loops: 0
      show_tokens:
        led: gi_lights

  rescue_cougar_step_8_shot_hit:
    gi_flash:
      show: rescue_cougar_gi_flash
      key: gi_effect
      loops: 0
      show_tokens:
        led: gi_lights

  rescue_cougar_step_9_shot_hit:
    gi_flash:
      show: rescue_cougar_gi_flash
      key: gi_effect
      loops: 0
      show_tokens:
        led: gi_lights

  rescue_cougar_step_10_shot_hit:
    gi_flash:
      show: rescue_cougar_gi_flash
      key: gi_effect
      loops: 0
      show_tokens:
        led: gi_lights

  rescue_cougar_step_11_shot_hit:
    gi_flash:
      show: rescue_cougar_gi_flash
      key: gi_effect
      loops: 0
      show_tokens:
        led: gi_lights

####################################################################################
# LIGHT PLAYER - GI and Shot Lights
####################################################################################

light_player:
  # Mode start - Change GI to Blue and set mode lights
  mode_rescue_cougar_started:
    gi_lights:
      color: blue
      fade: 0ms
    l_mode_rescue_cougar:
      color: white
      fade: 0ms
    l_pilot_mission_lit:
      color: off

  # Initial shot setup (Steps 1 & 2) - Flash handled by show_player

  # Step 2 setup (one orbit already hit) - Flash handled by show_player

  # Step 1 shot hits - turn off the shot that was made
  left_orbit_shot_hit{current_player.rescue_cougar_step==0}:
    l_shot_left_orbit:
      color: off

  right_orbit_shot_hit{current_player.rescue_cougar_step==0}:
    l_shot_right_orbit:
      color: off

  # Step 2 shot hits - turn off the shot that was made
  left_orbit_shot_hit{current_player.rescue_cougar_step==1}:
    l_shot_left_orbit:
      color: off

  right_orbit_shot_hit{current_player.rescue_cougar_step==1}:
    l_shot_right_orbit:
      color: off

  # Step 3 setup (Steps 3, 4, 5) - Turn off previous step lights, flash handled by show_player
  rescue_cougar_setup_step_3:
    # Turn off orbit lights from steps 1 & 2
    l_shot_left_orbit:
      color: off

  # Step 3 shot hits - turn off shots as they're made
  s_ramp_left_exit_active{current_player.rescue_cougar_step==2}:
    l_shot_left_ramp:
      color: off

  s_orbit_upper_active{current_player.rescue_cougar_step==2}:
    l_shot_upper_orbit:
      color: off

  s_ramp_inner_exit_active{current_player.rescue_cougar_step==2}:
    l_shot_middle_ramp:
      color: off

  s_ramp_right_exit_active{current_player.rescue_cougar_step==2}:
    l_shot_right_orbit:
      color: off

  # Step 4 setup - continue with remaining ramp shots
  rescue_cougar_setup_step_4:
    l_shot_left_ramp:
      color: red
      fade: 0ms
    l_shot_upper_orbit:
      color: red
      fade: 0ms
    l_shot_middle_ramp:
      color: red
      fade: 0ms
    l_shot_right_orbit:
      color: red
      fade: 0ms

  # Step 4 shot hits
  s_ramp_left_exit_active{current_player.rescue_cougar_step==3}:
    l_shot_left_ramp:
      color: off

  s_orbit_upper_active{current_player.rescue_cougar_step==3}:
    l_shot_upper_orbit:
      color: off

  s_ramp_inner_exit_active{current_player.rescue_cougar_step==3}:
    l_shot_middle_ramp:
      color: off

  s_ramp_right_exit_active{current_player.rescue_cougar_step==3}:
    l_shot_right_orbit:
      color: off

  # Step 5 setup
  rescue_cougar_setup_step_5:
    l_shot_left_ramp:
      color: red
      fade: 0ms
    l_shot_upper_orbit:
      color: red
      fade: 0ms
    l_shot_middle_ramp:
      color: red
      fade: 0ms
    l_shot_right_orbit:
      color: red
      fade: 0ms

  # Step 5 shot hits
  s_ramp_left_exit_active{current_player.rescue_cougar_step==4}:
    l_shot_left_ramp:
      color: off

  s_orbit_upper_active{current_player.rescue_cougar_step==4}:
    l_shot_upper_orbit:
      color: off

  s_ramp_inner_exit_active{current_player.rescue_cougar_step==4}:
    l_shot_middle_ramp:
      color: off

  s_ramp_right_exit_active{current_player.rescue_cougar_step==4}:
    l_shot_right_orbit:
      color: off

  # Step 6 setup - Left lane (turn off previous step lights)
  rescue_cougar_setup_step_6:
    # Turn off ramp/orbit lights from steps 3-5
    l_shot_left_ramp:
      color: off
    l_shot_upper_orbit:
      color: off
    l_shot_middle_ramp:
      color: off
    l_shot_right_orbit:
      color: off
    # Setup step 6 light
    l_shot_left_lane:
      color: green
      fade: 0ms

  # Step 6 shot hit
  s_lane_left_active{current_player.rescue_cougar_step==5}:
    l_shot_left_lane:
      color: off

  # Step 7 setup - Right orbit (turn off left lane from step 6)
  rescue_cougar_setup_step_7:
    l_shot_left_lane:
      color: off
    # Right orbit flashes via show_player

  # Step 7 shot hit
  right_orbit_shot_hit{current_player.rescue_cougar_step==6}:
    l_shot_right_orbit:
      color: off

  # Step 8 setup - Left orbit and spinner flash green, Left ramp (red indicator, not active)
  rescue_cougar_setup_step_8:
    # Turn off right orbit from step 7
    l_shot_right_orbit:
      color: off
    # Left orbit and spinner flash via show_player
    # Red indicator light (not flashing)
    l_shot_left_ramp:
      color: red
      fade: 0ms

  # Step 8 shot hits
  left_orbit_shot_hit{current_player.rescue_cougar_step==7}:
    l_shot_left_orbit:
      color: off
    l_shot_spinner:
      color: off
    l_shot_left_ramp:
      color: off

  spinner_shot_made{current_player.rescue_cougar_step==7}:
    l_shot_left_orbit:
      color: off
    l_shot_spinner:
      color: off
    l_shot_left_ramp:
      color: off

  # Step 9 setup - Upper orbit and pilot gear flash green, middle ramp (red indicator, not active)
  rescue_cougar_setup_step_9:
    # Turn off left orbit, spinner, left ramp from step 8
    l_shot_left_orbit:
      color: off
    l_shot_spinner:
      color: off
    l_shot_left_ramp:
      color: off
    # Upper orbit and pilot gear flash via show_player
    # Red indicator light (not flashing)
    l_shot_middle_ramp:
      color: red
      fade: 0ms

  # Step 9 shot hits
  s_orbit_upper_active{current_player.rescue_cougar_step==8}:
    l_shot_upper_orbit:
      color: off
    l_shot_pilot_gear:
      color: off
    l_shot_middle_ramp:
      color: off

  s_flight_gear_target_active{current_player.rescue_cougar_step==8}:
    l_shot_upper_orbit:
      color: off
    l_shot_pilot_gear:
      color: off
    l_shot_middle_ramp:
      color: off

  # Step 10 setup - Spinner and tower ramp flash green, barrier (red indicator, not active)
  rescue_cougar_setup_step_10:
    # Turn off upper orbit, pilot gear, middle ramp from step 9
    l_shot_upper_orbit:
      color: off
    l_shot_pilot_gear:
      color: off
    l_shot_middle_ramp:
      color: off
    # Spinner and tower ramp flash via show_player
    # Red indicator light (not flashing)
    l_shot_barrier:
      color: red
      fade: 0ms

  # Step 10 shot hits
  spinner_shot_made{current_player.rescue_cougar_step==9}:
    l_shot_spinner:
      color: off
    l_shot_tower_ramp:
      color: off
    l_shot_barrier:
      color: off

  s_ramp_tower_exit_active{current_player.rescue_cougar_step==9}:
    l_shot_spinner:
      color: off
    l_shot_tower_ramp:
      color: off
    l_shot_barrier:
      color: off

  # Step 11 setup - Left orbit and middle ramp (FINAL)
  rescue_cougar_setup_step_11:
    # Turn off spinner, tower ramp, barrier from step 10
    l_shot_spinner:
      color: off
    l_shot_tower_ramp:
      color: off
    l_shot_barrier:
      color: off
    # Left orbit and middle ramp flash via show_player

  # Step 11 shot hits
  left_orbit_shot_hit{current_player.rescue_cougar_step==10}:
    l_shot_left_orbit:
      color: off
    l_shot_middle_ramp:
      color: off

  s_orbit_lower_active{current_player.rescue_cougar_step==10}:
    l_shot_left_orbit:
      color: off
    l_shot_middle_ramp:
      color: off

  # Mode cleanup - restore base GI
  rescue_cougar_cleanup:
    gi_lights:
      color: white  # Restore to base mode color
      fade: 0ms
    l_mode_rescue_cougar:
      color: white  # Keep lit solid after completion
    # Turn off all active shot lights
    l_shot_left_orbit:
      color: off
    l_shot_right_orbit:
      color: off
    l_shot_left_ramp:
      color: off
    l_shot_middle_ramp:
      color: off
    l_shot_upper_orbit:
      color: off
    l_shot_tower_ramp:
      color: off
    l_shot_spinner:
      color: off
    l_shot_pilot_gear:
      color: off
    l_shot_barrier:
      color: off
    l_shot_left_lane:
      color: off

####################################################################################
# COIL PLAYER - Ramp Lifts, Diverters, and Posts
####################################################################################

coil_player:
  # NOTE: Right ramp and top ramp are controlled by servos via event_player
  # Servo events: right_ramp_up, right_ramp_down, top_ramp_up, top_ramp_down

  # Step 1 and 2 - MIG post activations (2 second hold)
  rescue_cougar_activate_left_mig_post:
    c_left_mig_up_post:
      action: enable

  rescue_cougar_activate_right_mig_post:
    c_right_mig_up_post:
      action: enable

  rescue_cougar_deactivate_left_mig_post:
    c_left_mig_up_post:
      action: disable

  rescue_cougar_deactivate_right_mig_post:
    c_right_mig_up_post:
      action: disable

  # Step 6 - Open left diverter (ramp handled by servo event right_ramp_up)
  rescue_cougar_setup_step_6:
    c_left_orbit_diverter:
      action: enable

  # Step 6 - Left lane post activation and close left diverter
  rescue_cougar_activate_left_lane_post:
    c_left_lane_up_post:
      action: enable
    c_left_orbit_diverter:
      action: disable

  rescue_cougar_deactivate_left_lane_post:
    c_left_lane_up_post:
      action: disable

  # Step 7 - Close right diverter (ramp handled by servo event right_ramp_down)
  rescue_cougar_step_7_shot_hit:
    c_right_orbit_diverter:
      action: disable

  # Step 7 - Open right diverter for right orbit shot
  rescue_cougar_setup_step_7:
    c_right_orbit_diverter:
      action: enable

  # Step 11 - Top ramp handled by servo event (top_ramp_up) in event_player above

  # Mode cleanup - Turn off all coils
  # NOTE: c_left_lane_up_post is NOT disabled here - let left_lane_post_timer handle it
  # This ensures the post stays up to catch the ball even if mode fails/times out
  # NOTE: Ramp lifters controlled by servo events (right_ramp_down, top_ramp_down) in event_player
  rescue_cougar_cleanup:
    c_left_orbit_diverter:
      action: disable
    c_right_orbit_diverter:
      action: disable
    c_left_mig_up_post:
      action: disable
    c_right_mig_up_post:
      action: disable

  # Safety - disable left_lane_up_post when mode actually stops
  # This catches the case where the mode ends before left_lane_post_timer completes
  mode_rescue_cougar_stopping:
    c_left_lane_up_post:
      action: disable


# Adjustable Timing Values:
# - Mode timer: 90 seconds (line 59)
# - Barrier delay: 500ms (line 71)
# - MIG post hold: 2 seconds (lines 82, 88)
# - Left lane post hold: 3 seconds (line 95)
# - Shot lockout timers: 2-3 seconds (lines 102, 108, 114)
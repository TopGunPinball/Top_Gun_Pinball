#config_version=6

##
## Pilot Mission Modes - Pure YAML
## Letters display based on shot COUNT, not specific shots
## Mode tracking with pulsing for available, solid for completed
## Mode rotation on spinner or flight_gear_target switch hits
##
## IMPORTANT: This mode stops when base mode stops (mode_base_stopped).
## Since base mode now stops on ball_ending (held by pilot mode queue_relay_player),
## this mode stays alive long enough to receive mode_xxx_stopped events from
## pilot missions and properly clear the letter_collection_paused flag.
##

mode:
  start_events: mode_base_started
  stop_events: mode_base_stopped
  priority: 200
  game_mode: true

##############################################
## SPINNER SHOT LOGIC
## A "spinner shot" requires 3 spins within 2 seconds.
## This prevents single weak spins from counting as shots,
## while still allowing fast spinning to progress modes.
##############################################

timers:
  spinner_shot_timeout:
    start_value: 0
    end_value: 2
    direction: up
    tick_interval: 1s
    control_events:
      - action: restart
        event: s_spinner_active
  
  # Spinner lockout - prevents rapid re-triggering after shot fires
  spinner_shot_lockout:
    start_value: 0
    end_value: 2
    direction: up
    tick_interval: 1s
    control_events:
      - action: restart
        event: spinner_shot_made

  ##############################################
  ## ORBIT SHOT TIMERS
  ## Orbit shots require entry switch then exit switch within 3 seconds
  ## Left orbit: s_orbit_left -> s_orbit_right
  ## Right orbit: s_orbit_right -> s_orbit_left
  ## NOTE: No orbit_pending variable - just use timer.running checks
  ## IMPORTANT: Use 'restart' action so timer resets each time!
  ##############################################
  
  left_orbit_shot_timeout:
    start_value: 0
    end_value: 3
    direction: up
    tick_interval: 1s
    control_events:
      - action: restart
        event: s_orbit_left_active
  
  right_orbit_shot_timeout:
    start_value: 0
    end_value: 3
    direction: up
    tick_interval: 1s
    control_events:
      - action: restart
        event: s_orbit_right_active



slide_player:
  # Show initial slide when mode starts - ONLY if not qualified
  mode_pilot_mission_qualifier_started{current_player.topgun_shots_collected==0 and current_player.qualified_mode_number==0}:
    topgun_0:
      action: play
      priority: 200
  
  # Show slide for pre-lit letters - ONLY if not qualified
  mode_pilot_mission_qualifier_started{current_player.topgun_shots_collected==3 and current_player.qualified_mode_number==0}:
    topgun_3:
      action: play
      priority: 200
  
  mode_pilot_mission_qualifier_started{current_player.topgun_shots_collected==2 and current_player.qualified_mode_number==0}:
    topgun_2:
      action: play
      priority: 200
  
  mode_pilot_mission_qualifier_started{current_player.topgun_shots_collected==1 and current_player.qualified_mode_number==0}:
    topgun_1:
      action: play
      priority: 200
  
  # If qualified and have completed all 6 letters, show topgun_6 on ball start
  mode_pilot_mission_qualifier_started{current_player.topgun_shots_collected==0 and current_player.qualified_mode_number>0}:
    topgun_6:
      action: play
      priority: 200
  
  # Update slides as letters light up - remove old slide first
  topgun_letter_t_lit:
    topgun_0:
      action: remove
    topgun_1:
      action: play
      priority: 200
  
  topgun_letter_o_lit:
    topgun_1:
      action: remove
    topgun_2:
      action: play
      priority: 200
  
  topgun_letter_p_lit:
    topgun_2:
      action: remove
    topgun_3:
      action: play
      priority: 200
  
  topgun_letter_g_lit:
    topgun_3:
      action: remove
    topgun_4:
      action: play
      priority: 200
  
  topgun_letter_u_lit:
    topgun_4:
      action: remove
    topgun_5:
      action: play
      priority: 200
  
  topgun_letter_n_lit:
    topgun_5:
      action: remove
    topgun_6:
      action: play
      priority: 200
  
  # Play completion video based on modes_completed_count
  topgun_qualified{current_player.modes_completed_count==0}:
    topgun_letters_complete_1:
      action: play
      priority: 300
  
  topgun_qualified{current_player.modes_completed_count==1}:
    topgun_letters_complete_2:
      action: play
      priority: 300
  
  topgun_qualified{current_player.modes_completed_count==2}:
    topgun_letters_complete_3:
      action: play
      priority: 300
  
  topgun_qualified{current_player.modes_completed_count==3}:
    topgun_letters_complete_4:
      action: play
      priority: 300
  
  # For 5th+ qualification, random videos are triggered via event_player -> random_event_player
  # See event_player and random_event_player sections below
  
  # Random video player entries (triggered by random_event_player)
  play_topgun_complete_random_1:
    topgun_letters_complete_1:
      action: play
      priority: 300
  
  play_topgun_complete_random_2:
    topgun_letters_complete_2:
      action: play
      priority: 300
  
  play_topgun_complete_random_3:
    topgun_letters_complete_3:
      action: play
      priority: 300
  
  play_topgun_complete_random_4:
    topgun_letters_complete_4:
      action: play
      priority: 300
  
  # Reset to no letters - only show topgun_0 if NOT qualified (still collecting)
  topgun_letters_reset{current_player.qualified_mode_number==0}:
    topgun_6:
      action: remove
    topgun_0:
      action: play
      priority: 200
  
  # If qualified, just remove topgun_6 without showing anything
  topgun_letters_reset{current_player.qualified_mode_number>0}:
    topgun_6:
      action: remove
  
  # Remove all slides when mode stops
  mode_pilot_mission_qualifier_stopped:
    topgun_0:
      action: remove
    topgun_1:
      action: remove
    topgun_2:
      action: remove
    topgun_3:
      action: remove
    topgun_4:
      action: remove
    topgun_5:
      action: remove
    topgun_6:
      action: remove

##############################################
## Player Variables - Track Progress
##############################################

variable_player:
  player_added:
    # GLOBAL pause flag - set by ANY mode that should block letter collection
    letter_collection_paused:
      action: set
      int: 0
    # Pilot mode active flag - prevents bonus from starting during pilot modes
    pilot_mode_active:
      action: set
      int: 0
    # Drain pending flag - set when drain occurs during pilot mode
    pilot_mode_drain_pending:
      action: set
      int: 0
    # Spinner shot counter (tracks spins within 2-second window)
    spinner_spin_count:
      action: set
      int: 0
    ##############################################
    ## SHOT TRACKING VARIABLES
    ## Used for sneaky shot and under flipper shot detection
    ##############################################
    # Previous switch type for sneaky shot detection
    # 0=other, 1=orbit_left, 2=upper_flipper_eos
    previous_switch_type:
      action: set
      int: 0
    # Left orbit diverter state (0=closed/inactive, 1=open/active)
    left_orbit_diverter_active:
      action: set
      int: 0
    # Shot counter (resets after each TOPGUN complete)
    topgun_shots_collected:
      action: set
      int: 0
    # Total modes completed (0-10)
    modes_completed_count:
      action: set
      int: 0
    # Which mode is currently qualified (0 = none, 1-10 = mode number)
    qualified_mode_number:
      action: set
      int: 0
    # Pause shot collection during skillshot/multiball (0=active, 1=paused)
    pilot_qualifier_paused:
      action: set
      int: 0
    # Track if ANY multiball is active (prevents mode start)
    multiball_active:
      action: set
      int: 0
    # Bonus tracking - training missions played (persists whole game)
    training_missions_played:
      action: set
      int: 0
    # Bonus tracking - hard deck awards (persists whole game)
    hard_deck_awards_count:
      action: set
      int: 0
    # Bonus tracking - pilot missions won (persists whole game)
    pilot_missions_won:
      action: set
      int: 0
    # Track which modes are PLAYED (win or loss - prevents re-qualification)
    mode_rescue_cougar_played:
      action: set
      int: 0
    mode_balls_of_fire_played:
      action: set
      int: 0
    mode_cool_under_pressure_played:
      action: set
      int: 0
    mode_battle_jester_played:
      action: set
      int: 0
    mode_no_points_for_second_place_played:
      action: set
      int: 0
    mode_edge_of_space_played:
      action: set
      int: 0
    mode_below_the_hard_deck_played:
      action: set
      int: 0
    mode_canyon_run_played:
      action: set
      int: 0
    mode_rise_of_phoenix_played:
      action: set
      int: 0
    mode_no_margin_for_error_played:
      action: set
      int: 0
    # Track which modes are WON (for bonus scoring)
    mode_rescue_cougar_won:
      action: set
      int: 0
    mode_balls_of_fire_won:
      action: set
      int: 0
    mode_cool_under_pressure_won:
      action: set
      int: 0
    mode_battle_jester_won:
      action: set
      int: 0
    mode_no_points_for_second_place_won:
      action: set
      int: 0
    mode_edge_of_space_won:
      action: set
      int: 0
    mode_below_the_hard_deck_won:
      action: set
      int: 0
    mode_canyon_run_won:
      action: set
      int: 0
    mode_rise_of_phoenix_won:
      action: set
      int: 0
    mode_no_margin_for_error_won:
      action: set
      int: 0
    # Track which modes are COMPLETE (for rotation skip logic)
    mode_rescue_cougar_complete:
      action: set
      int: 0
    mode_balls_of_fire_complete:
      action: set
      int: 0
    mode_cool_under_pressure_complete:
      action: set
      int: 0
    mode_battle_jester_complete:
      action: set
      int: 0
    mode_no_points_for_second_place_complete:
      action: set
      int: 0
    mode_edge_of_space_complete:
      action: set
      int: 0
    mode_below_the_hard_deck_complete:
      action: set
      int: 0
    mode_canyon_run_complete:
      action: set
      int: 0
    mode_rise_of_phoenix_complete:
      action: set
      int: 0
    mode_no_margin_for_error_complete:
      action: set
      int: 0
  
  # Clear pause flag when rescue_cougar stops (can't do this in rescue_cougar itself)
  mode_rescue_cougar_stopped:
    letter_collection_paused:
      action: set
      int: 0
    # Clear pilot mode active flag
    pilot_mode_active:
      action: set
      int: 0
    # Letter display tracking (based on count, not specific shots)
    topgun_letter_t:
      action: set
      int: 0
    topgun_letter_o:
      action: set
      int: 0
    topgun_letter_p:
      action: set
      int: 0
    topgun_letter_g:
      action: set
      int: 0
    topgun_letter_u:
      action: set
      int: 0
    topgun_letter_n:
      action: set
      int: 0

  # Clear pause flag when rise_of_phoenix stops
  mode_rise_of_phoenix_stopped:
    letter_collection_paused:
      action: set
      int: 0
    # Clear pilot mode active flag
    pilot_mode_active:
      action: set
      int: 0
    # Letter display tracking (based on count, not specific shots)
    topgun_letter_t:
      action: set
      int: 0
    topgun_letter_o:
      action: set
      int: 0
    topgun_letter_p:
      action: set
      int: 0
    topgun_letter_g:
      action: set
      int: 0
    topgun_letter_u:
      action: set
      int: 0
    topgun_letter_n:
      action: set
      int: 0

  # Clear pause flag when battle_jester stops
  mode_battle_jester_stopped:
    letter_collection_paused:
      action: set
      int: 0
    # Clear pilot mode active flag
    pilot_mode_active:
      action: set
      int: 0
    # Letter display tracking (based on count, not specific shots)
    topgun_letter_t:
      action: set
      int: 0
    topgun_letter_o:
      action: set
      int: 0
    topgun_letter_p:
      action: set
      int: 0
    topgun_letter_g:
      action: set
      int: 0
    topgun_letter_u:
      action: set
      int: 0
    topgun_letter_n:
      action: set
      int: 0
  
  # Clear drain pending flag after bonus starts
  pilot_mission_drain_complete:
    pilot_mode_drain_pending:
      action: set
      int: 0

##############################################
## Shot Hit Tracking - ANY Shot Increments Counter
##############################################

  # ANY active shot just increments the counter
  # Only count shots when NOT paused (either flag) AND not qualified
  
  s_lane_left_active{current_player.pilot_qualifier_paused==0 and current_player.letter_collection_paused==0 and current_player.qualified_mode_number==0}:
    topgun_shots_collected:
      action: add
      int: 1

  # Left orbit letter collection - uses left_orbit_shot_hit (requires full orbit: s_orbit_left -> s_orbit_right)
  left_orbit_shot_hit{current_player.pilot_qualifier_paused==0 and current_player.letter_collection_paused==0 and current_player.qualified_mode_number==0}:
    topgun_shots_collected:
      action: add
      int: 1

  # Right orbit letter collection - uses right_orbit_shot_hit (requires full orbit: s_orbit_right -> s_orbit_left)
  right_orbit_shot_hit{current_player.pilot_qualifier_paused==0 and current_player.letter_collection_paused==0 and current_player.qualified_mode_number==0}:
    topgun_shots_collected:
      action: add
      int: 1

  s_ramp_left_exit_active{current_player.pilot_qualifier_paused==0 and current_player.letter_collection_paused==0 and current_player.qualified_mode_number==0}:
    topgun_shots_collected:
      action: add
      int: 1

  # Spinner letter collection - uses spinner_shot_made (requires 3 spins in 2 seconds)
  spinner_shot_made{current_player.pilot_qualifier_paused==0 and current_player.letter_collection_paused==0 and current_player.qualified_mode_number==0}:
    topgun_shots_collected:
      action: add
      int: 1

  # Track each spinner activation for shot detection and reset previous_switch_type
  s_spinner_active:
    spinner_spin_count:
      action: add
      int: 1
    previous_switch_type:
      action: set
      int: 0

  # Reset spin count when timer completes (2 seconds of no spins)
  timer_spinner_shot_timeout_complete:
    spinner_spin_count:
      action: set
      int: 0

  # Reset spin count after spinner_shot_made fires (prevents rapid re-triggering)
  spinner_shot_reset_count:
    spinner_spin_count:
      action: set
      int: 0

  ##############################################
  ## SWITCH TRACKING FOR SNEAKY SHOT DETECTION
  ## Tracks previous switch to determine shot type when s_lane_left is hit
  ## 0=other/reset, 1=orbit_left, 2=upper_flipper_eos
  ## NOTE: Orbit shot detection uses timer.running checks only, not orbit_pending
  ##############################################
  
  # Left orbit entry - track for sneaky shot (ball came from left orbit)
  s_orbit_left_active:
    previous_switch_type:
      action: set
      int: 1
  
  # Right orbit entry - reset sneaky shot tracking
  s_orbit_right_active:
    previous_switch_type:
      action: set
      int: 0

  s_ramp_tower_exit_active{current_player.pilot_qualifier_paused==0 and current_player.letter_collection_paused==0 and current_player.qualified_mode_number==0}:
    topgun_shots_collected:
      action: add
      int: 1

  s_orbit_upper_active{current_player.pilot_qualifier_paused==0 and current_player.letter_collection_paused==0 and current_player.qualified_mode_number==0}:
    topgun_shots_collected:
      action: add
      int: 1

  s_ramp_inner_exit_active{current_player.pilot_qualifier_paused==0 and current_player.letter_collection_paused==0 and current_player.qualified_mode_number==0}:
    topgun_shots_collected:
      action: add
      int: 1

  s_ramp_right_exit_active{current_player.pilot_qualifier_paused==0 and current_player.letter_collection_paused==0 and current_player.qualified_mode_number==0}:
    topgun_shots_collected:
      action: add
      int: 1

  ##############################################
  ## SWITCH TRACKING FOR SNEAKY SHOT DETECTION
  ## Tracks previous switch to determine shot type when s_lane_left is hit
  ## 0=other/reset, 1=orbit_left, 2=upper_flipper_eos
  ## NOTE: s_orbit_left_active and s_orbit_right_active tracking is merged
  ## into the ORBIT SHOT TRACKING section above
  ##############################################
  
  # Set previous_switch_type=2 when upper flipper EOS is triggered
  s_flipper_left_upper_eos_active:
    previous_switch_type:
      action: set
      int: 2
  
  # Reset previous_switch_type when other key switches are hit
  # (these would indicate a different ball path)
  s_orbit_upper_active:
    previous_switch_type:
      action: set
      int: 0
  
  s_orbit_lower_active:
    previous_switch_type:
      action: set
      int: 0
  
  s_ramp_left_exit_active:
    previous_switch_type:
      action: set
      int: 0
  
  s_ramp_right_exit_active:
    previous_switch_type:
      action: set
      int: 0
  
  s_ramp_tower_exit_active:
    previous_switch_type:
      action: set
      int: 0
  
  s_ramp_inner_exit_active:
    previous_switch_type:
      action: set
      int: 0
  
  # Reset after lane_left is processed
  s_lane_left_active:
    previous_switch_type:
      action: set
      int: 0

  ##############################################
  ## LEFT ORBIT DIVERTER TRACKING
  ## Tracks when diverter is enabled/disabled for under flipper shot detection
  ## OPEN = coil active (ball diverted), CLOSED = coil inactive (ball continues)
  ##############################################
  
  # Diverter opened (coil active) - diverts ball
  left_orbit_diverter_open:
    left_orbit_diverter_active:
      action: set
      int: 1
  
  # Diverter closed (coil inactive) - ball continues through
  left_orbit_diverter_closed:
    left_orbit_diverter_active:
      action: set
      int: 0
  
  # Also reset on ball start
  ball_started:
    left_orbit_diverter_active:
      action: set
      int: 0
    previous_switch_type:
      action: set
      int: 0

  ##############################################
  ## Pause/Unpause During Other Modes
  ##############################################
  
  # Pause during skillshot
  mode_skillshot_started:
    pilot_qualifier_paused:
      action: set
      int: 1
  
  # Unpause when skillshot ends
  mode_skillshot_stopped:
    pilot_qualifier_paused:
      action: set
      int: 0
  
  ##############################################
  ## Set Flag When Mode Is Qualified
  ##############################################
  
  qualify_rescue_cougar:
    qualified_mode_number:
      action: set
      int: 1
    topgun_shots_collected:
      action: set
      int: 0
    topgun_letter_t:
      action: set
      int: 0
    topgun_letter_o:
      action: set
      int: 0
    topgun_letter_p:
      action: set
      int: 0
    topgun_letter_g:
      action: set
      int: 0
    topgun_letter_u:
      action: set
      int: 0
    topgun_letter_n:
      action: set
      int: 0

  qualify_balls_of_fire:
    qualified_mode_number:
      action: set
      int: 2
    topgun_shots_collected:
      action: set
      int: 0
    topgun_letter_t:
      action: set
      int: 0
    topgun_letter_o:
      action: set
      int: 0
    topgun_letter_p:
      action: set
      int: 0
    topgun_letter_g:
      action: set
      int: 0
    topgun_letter_u:
      action: set
      int: 0
    topgun_letter_n:
      action: set
      int: 0

  qualify_cool_under_pressure:
    qualified_mode_number:
      action: set
      int: 3
    topgun_shots_collected:
      action: set
      int: 0
    topgun_letter_t:
      action: set
      int: 0
    topgun_letter_o:
      action: set
      int: 0
    topgun_letter_p:
      action: set
      int: 0
    topgun_letter_g:
      action: set
      int: 0
    topgun_letter_u:
      action: set
      int: 0
    topgun_letter_n:
      action: set
      int: 0

  qualify_battle_jester:
    qualified_mode_number:
      action: set
      int: 4
    topgun_shots_collected:
      action: set
      int: 0
    topgun_letter_t:
      action: set
      int: 0
    topgun_letter_o:
      action: set
      int: 0
    topgun_letter_p:
      action: set
      int: 0
    topgun_letter_g:
      action: set
      int: 0
    topgun_letter_u:
      action: set
      int: 0
    topgun_letter_n:
      action: set
      int: 0

  qualify_no_points_for_second_place:
    qualified_mode_number:
      action: set
      int: 5
    topgun_shots_collected:
      action: set
      int: 0
    topgun_letter_t:
      action: set
      int: 0
    topgun_letter_o:
      action: set
      int: 0
    topgun_letter_p:
      action: set
      int: 0
    topgun_letter_g:
      action: set
      int: 0
    topgun_letter_u:
      action: set
      int: 0
    topgun_letter_n:
      action: set
      int: 0

  qualify_edge_of_space:
    qualified_mode_number:
      action: set
      int: 6
    topgun_shots_collected:
      action: set
      int: 0
    topgun_letter_t:
      action: set
      int: 0
    topgun_letter_o:
      action: set
      int: 0
    topgun_letter_p:
      action: set
      int: 0
    topgun_letter_g:
      action: set
      int: 0
    topgun_letter_u:
      action: set
      int: 0
    topgun_letter_n:
      action: set
      int: 0

  qualify_below_the_hard_deck:
    qualified_mode_number:
      action: set
      int: 7
    topgun_shots_collected:
      action: set
      int: 0
    topgun_letter_t:
      action: set
      int: 0
    topgun_letter_o:
      action: set
      int: 0
    topgun_letter_p:
      action: set
      int: 0
    topgun_letter_g:
      action: set
      int: 0
    topgun_letter_u:
      action: set
      int: 0
    topgun_letter_n:
      action: set
      int: 0

  qualify_canyon_run:
    qualified_mode_number:
      action: set
      int: 8
    topgun_shots_collected:
      action: set
      int: 0
    topgun_letter_t:
      action: set
      int: 0
    topgun_letter_o:
      action: set
      int: 0
    topgun_letter_p:
      action: set
      int: 0
    topgun_letter_g:
      action: set
      int: 0
    topgun_letter_u:
      action: set
      int: 0
    topgun_letter_n:
      action: set
      int: 0

  qualify_rise_of_phoenix:
    qualified_mode_number:
      action: set
      int: 9
    topgun_shots_collected:
      action: set
      int: 0
    topgun_letter_t:
      action: set
      int: 0
    topgun_letter_o:
      action: set
      int: 0
    topgun_letter_p:
      action: set
      int: 0
    topgun_letter_g:
      action: set
      int: 0
    topgun_letter_u:
      action: set
      int: 0
    topgun_letter_n:
      action: set
      int: 0

  qualify_no_margin_for_error:
    qualified_mode_number:
      action: set
      int: 10
    topgun_shots_collected:
      action: set
      int: 0
    topgun_letter_t:
      action: set
      int: 0
    topgun_letter_o:
      action: set
      int: 0
    topgun_letter_p:
      action: set
      int: 0
    topgun_letter_g:
      action: set
      int: 0
    topgun_letter_u:
      action: set
      int: 0
    topgun_letter_n:
      action: set
      int: 0

  ##############################################
  ## Mark Modes Complete When They Start
  ##############################################
  
  # Mark mode as PLAYED (either won or lost) and WON when completed
  rescue_cougar_complete:
    mode_rescue_cougar_played:
      action: set
      int: 1
    mode_rescue_cougar_won:
      action: set
      int: 1
    mode_rescue_cougar_complete:
      action: set
      int: 1
    modes_completed_count:
      action: add
      int: 1
  
  # Mark mode as PLAYED (but not won) when failed
  rescue_cougar_failed:
    mode_rescue_cougar_played:
      action: set
      int: 1
  
  # Clear qualified number when mode starts (so player can't start it again mid-game)
  mode_rescue_cougar_started:
    qualified_mode_number:
      action: set
      int: 0

  ##############################################
  ## Rise of Phoenix Mode Tracking
  ##############################################

  # Mark mode as PLAYED and WON when completed
  rise_of_phoenix_complete:
    mode_rise_of_phoenix_played:
      action: set
      int: 1
    mode_rise_of_phoenix_won:
      action: set
      int: 1
    mode_rise_of_phoenix_complete:
      action: set
      int: 1
    modes_completed_count:
      action: add
      int: 1
  
  # Mark mode as PLAYED (but not won) when failed
  rise_of_phoenix_failed:
    mode_rise_of_phoenix_played:
      action: set
      int: 1
  
  # Clear qualified number when mode starts
  mode_rise_of_phoenix_started:
    qualified_mode_number:
      action: set
      int: 0

  # Mark mode as complete when the mode is WON (use balls_of_fire_complete event when mode exists)
  # balls_of_fire_complete:
  #   mode_balls_of_fire_complete:
  #     action: set
  #     int: 1
  #   modes_completed_count:
  #     action: add
  #     int: 1
  
  # Clear qualified number when mode starts
  mode_balls_of_fire_started:
    qualified_mode_number:
      action: set
      int: 0

  # Mark mode as complete when the mode is WON (use cool_under_pressure_complete event when mode exists)
  # cool_under_pressure_complete:
  #   mode_cool_under_pressure_complete:
  #     action: set
  #     int: 1
  #   modes_completed_count:
  #     action: add
  #     int: 1
  
  # Clear qualified number when mode starts
  mode_cool_under_pressure_started:
    qualified_mode_number:
      action: set
      int: 0

  ##############################################
  ## Battle Jester Mode Tracking (4 Outcomes)
  ##############################################

  # Outcome 1: Player chose NO to tower challenge - 100% payout (MODE WON)
  battle_jester_complete:
    mode_battle_jester_played:
      action: set
      int: 1
    mode_battle_jester_won:
      action: set
      int: 1
    mode_battle_jester_complete:
      action: set
      int: 1
    modes_completed_count:
      action: add
      int: 1
  
  # Outcome 2: Timer expired or ball drained - 100% payout (MODE FAILED)
  battle_jester_failed:
    mode_battle_jester_played:
      action: set
      int: 1
  
  # Outcome 3: Tower challenge WON - 150% payout (MODE WON)
  battle_jester_tower_won:
    mode_battle_jester_played:
      action: set
      int: 1
    mode_battle_jester_won:
      action: set
      int: 1
    mode_battle_jester_complete:
      action: set
      int: 1
    modes_completed_count:
      action: add
      int: 1
  
  # Outcome 4: Tower challenge LOST - 50% payout (MODE FAILED)
  battle_jester_tower_lost:
    mode_battle_jester_played:
      action: set
      int: 1
  
  # Clear qualified number when mode starts
  mode_battle_jester_started:
    qualified_mode_number:
      action: set
      int: 0

  # Mark mode as complete when the mode is WON (use no_points_for_second_place_complete event when mode exists)
  # no_points_for_second_place_complete:
  #   mode_no_points_for_second_place_complete:
  #     action: set
  #     int: 1
  #   modes_completed_count:
  #     action: add
  #     int: 1
  
  # Clear qualified number when mode starts
  mode_no_points_for_second_place_started:
    qualified_mode_number:
      action: set
      int: 0

  # Mark mode as complete when the mode is WON (use edge_of_space_complete event when mode exists)
  # edge_of_space_complete:
  #   mode_edge_of_space_complete:
  #     action: set
  #     int: 1
  #   modes_completed_count:
  #     action: add
  #     int: 1
  
  # Clear qualified number when mode starts
  mode_edge_of_space_started:
    qualified_mode_number:
      action: set
      int: 0

  # Mark mode as complete when the mode is WON (use below_the_hard_deck_complete event when mode exists)
  # below_the_hard_deck_complete:
  #   mode_below_the_hard_deck_complete:
  #     action: set
  #     int: 1
  #   modes_completed_count:
  #     action: add
  #     int: 1
  
  # Clear qualified number when mode starts
  mode_below_the_hard_deck_started:
    qualified_mode_number:
      action: set
      int: 0

  # Mark mode as complete when the mode is WON (use canyon_run_complete event when mode exists)
  # canyon_run_complete:
  #   mode_canyon_run_complete:
  #     action: set
  #     int: 1
  #   modes_completed_count:
  #     action: add
  #     int: 1
  
  # Clear qualified number when mode starts
  mode_canyon_run_started:
    qualified_mode_number:
      action: set
      int: 0

  # Mark mode as complete when the mode is WON (use rise_of_phoenix_complete event when mode exists)
  # rise_of_phoenix_complete:
  #   mode_rise_of_phoenix_complete:
  #     action: set
  #     int: 1
  #   modes_completed_count:
  #     action: add
  #     int: 1
  
  # Clear qualified number when mode starts

  # Mark mode as complete when the mode is WON (use no_margin_for_error_complete event when mode exists)
  # no_margin_for_error_complete:
  #   mode_no_margin_for_error_complete:
  #     action: set
  #     int: 1
  #   modes_completed_count:
  #     action: add
  #     int: 1
  
  # Clear qualified number when mode starts
  mode_no_margin_for_error_started:
    qualified_mode_number:
      action: set
      int: 0
  
  topgun_qualified:
    score:
      action: add
      int: 100000 * current_player.total_scoring_multiplier
      block: true

  # Track multiball state
  multiball_started:
    multiball_active:
      action: set
      int: 1
  
  multiball_ended:
    multiball_active:
      action: set
      int: 0


##############################################
## Coil Player - Mode Barrier Control
##############################################
# BARRIER SEMANTICS:
#   barrier_drop → action: enable → coil ON → barrier physically drops → path OPEN
#   barrier_raise → action: disable → coil OFF → barrier springs up → path BLOCKED
#
# All modes should use barrier_drop/barrier_raise events for consistency.
# Power settings defined in config_coils.yaml (default_hold_power: 0.375)

coil_player:
  # UNIVERSAL BARRIER EVENTS - All modes use these
  barrier_drop:
    c_mode_barrier:
      action: enable
  
  barrier_raise:
    c_mode_barrier:
      action: disable

  ##############################################
  ## LEFT ORBIT DIVERTER CONTROL
  ## All modes should use left_orbit_diverter_open/closed events.
  ## This ensures tracking works for under_flipper_shot detection.
  ## OPEN = coil active (ball diverted to left lane)
  ## CLOSED = coil inactive (ball continues through orbit)
  ##############################################
  
  # Open diverter (coil active - diverts ball to left lane)
  left_orbit_diverter_open:
    c_left_orbit_diverter:
      action: enable
  
  # Close diverter (coil inactive - ball continues through)
  left_orbit_diverter_closed:
    c_left_orbit_diverter:
      action: disable
  
  # Right orbit diverter control
  right_orbit_diverter_open:
    c_right_orbit_diverter:
      action: enable
  
  right_orbit_diverter_closed:
    c_right_orbit_diverter:
      action: disable

  # DROP barrier when TOPGUN qualified - ONLY if not in multiball
  topgun_qualified{current_player.multiball_active==0}:
    c_mode_barrier:
      action: enable

  # RAISE barrier and close diverters when ball ends
  ball_ending:
    c_mode_barrier:
      action: disable
    c_left_orbit_diverter:
      action: disable
    c_right_orbit_diverter:
      action: disable

  # LEGACY EVENT - Keep for backwards compatibility, maps to barrier_raise
  pilot_mission_raise_barrier:
    c_mode_barrier:
      action: disable

  # RAISE barrier when any multiball starts
  multiball_started:
    c_mode_barrier:
      action: disable

  # DROP barrier when multiball ends - ONLY if qualified and not in a mode
  multiball_ended{current_player.qualified_mode_number>0}:
    c_mode_barrier:
      action: enable

  # DROP barrier on ball start if qualified and NOT in multiball
  mode_pilot_mission_qualifier_started{current_player.qualified_mode_number>0 and current_player.multiball_active==0}:
    c_mode_barrier:
      action: enable

##############################################
## Event Player - Mode Qualification & Rotation
##############################################

event_player:
  ##############################################
  ## 5th+ QUALIFICATION - RANDOM VIDEO SELECTION
  ## For modes_completed_count >= 4, trigger random video selection
  ##############################################
  
  topgun_qualified{current_player.modes_completed_count>=4}:
    - play_random_topgun_complete

  ##############################################
  ## SPINNER SHOT DETECTION
  ## Fire spinner_shot_made when 3+ spins occur within 2 seconds
  ## AND lockout timer is not running (prevents rapid re-triggering)
  ##############################################
  
  s_spinner_active{current_player.spinner_spin_count>=2 and device.timers.spinner_shot_lockout.running==False}:
    - spinner_shot_made
    - spinner_shot_reset_count
  
  # Reset count after shot is made (separate event to ensure it happens after shot fires)
  spinner_shot_reset_count:
    - timer_spinner_shot_timeout_stop

  ##############################################
  ## ORBIT SHOT DETECTION
  ## Left orbit: s_orbit_left -> s_orbit_right (fires left_orbit_shot_hit)
  ## Right orbit: s_orbit_right -> s_orbit_left (fires right_orbit_shot_hit)
  ## Uses ONLY timer.running checks - no orbit_pending variable
  ## This avoids race conditions between variable_player and event_player
  ##############################################
  
  # Left orbit complete: s_orbit_right hit while left orbit timer running
  s_orbit_right_active{device.timers.left_orbit_shot_timeout.running}:
    - left_orbit_shot_hit
    - timer_left_orbit_shot_timeout_stop
  
  # Right orbit complete: s_orbit_left hit while right orbit timer running
  s_orbit_left_active{device.timers.right_orbit_shot_timeout.running}:
    - right_orbit_shot_hit
    - timer_right_orbit_shot_timeout_stop

  ##############################################
  ## SNEAKY SHOT DETECTION
  ## Fires when s_lane_left is hit AND the previous switch was NOT:
  ## - s_orbit_left (previous_switch_type=1)
  ## - s_flipper_left_upper_eos (previous_switch_type=2)
  ## This means the ball snuck into the left lane without coming from
  ## the left orbit or being flipped by the upper left flipper.
  ##############################################
  
  s_lane_left_active{current_player.previous_switch_type!=1 and current_player.previous_switch_type!=2}:
    - sneaky_shot_hit
  
  ##############################################
  ## UNDER FLIPPER SHOT DETECTION
  ## Fires when s_lane_left is hit AND:
  ## - The upper left flipper EOS was the previous switch (previous_switch_type=2)
  ##   OR the upper left flipper EOS is still active
  ## - AND the left orbit diverter is NOT active (ball wasn't diverted)
  ## This means the ball went under the upper left flipper into the lane.
  ##############################################
  
  s_lane_left_active{(current_player.previous_switch_type==2 or device.switches.s_flipper_left_upper_eos.state) and current_player.left_orbit_diverter_active==0}:
    - under_flipper_shot_hit

  ##############################################
  ## Pilot Mission Bonus Ready - Post when drain cleanup completes
  ## Only posts if pilot_mode_drain_pending==1 (set by pilot mode on drain)
  ##############################################
  
  # Battle Jester - post bonus ready only if drain is pending
  mode_battle_jester_stopped{current_player.pilot_mode_drain_pending==1}:
    - pilot_mission_bonus_ready
    - pilot_mission_drain_complete
  
  # Rescue Cougar
  mode_rescue_cougar_stopped{current_player.pilot_mode_drain_pending==1}:
    - pilot_mission_bonus_ready
    - pilot_mission_drain_complete
  
  # Rise of Phoenix
  mode_rise_of_phoenix_stopped{current_player.pilot_mode_drain_pending==1}:
    - pilot_mission_bonus_ready
    - pilot_mission_drain_complete

  # Determine which mode qualifies based on completed count
  player_topgun_shots_collected{value==6 and current_player.mode_rescue_cougar_played==0}:
    - qualify_rescue_cougar
    - topgun_qualified

  player_topgun_shots_collected{value==6 and current_player.mode_rescue_cougar_played==1 and current_player.mode_balls_of_fire_played==0}:
    - qualify_balls_of_fire
    - topgun_qualified

  player_topgun_shots_collected{value==6 and current_player.mode_rescue_cougar_played==1 and current_player.mode_balls_of_fire_played==1 and current_player.mode_cool_under_pressure_played==0}:
    - qualify_cool_under_pressure
    - topgun_qualified

  player_topgun_shots_collected{value==6 and current_player.mode_rescue_cougar_played==1 and current_player.mode_balls_of_fire_played==1 and current_player.mode_cool_under_pressure_played==1 and current_player.mode_battle_jester_played==0}:
    - qualify_battle_jester
    - topgun_qualified

  player_topgun_shots_collected{value==6 and current_player.mode_rescue_cougar_played==1 and current_player.mode_balls_of_fire_played==1 and current_player.mode_cool_under_pressure_played==1 and current_player.mode_battle_jester_played==1 and current_player.mode_no_points_for_second_place_played==0}:
    - qualify_no_points_for_second_place
    - topgun_qualified

  player_topgun_shots_collected{value==6 and current_player.mode_rescue_cougar_played==1 and current_player.mode_balls_of_fire_played==1 and current_player.mode_cool_under_pressure_played==1 and current_player.mode_battle_jester_played==1 and current_player.mode_no_points_for_second_place_played==1 and current_player.mode_edge_of_space_played==0}:
    - qualify_edge_of_space
    - topgun_qualified

  player_topgun_shots_collected{value==6 and current_player.mode_rescue_cougar_played==1 and current_player.mode_balls_of_fire_played==1 and current_player.mode_cool_under_pressure_played==1 and current_player.mode_battle_jester_played==1 and current_player.mode_no_points_for_second_place_played==1 and current_player.mode_edge_of_space_played==1 and current_player.mode_below_the_hard_deck_played==0}:
    - qualify_below_the_hard_deck
    - topgun_qualified

  player_topgun_shots_collected{value==6 and current_player.mode_rescue_cougar_played==1 and current_player.mode_balls_of_fire_played==1 and current_player.mode_cool_under_pressure_played==1 and current_player.mode_battle_jester_played==1 and current_player.mode_no_points_for_second_place_played==1 and current_player.mode_edge_of_space_played==1 and current_player.mode_below_the_hard_deck_played==1 and current_player.mode_canyon_run_played==0}:
    - qualify_canyon_run
    - topgun_qualified

  player_topgun_shots_collected{value==6 and current_player.mode_rescue_cougar_played==1 and current_player.mode_balls_of_fire_played==1 and current_player.mode_cool_under_pressure_played==1 and current_player.mode_battle_jester_played==1 and current_player.mode_no_points_for_second_place_played==1 and current_player.mode_edge_of_space_played==1 and current_player.mode_below_the_hard_deck_played==1 and current_player.mode_canyon_run_played==1 and current_player.mode_rise_of_phoenix_played==0}:
    - qualify_rise_of_phoenix
    - topgun_qualified

  player_topgun_shots_collected{value==6 and current_player.mode_rescue_cougar_played==1 and current_player.mode_balls_of_fire_played==1 and current_player.mode_cool_under_pressure_played==1 and current_player.mode_battle_jester_played==1 and current_player.mode_no_points_for_second_place_played==1 and current_player.mode_edge_of_space_played==1 and current_player.mode_below_the_hard_deck_played==1 and current_player.mode_canyon_run_played==1 and current_player.mode_rise_of_phoenix_played==1 and current_player.mode_no_margin_for_error_played==0}:
    - qualify_no_margin_for_error
    - topgun_qualified
  
  # Restore qualified mode light on ball start (each ball)
  mode_pilot_mission_qualifier_started{current_player.qualified_mode_number==1}:
    - restore_qualified_mode_light
  mode_pilot_mission_qualifier_started{current_player.qualified_mode_number==2}:
    - restore_qualified_mode_light
  mode_pilot_mission_qualifier_started{current_player.qualified_mode_number==3}:
    - restore_qualified_mode_light
  mode_pilot_mission_qualifier_started{current_player.qualified_mode_number==4}:
    - restore_qualified_mode_light
  mode_pilot_mission_qualifier_started{current_player.qualified_mode_number==5}:
    - restore_qualified_mode_light
  mode_pilot_mission_qualifier_started{current_player.qualified_mode_number==6}:
    - restore_qualified_mode_light
  mode_pilot_mission_qualifier_started{current_player.qualified_mode_number==7}:
    - restore_qualified_mode_light
  mode_pilot_mission_qualifier_started{current_player.qualified_mode_number==8}:
    - restore_qualified_mode_light
  mode_pilot_mission_qualifier_started{current_player.qualified_mode_number==9}:
    - restore_qualified_mode_light
  mode_pilot_mission_qualifier_started{current_player.qualified_mode_number==10}:
    - restore_qualified_mode_light
  
  ##############################################
  ## Mode Rotation - Spinner and Flight Gear Hits
  ##############################################
  
  # Rotate qualified mode on spinner or flight_gear_target hit (only when qualified)
  s_spinner_active{current_player.qualified_mode_number>0}:
    - stop_all_mode_pulse_shows
    - rotate_qualified_mode
  
  s_flight_gear_target_active{current_player.qualified_mode_number>0}:
    - stop_all_mode_pulse_shows
    - rotate_qualified_mode_backwards
  
  ##############################################
  ## Letter Lighting Based on Shot Count
  ##############################################
  
  player_topgun_shots_collected{value==1}:
    topgun_letter_t_lit
  
  player_topgun_shots_collected{value==2}:
    topgun_letter_o_lit
  
  player_topgun_shots_collected{value==3}:
    topgun_letter_p_lit
  
  player_topgun_shots_collected{value==4}:
    topgun_letter_g_lit
  
  player_topgun_shots_collected{value==5}:
    topgun_letter_u_lit
  
  player_topgun_shots_collected{value==6}:
    topgun_letter_n_lit
  
  ##############################################
  ## Mode Rotation Forward Logic
  ##############################################
  
  rotate_qualified_mode{current_player.qualified_mode_number==1 and current_player.mode_balls_of_fire_played==0}:
    qualify_balls_of_fire
  
  rotate_qualified_mode{current_player.qualified_mode_number==1 and current_player.mode_balls_of_fire_played==1 and current_player.mode_cool_under_pressure_played==0}:
    qualify_cool_under_pressure
  
  rotate_qualified_mode{current_player.qualified_mode_number==1 and current_player.mode_balls_of_fire_played==1 and current_player.mode_cool_under_pressure_played==1 and current_player.mode_battle_jester_played==0}:
    qualify_battle_jester
  
  rotate_qualified_mode{current_player.qualified_mode_number==1 and current_player.mode_balls_of_fire_played==1 and current_player.mode_cool_under_pressure_played==1 and current_player.mode_battle_jester_played==1 and current_player.mode_no_points_for_second_place_played==0}:
    qualify_no_points_for_second_place
  
  rotate_qualified_mode{current_player.qualified_mode_number==1 and current_player.mode_balls_of_fire_played==1 and current_player.mode_cool_under_pressure_played==1 and current_player.mode_battle_jester_played==1 and current_player.mode_no_points_for_second_place_played==1 and current_player.mode_edge_of_space_played==0}:
    qualify_edge_of_space
  
  rotate_qualified_mode{current_player.qualified_mode_number==1 and current_player.mode_balls_of_fire_played==1 and current_player.mode_cool_under_pressure_played==1 and current_player.mode_battle_jester_played==1 and current_player.mode_no_points_for_second_place_played==1 and current_player.mode_edge_of_space_played==1 and current_player.mode_below_the_hard_deck_played==0}:
    qualify_below_the_hard_deck
  
  rotate_qualified_mode{current_player.qualified_mode_number==1 and current_player.mode_balls_of_fire_played==1 and current_player.mode_cool_under_pressure_played==1 and current_player.mode_battle_jester_played==1 and current_player.mode_no_points_for_second_place_played==1 and current_player.mode_edge_of_space_played==1 and current_player.mode_below_the_hard_deck_played==1 and current_player.mode_canyon_run_played==0}:
    qualify_canyon_run
  
  rotate_qualified_mode{current_player.qualified_mode_number==1 and current_player.mode_balls_of_fire_played==1 and current_player.mode_cool_under_pressure_played==1 and current_player.mode_battle_jester_played==1 and current_player.mode_no_points_for_second_place_played==1 and current_player.mode_edge_of_space_played==1 and current_player.mode_below_the_hard_deck_played==1 and current_player.mode_canyon_run_played==1 and current_player.mode_rise_of_phoenix_played==0}:
    qualify_rise_of_phoenix
  
  rotate_qualified_mode{current_player.qualified_mode_number==1 and current_player.mode_balls_of_fire_played==1 and current_player.mode_cool_under_pressure_played==1 and current_player.mode_battle_jester_played==1 and current_player.mode_no_points_for_second_place_played==1 and current_player.mode_edge_of_space_played==1 and current_player.mode_below_the_hard_deck_played==1 and current_player.mode_canyon_run_played==1 and current_player.mode_rise_of_phoenix_played==1 and current_player.mode_no_margin_for_error_played==0}:
    qualify_no_margin_for_error
  
  rotate_qualified_mode{current_player.qualified_mode_number==2 and current_player.mode_cool_under_pressure_played==0}:
    qualify_cool_under_pressure
  
  rotate_qualified_mode{current_player.qualified_mode_number==2 and current_player.mode_cool_under_pressure_played==1 and current_player.mode_battle_jester_played==0}:
    qualify_battle_jester
  
  rotate_qualified_mode{current_player.qualified_mode_number==2 and current_player.mode_cool_under_pressure_played==1 and current_player.mode_battle_jester_played==1 and current_player.mode_no_points_for_second_place_played==0}:
    qualify_no_points_for_second_place
  
  rotate_qualified_mode{current_player.qualified_mode_number==2 and current_player.mode_cool_under_pressure_played==1 and current_player.mode_battle_jester_played==1 and current_player.mode_no_points_for_second_place_played==1 and current_player.mode_edge_of_space_played==0}:
    qualify_edge_of_space
  
  rotate_qualified_mode{current_player.qualified_mode_number==2 and current_player.mode_cool_under_pressure_played==1 and current_player.mode_battle_jester_played==1 and current_player.mode_no_points_for_second_place_played==1 and current_player.mode_edge_of_space_played==1 and current_player.mode_below_the_hard_deck_played==0}:
    qualify_below_the_hard_deck
  
  rotate_qualified_mode{current_player.qualified_mode_number==2 and current_player.mode_cool_under_pressure_played==1 and current_player.mode_battle_jester_played==1 and current_player.mode_no_points_for_second_place_played==1 and current_player.mode_edge_of_space_played==1 and current_player.mode_below_the_hard_deck_played==1 and current_player.mode_canyon_run_played==0}:
    qualify_canyon_run
  
  rotate_qualified_mode{current_player.qualified_mode_number==2 and current_player.mode_cool_under_pressure_played==1 and current_player.mode_battle_jester_played==1 and current_player.mode_no_points_for_second_place_played==1 and current_player.mode_edge_of_space_played==1 and current_player.mode_below_the_hard_deck_played==1 and current_player.mode_canyon_run_played==1 and current_player.mode_rise_of_phoenix_played==0}:
    qualify_rise_of_phoenix
  
  rotate_qualified_mode{current_player.qualified_mode_number==2 and current_player.mode_cool_under_pressure_played==1 and current_player.mode_battle_jester_played==1 and current_player.mode_no_points_for_second_place_played==1 and current_player.mode_edge_of_space_played==1 and current_player.mode_below_the_hard_deck_played==1 and current_player.mode_canyon_run_played==1 and current_player.mode_rise_of_phoenix_played==1 and current_player.mode_no_margin_for_error_played==0}:
    qualify_no_margin_for_error
  
  rotate_qualified_mode{current_player.qualified_mode_number==3 and current_player.mode_battle_jester_played==0}:
    qualify_battle_jester
  
  rotate_qualified_mode{current_player.qualified_mode_number==3 and current_player.mode_battle_jester_played==1 and current_player.mode_no_points_for_second_place_played==0}:
    qualify_no_points_for_second_place
  
  rotate_qualified_mode{current_player.qualified_mode_number==3 and current_player.mode_battle_jester_played==1 and current_player.mode_no_points_for_second_place_played==1 and current_player.mode_edge_of_space_played==0}:
    qualify_edge_of_space
  
  rotate_qualified_mode{current_player.qualified_mode_number==3 and current_player.mode_battle_jester_played==1 and current_player.mode_no_points_for_second_place_played==1 and current_player.mode_edge_of_space_played==1 and current_player.mode_below_the_hard_deck_played==0}:
    qualify_below_the_hard_deck
  
  rotate_qualified_mode{current_player.qualified_mode_number==3 and current_player.mode_battle_jester_played==1 and current_player.mode_no_points_for_second_place_played==1 and current_player.mode_edge_of_space_played==1 and current_player.mode_below_the_hard_deck_played==1 and current_player.mode_canyon_run_played==0}:
    qualify_canyon_run
  
  rotate_qualified_mode{current_player.qualified_mode_number==3 and current_player.mode_battle_jester_played==1 and current_player.mode_no_points_for_second_place_played==1 and current_player.mode_edge_of_space_played==1 and current_player.mode_below_the_hard_deck_played==1 and current_player.mode_canyon_run_played==1 and current_player.mode_rise_of_phoenix_played==0}:
    qualify_rise_of_phoenix
  
  rotate_qualified_mode{current_player.qualified_mode_number==3 and current_player.mode_battle_jester_played==1 and current_player.mode_no_points_for_second_place_played==1 and current_player.mode_edge_of_space_played==1 and current_player.mode_below_the_hard_deck_played==1 and current_player.mode_canyon_run_played==1 and current_player.mode_rise_of_phoenix_played==1 and current_player.mode_no_margin_for_error_played==0}:
    qualify_no_margin_for_error
  
  rotate_qualified_mode{current_player.qualified_mode_number==4 and current_player.mode_no_points_for_second_place_played==0}:
    qualify_no_points_for_second_place
  
  rotate_qualified_mode{current_player.qualified_mode_number==4 and current_player.mode_no_points_for_second_place_played==1 and current_player.mode_edge_of_space_played==0}:
    qualify_edge_of_space
  
  rotate_qualified_mode{current_player.qualified_mode_number==4 and current_player.mode_no_points_for_second_place_played==1 and current_player.mode_edge_of_space_played==1 and current_player.mode_below_the_hard_deck_played==0}:
    qualify_below_the_hard_deck
  
  rotate_qualified_mode{current_player.qualified_mode_number==4 and current_player.mode_no_points_for_second_place_played==1 and current_player.mode_edge_of_space_played==1 and current_player.mode_below_the_hard_deck_played==1 and current_player.mode_canyon_run_played==0}:
    qualify_canyon_run
  
  rotate_qualified_mode{current_player.qualified_mode_number==4 and current_player.mode_no_points_for_second_place_played==1 and current_player.mode_edge_of_space_played==1 and current_player.mode_below_the_hard_deck_played==1 and current_player.mode_canyon_run_played==1 and current_player.mode_rise_of_phoenix_played==0}:
    qualify_rise_of_phoenix
  
  rotate_qualified_mode{current_player.qualified_mode_number==4 and current_player.mode_no_points_for_second_place_played==1 and current_player.mode_edge_of_space_played==1 and current_player.mode_below_the_hard_deck_played==1 and current_player.mode_canyon_run_played==1 and current_player.mode_rise_of_phoenix_played==1 and current_player.mode_no_margin_for_error_played==0}:
    qualify_no_margin_for_error
  
  rotate_qualified_mode{current_player.qualified_mode_number==5 and current_player.mode_edge_of_space_played==0}:
    qualify_edge_of_space
  
  rotate_qualified_mode{current_player.qualified_mode_number==5 and current_player.mode_edge_of_space_played==1 and current_player.mode_below_the_hard_deck_played==0}:
    qualify_below_the_hard_deck
  
  rotate_qualified_mode{current_player.qualified_mode_number==5 and current_player.mode_edge_of_space_played==1 and current_player.mode_below_the_hard_deck_played==1 and current_player.mode_canyon_run_played==0}:
    qualify_canyon_run
  
  rotate_qualified_mode{current_player.qualified_mode_number==5 and current_player.mode_edge_of_space_played==1 and current_player.mode_below_the_hard_deck_played==1 and current_player.mode_canyon_run_played==1 and current_player.mode_rise_of_phoenix_played==0}:
    qualify_rise_of_phoenix
  
  rotate_qualified_mode{current_player.qualified_mode_number==5 and current_player.mode_edge_of_space_played==1 and current_player.mode_below_the_hard_deck_played==1 and current_player.mode_canyon_run_played==1 and current_player.mode_rise_of_phoenix_played==1 and current_player.mode_no_margin_for_error_played==0}:
    qualify_no_margin_for_error
  
  rotate_qualified_mode{current_player.qualified_mode_number==6 and current_player.mode_below_the_hard_deck_played==0}:
    qualify_below_the_hard_deck
  
  rotate_qualified_mode{current_player.qualified_mode_number==6 and current_player.mode_below_the_hard_deck_played==1 and current_player.mode_canyon_run_played==0}:
    qualify_canyon_run
  
  rotate_qualified_mode{current_player.qualified_mode_number==6 and current_player.mode_below_the_hard_deck_played==1 and current_player.mode_canyon_run_played==1 and current_player.mode_rise_of_phoenix_played==0}:
    qualify_rise_of_phoenix
  
  rotate_qualified_mode{current_player.qualified_mode_number==6 and current_player.mode_below_the_hard_deck_played==1 and current_player.mode_canyon_run_played==1 and current_player.mode_rise_of_phoenix_played==1 and current_player.mode_no_margin_for_error_played==0}:
    qualify_no_margin_for_error
  
  rotate_qualified_mode{current_player.qualified_mode_number==7 and current_player.mode_canyon_run_played==0}:
    qualify_canyon_run
  
  rotate_qualified_mode{current_player.qualified_mode_number==7 and current_player.mode_canyon_run_played==1 and current_player.mode_rise_of_phoenix_played==0}:
    qualify_rise_of_phoenix
  
  rotate_qualified_mode{current_player.qualified_mode_number==7 and current_player.mode_canyon_run_played==1 and current_player.mode_rise_of_phoenix_played==1 and current_player.mode_no_margin_for_error_played==0}:
    qualify_no_margin_for_error
  
  rotate_qualified_mode{current_player.qualified_mode_number==8 and current_player.mode_rise_of_phoenix_played==0}:
    qualify_rise_of_phoenix
  
  rotate_qualified_mode{current_player.qualified_mode_number==8 and current_player.mode_rise_of_phoenix_played==1 and current_player.mode_no_margin_for_error_played==0}:
    qualify_no_margin_for_error
  
  rotate_qualified_mode{current_player.qualified_mode_number==9 and current_player.mode_no_margin_for_error_played==0}:
    qualify_no_margin_for_error
  
  
  # Mode 10 wraps back to mode 1 (rescue_cougar) when rotating forward
  rotate_qualified_mode{current_player.qualified_mode_number==10 and current_player.mode_rescue_cougar_played==0}:
    qualify_rescue_cougar
  
  rotate_qualified_mode{current_player.qualified_mode_number==10 and current_player.mode_rescue_cougar_played==1 and current_player.mode_balls_of_fire_played==0}:
    qualify_balls_of_fire
  
  rotate_qualified_mode{current_player.qualified_mode_number==10 and current_player.mode_rescue_cougar_played==1 and current_player.mode_balls_of_fire_played==1 and current_player.mode_cool_under_pressure_played==0}:
    qualify_cool_under_pressure
  
  rotate_qualified_mode{current_player.qualified_mode_number==10 and current_player.mode_rescue_cougar_played==1 and current_player.mode_balls_of_fire_played==1 and current_player.mode_cool_under_pressure_played==1 and current_player.mode_battle_jester_played==0}:
    qualify_battle_jester
  
  rotate_qualified_mode{current_player.qualified_mode_number==10 and current_player.mode_rescue_cougar_played==1 and current_player.mode_balls_of_fire_played==1 and current_player.mode_cool_under_pressure_played==1 and current_player.mode_battle_jester_played==1 and current_player.mode_no_points_for_second_place_played==0}:
    qualify_no_points_for_second_place
  
  rotate_qualified_mode{current_player.qualified_mode_number==10 and current_player.mode_rescue_cougar_played==1 and current_player.mode_balls_of_fire_played==1 and current_player.mode_cool_under_pressure_played==1 and current_player.mode_battle_jester_played==1 and current_player.mode_no_points_for_second_place_played==1 and current_player.mode_edge_of_space_played==0}:
    qualify_edge_of_space
  
  rotate_qualified_mode{current_player.qualified_mode_number==10 and current_player.mode_rescue_cougar_played==1 and current_player.mode_balls_of_fire_played==1 and current_player.mode_cool_under_pressure_played==1 and current_player.mode_battle_jester_played==1 and current_player.mode_no_points_for_second_place_played==1 and current_player.mode_edge_of_space_played==1 and current_player.mode_below_the_hard_deck_played==0}:
    qualify_below_the_hard_deck
  
  rotate_qualified_mode{current_player.qualified_mode_number==10 and current_player.mode_rescue_cougar_played==1 and current_player.mode_balls_of_fire_played==1 and current_player.mode_cool_under_pressure_played==1 and current_player.mode_battle_jester_played==1 and current_player.mode_no_points_for_second_place_played==1 and current_player.mode_edge_of_space_played==1 and current_player.mode_below_the_hard_deck_played==1 and current_player.mode_canyon_run_played==0}:
    qualify_canyon_run
  
  rotate_qualified_mode{current_player.qualified_mode_number==10 and current_player.mode_rescue_cougar_played==1 and current_player.mode_balls_of_fire_played==1 and current_player.mode_cool_under_pressure_played==1 and current_player.mode_battle_jester_played==1 and current_player.mode_no_points_for_second_place_played==1 and current_player.mode_edge_of_space_played==1 and current_player.mode_below_the_hard_deck_played==1 and current_player.mode_canyon_run_played==1 and current_player.mode_rise_of_phoenix_played==0}:
    qualify_rise_of_phoenix

  ##############################################
  ## Mode Rotation Backward Logic
  ##############################################
  
  rotate_qualified_mode_backwards{current_player.qualified_mode_number==10 and current_player.mode_rise_of_phoenix_played==0}:
    qualify_rise_of_phoenix
  
  rotate_qualified_mode_backwards{current_player.qualified_mode_number==10 and current_player.mode_rise_of_phoenix_played==1 and current_player.mode_canyon_run_played==0}:
    qualify_canyon_run
  
  rotate_qualified_mode_backwards{current_player.qualified_mode_number==10 and current_player.mode_rise_of_phoenix_played==1 and current_player.mode_canyon_run_played==1 and current_player.mode_below_the_hard_deck_played==0}:
    qualify_below_the_hard_deck
  
  rotate_qualified_mode_backwards{current_player.qualified_mode_number==10 and current_player.mode_rise_of_phoenix_played==1 and current_player.mode_canyon_run_played==1 and current_player.mode_below_the_hard_deck_played==1 and current_player.mode_edge_of_space_played==0}:
    qualify_edge_of_space
  
  rotate_qualified_mode_backwards{current_player.qualified_mode_number==10 and current_player.mode_rise_of_phoenix_played==1 and current_player.mode_canyon_run_played==1 and current_player.mode_below_the_hard_deck_played==1 and current_player.mode_edge_of_space_played==1 and current_player.mode_no_points_for_second_place_played==0}:
    qualify_no_points_for_second_place
  
  rotate_qualified_mode_backwards{current_player.qualified_mode_number==10 and current_player.mode_rise_of_phoenix_played==1 and current_player.mode_canyon_run_played==1 and current_player.mode_below_the_hard_deck_played==1 and current_player.mode_edge_of_space_played==1 and current_player.mode_no_points_for_second_place_played==1 and current_player.mode_battle_jester_played==0}:
    qualify_battle_jester
  
  rotate_qualified_mode_backwards{current_player.qualified_mode_number==10 and current_player.mode_rise_of_phoenix_played==1 and current_player.mode_canyon_run_played==1 and current_player.mode_below_the_hard_deck_played==1 and current_player.mode_edge_of_space_played==1 and current_player.mode_no_points_for_second_place_played==1 and current_player.mode_battle_jester_played==1 and current_player.mode_cool_under_pressure_played==0}:
    qualify_cool_under_pressure
  
  rotate_qualified_mode_backwards{current_player.qualified_mode_number==10 and current_player.mode_rise_of_phoenix_played==1 and current_player.mode_canyon_run_played==1 and current_player.mode_below_the_hard_deck_played==1 and current_player.mode_edge_of_space_played==1 and current_player.mode_no_points_for_second_place_played==1 and current_player.mode_battle_jester_played==1 and current_player.mode_cool_under_pressure_played==1 and current_player.mode_balls_of_fire_played==0}:
    qualify_balls_of_fire
  
  rotate_qualified_mode_backwards{current_player.qualified_mode_number==10 and current_player.mode_rise_of_phoenix_played==1 and current_player.mode_canyon_run_played==1 and current_player.mode_below_the_hard_deck_played==1 and current_player.mode_edge_of_space_played==1 and current_player.mode_no_points_for_second_place_played==1 and current_player.mode_battle_jester_played==1 and current_player.mode_cool_under_pressure_played==1 and current_player.mode_balls_of_fire_played==1 and current_player.mode_rescue_cougar_played==0}:
    qualify_rescue_cougar
  
  rotate_qualified_mode_backwards{current_player.qualified_mode_number==9 and current_player.mode_canyon_run_played==0}:
    qualify_canyon_run
  
  rotate_qualified_mode_backwards{current_player.qualified_mode_number==9 and current_player.mode_canyon_run_played==1 and current_player.mode_below_the_hard_deck_played==0}:
    qualify_below_the_hard_deck
  
  rotate_qualified_mode_backwards{current_player.qualified_mode_number==9 and current_player.mode_canyon_run_played==1 and current_player.mode_below_the_hard_deck_played==1 and current_player.mode_edge_of_space_played==0}:
    qualify_edge_of_space
  
  rotate_qualified_mode_backwards{current_player.qualified_mode_number==9 and current_player.mode_canyon_run_played==1 and current_player.mode_below_the_hard_deck_played==1 and current_player.mode_edge_of_space_played==1 and current_player.mode_no_points_for_second_place_played==0}:
    qualify_no_points_for_second_place
  
  rotate_qualified_mode_backwards{current_player.qualified_mode_number==9 and current_player.mode_canyon_run_played==1 and current_player.mode_below_the_hard_deck_played==1 and current_player.mode_edge_of_space_played==1 and current_player.mode_no_points_for_second_place_played==1 and current_player.mode_battle_jester_played==0}:
    qualify_battle_jester
  
  rotate_qualified_mode_backwards{current_player.qualified_mode_number==9 and current_player.mode_canyon_run_played==1 and current_player.mode_below_the_hard_deck_played==1 and current_player.mode_edge_of_space_played==1 and current_player.mode_no_points_for_second_place_played==1 and current_player.mode_battle_jester_played==1 and current_player.mode_cool_under_pressure_played==0}:
    qualify_cool_under_pressure
  
  rotate_qualified_mode_backwards{current_player.qualified_mode_number==9 and current_player.mode_canyon_run_played==1 and current_player.mode_below_the_hard_deck_played==1 and current_player.mode_edge_of_space_played==1 and current_player.mode_no_points_for_second_place_played==1 and current_player.mode_battle_jester_played==1 and current_player.mode_cool_under_pressure_played==1 and current_player.mode_balls_of_fire_played==0}:
    qualify_balls_of_fire
  
  rotate_qualified_mode_backwards{current_player.qualified_mode_number==9 and current_player.mode_canyon_run_played==1 and current_player.mode_below_the_hard_deck_played==1 and current_player.mode_edge_of_space_played==1 and current_player.mode_no_points_for_second_place_played==1 and current_player.mode_battle_jester_played==1 and current_player.mode_cool_under_pressure_played==1 and current_player.mode_balls_of_fire_played==1 and current_player.mode_rescue_cougar_played==0}:
    qualify_rescue_cougar
  
  rotate_qualified_mode_backwards{current_player.qualified_mode_number==8 and current_player.mode_below_the_hard_deck_played==0}:
    qualify_below_the_hard_deck
  
  rotate_qualified_mode_backwards{current_player.qualified_mode_number==8 and current_player.mode_below_the_hard_deck_played==1 and current_player.mode_edge_of_space_played==0}:
    qualify_edge_of_space
  
  rotate_qualified_mode_backwards{current_player.qualified_mode_number==8 and current_player.mode_below_the_hard_deck_played==1 and current_player.mode_edge_of_space_played==1 and current_player.mode_no_points_for_second_place_played==0}:
    qualify_no_points_for_second_place
  
  rotate_qualified_mode_backwards{current_player.qualified_mode_number==8 and current_player.mode_below_the_hard_deck_played==1 and current_player.mode_edge_of_space_played==1 and current_player.mode_no_points_for_second_place_played==1 and current_player.mode_battle_jester_played==0}:
    qualify_battle_jester
  
  rotate_qualified_mode_backwards{current_player.qualified_mode_number==8 and current_player.mode_below_the_hard_deck_played==1 and current_player.mode_edge_of_space_played==1 and current_player.mode_no_points_for_second_place_played==1 and current_player.mode_battle_jester_played==1 and current_player.mode_cool_under_pressure_played==0}:
    qualify_cool_under_pressure
  
  rotate_qualified_mode_backwards{current_player.qualified_mode_number==8 and current_player.mode_below_the_hard_deck_played==1 and current_player.mode_edge_of_space_played==1 and current_player.mode_no_points_for_second_place_played==1 and current_player.mode_battle_jester_played==1 and current_player.mode_cool_under_pressure_played==1 and current_player.mode_balls_of_fire_played==0}:
    qualify_balls_of_fire
  
  rotate_qualified_mode_backwards{current_player.qualified_mode_number==8 and current_player.mode_below_the_hard_deck_played==1 and current_player.mode_edge_of_space_played==1 and current_player.mode_no_points_for_second_place_played==1 and current_player.mode_battle_jester_played==1 and current_player.mode_cool_under_pressure_played==1 and current_player.mode_balls_of_fire_played==1 and current_player.mode_rescue_cougar_played==0}:
    qualify_rescue_cougar
  
  rotate_qualified_mode_backwards{current_player.qualified_mode_number==7 and current_player.mode_edge_of_space_played==0}:
    qualify_edge_of_space
  
  rotate_qualified_mode_backwards{current_player.qualified_mode_number==7 and current_player.mode_edge_of_space_played==1 and current_player.mode_no_points_for_second_place_played==0}:
    qualify_no_points_for_second_place
  
  rotate_qualified_mode_backwards{current_player.qualified_mode_number==7 and current_player.mode_edge_of_space_played==1 and current_player.mode_no_points_for_second_place_played==1 and current_player.mode_battle_jester_played==0}:
    qualify_battle_jester
  
  rotate_qualified_mode_backwards{current_player.qualified_mode_number==7 and current_player.mode_edge_of_space_played==1 and current_player.mode_no_points_for_second_place_played==1 and current_player.mode_battle_jester_played==1 and current_player.mode_cool_under_pressure_played==0}:
    qualify_cool_under_pressure
  
  rotate_qualified_mode_backwards{current_player.qualified_mode_number==7 and current_player.mode_edge_of_space_played==1 and current_player.mode_no_points_for_second_place_played==1 and current_player.mode_battle_jester_played==1 and current_player.mode_cool_under_pressure_played==1 and current_player.mode_balls_of_fire_played==0}:
    qualify_balls_of_fire
  
  rotate_qualified_mode_backwards{current_player.qualified_mode_number==7 and current_player.mode_edge_of_space_played==1 and current_player.mode_no_points_for_second_place_played==1 and current_player.mode_battle_jester_played==1 and current_player.mode_cool_under_pressure_played==1 and current_player.mode_balls_of_fire_played==1 and current_player.mode_rescue_cougar_played==0}:
    qualify_rescue_cougar
  
  rotate_qualified_mode_backwards{current_player.qualified_mode_number==6 and current_player.mode_no_points_for_second_place_played==0}:
    qualify_no_points_for_second_place
  
  rotate_qualified_mode_backwards{current_player.qualified_mode_number==6 and current_player.mode_no_points_for_second_place_played==1 and current_player.mode_battle_jester_played==0}:
    qualify_battle_jester
  
  rotate_qualified_mode_backwards{current_player.qualified_mode_number==6 and current_player.mode_no_points_for_second_place_played==1 and current_player.mode_battle_jester_played==1 and current_player.mode_cool_under_pressure_played==0}:
    qualify_cool_under_pressure
  
  rotate_qualified_mode_backwards{current_player.qualified_mode_number==6 and current_player.mode_no_points_for_second_place_played==1 and current_player.mode_battle_jester_played==1 and current_player.mode_cool_under_pressure_played==1 and current_player.mode_balls_of_fire_played==0}:
    qualify_balls_of_fire
  
  rotate_qualified_mode_backwards{current_player.qualified_mode_number==6 and current_player.mode_no_points_for_second_place_played==1 and current_player.mode_battle_jester_played==1 and current_player.mode_cool_under_pressure_played==1 and current_player.mode_balls_of_fire_played==1 and current_player.mode_rescue_cougar_played==0}:
    qualify_rescue_cougar
  
  rotate_qualified_mode_backwards{current_player.qualified_mode_number==5 and current_player.mode_battle_jester_played==0}:
    qualify_battle_jester
  
  rotate_qualified_mode_backwards{current_player.qualified_mode_number==5 and current_player.mode_battle_jester_played==1 and current_player.mode_cool_under_pressure_played==0}:
    qualify_cool_under_pressure
  
  rotate_qualified_mode_backwards{current_player.qualified_mode_number==5 and current_player.mode_battle_jester_played==1 and current_player.mode_cool_under_pressure_played==1 and current_player.mode_balls_of_fire_played==0}:
    qualify_balls_of_fire
  
  rotate_qualified_mode_backwards{current_player.qualified_mode_number==5 and current_player.mode_battle_jester_played==1 and current_player.mode_cool_under_pressure_played==1 and current_player.mode_balls_of_fire_played==1 and current_player.mode_rescue_cougar_played==0}:
    qualify_rescue_cougar
  
  rotate_qualified_mode_backwards{current_player.qualified_mode_number==4 and current_player.mode_cool_under_pressure_played==0}:
    qualify_cool_under_pressure
  
  rotate_qualified_mode_backwards{current_player.qualified_mode_number==4 and current_player.mode_cool_under_pressure_played==1 and current_player.mode_balls_of_fire_played==0}:
    qualify_balls_of_fire
  
  rotate_qualified_mode_backwards{current_player.qualified_mode_number==4 and current_player.mode_cool_under_pressure_played==1 and current_player.mode_balls_of_fire_played==1 and current_player.mode_rescue_cougar_played==0}:
    qualify_rescue_cougar
  
  rotate_qualified_mode_backwards{current_player.qualified_mode_number==3 and current_player.mode_balls_of_fire_played==0}:
    qualify_balls_of_fire
  
  rotate_qualified_mode_backwards{current_player.qualified_mode_number==3 and current_player.mode_balls_of_fire_played==1 and current_player.mode_rescue_cougar_played==0}:
    qualify_rescue_cougar
  
  rotate_qualified_mode_backwards{current_player.qualified_mode_number==2 and current_player.mode_rescue_cougar_played==0}:
    qualify_rescue_cougar
  
  # If at mode 2 and mode 1 is played, wrap to mode 10
  rotate_qualified_mode_backwards{current_player.qualified_mode_number==2 and current_player.mode_rescue_cougar_played==1 and current_player.mode_no_margin_for_error_played==0}:
    qualify_no_margin_for_error
  
  rotate_qualified_mode_backwards{current_player.qualified_mode_number==2 and current_player.mode_rescue_cougar_played==1 and current_player.mode_no_margin_for_error_played==1 and current_player.mode_rise_of_phoenix_played==0}:
    qualify_rise_of_phoenix
  
  rotate_qualified_mode_backwards{current_player.qualified_mode_number==2 and current_player.mode_rescue_cougar_played==1 and current_player.mode_no_margin_for_error_played==1 and current_player.mode_rise_of_phoenix_played==1 and current_player.mode_canyon_run_played==0}:
    qualify_canyon_run
  
  rotate_qualified_mode_backwards{current_player.qualified_mode_number==2 and current_player.mode_rescue_cougar_played==1 and current_player.mode_no_margin_for_error_played==1 and current_player.mode_rise_of_phoenix_played==1 and current_player.mode_canyon_run_played==1 and current_player.mode_below_the_hard_deck_played==0}:
    qualify_below_the_hard_deck
  
  rotate_qualified_mode_backwards{current_player.qualified_mode_number==2 and current_player.mode_rescue_cougar_played==1 and current_player.mode_no_margin_for_error_played==1 and current_player.mode_rise_of_phoenix_played==1 and current_player.mode_canyon_run_played==1 and current_player.mode_below_the_hard_deck_played==1 and current_player.mode_edge_of_space_played==0}:
    qualify_edge_of_space
  
  rotate_qualified_mode_backwards{current_player.qualified_mode_number==2 and current_player.mode_rescue_cougar_played==1 and current_player.mode_no_margin_for_error_played==1 and current_player.mode_rise_of_phoenix_played==1 and current_player.mode_canyon_run_played==1 and current_player.mode_below_the_hard_deck_played==1 and current_player.mode_edge_of_space_played==1 and current_player.mode_no_points_for_second_place_played==0}:
    qualify_no_points_for_second_place
  
  rotate_qualified_mode_backwards{current_player.qualified_mode_number==2 and current_player.mode_rescue_cougar_played==1 and current_player.mode_no_margin_for_error_played==1 and current_player.mode_rise_of_phoenix_played==1 and current_player.mode_canyon_run_played==1 and current_player.mode_below_the_hard_deck_played==1 and current_player.mode_edge_of_space_played==1 and current_player.mode_no_points_for_second_place_played==1 and current_player.mode_battle_jester_played==0}:
    qualify_battle_jester
  
  rotate_qualified_mode_backwards{current_player.qualified_mode_number==2 and current_player.mode_rescue_cougar_played==1 and current_player.mode_no_margin_for_error_played==1 and current_player.mode_rise_of_phoenix_played==1 and current_player.mode_canyon_run_played==1 and current_player.mode_below_the_hard_deck_played==1 and current_player.mode_edge_of_space_played==1 and current_player.mode_no_points_for_second_place_played==1 and current_player.mode_battle_jester_played==1 and current_player.mode_cool_under_pressure_played==0}:
    qualify_cool_under_pressure
  
  
  # Mode 1 wraps back to mode 10 (no_margin_for_error) when rotating backward
  rotate_qualified_mode_backwards{current_player.qualified_mode_number==1 and current_player.mode_no_margin_for_error_played==0}:
    qualify_no_margin_for_error
  
  rotate_qualified_mode_backwards{current_player.qualified_mode_number==1 and current_player.mode_no_margin_for_error_played==1 and current_player.mode_rise_of_phoenix_played==0}:
    qualify_rise_of_phoenix
  
  rotate_qualified_mode_backwards{current_player.qualified_mode_number==1 and current_player.mode_no_margin_for_error_played==1 and current_player.mode_rise_of_phoenix_played==1 and current_player.mode_canyon_run_played==0}:
    qualify_canyon_run
  
  rotate_qualified_mode_backwards{current_player.qualified_mode_number==1 and current_player.mode_no_margin_for_error_played==1 and current_player.mode_rise_of_phoenix_played==1 and current_player.mode_canyon_run_played==1 and current_player.mode_below_the_hard_deck_played==0}:
    qualify_below_the_hard_deck
  
  rotate_qualified_mode_backwards{current_player.qualified_mode_number==1 and current_player.mode_no_margin_for_error_played==1 and current_player.mode_rise_of_phoenix_played==1 and current_player.mode_canyon_run_played==1 and current_player.mode_below_the_hard_deck_played==1 and current_player.mode_edge_of_space_played==0}:
    qualify_edge_of_space
  
  rotate_qualified_mode_backwards{current_player.qualified_mode_number==1 and current_player.mode_no_margin_for_error_played==1 and current_player.mode_rise_of_phoenix_played==1 and current_player.mode_canyon_run_played==1 and current_player.mode_below_the_hard_deck_played==1 and current_player.mode_edge_of_space_played==1 and current_player.mode_no_points_for_second_place_played==0}:
    qualify_no_points_for_second_place
  
  rotate_qualified_mode_backwards{current_player.qualified_mode_number==1 and current_player.mode_no_margin_for_error_played==1 and current_player.mode_rise_of_phoenix_played==1 and current_player.mode_canyon_run_played==1 and current_player.mode_below_the_hard_deck_played==1 and current_player.mode_edge_of_space_played==1 and current_player.mode_no_points_for_second_place_played==1 and current_player.mode_battle_jester_played==0}:
    qualify_battle_jester
  
  rotate_qualified_mode_backwards{current_player.qualified_mode_number==1 and current_player.mode_no_margin_for_error_played==1 and current_player.mode_rise_of_phoenix_played==1 and current_player.mode_canyon_run_played==1 and current_player.mode_below_the_hard_deck_played==1 and current_player.mode_edge_of_space_played==1 and current_player.mode_no_points_for_second_place_played==1 and current_player.mode_battle_jester_played==1 and current_player.mode_cool_under_pressure_played==0}:
    qualify_cool_under_pressure
  
  rotate_qualified_mode_backwards{current_player.qualified_mode_number==1 and current_player.mode_no_margin_for_error_played==1 and current_player.mode_rise_of_phoenix_played==1 and current_player.mode_canyon_run_played==1 and current_player.mode_below_the_hard_deck_played==1 and current_player.mode_edge_of_space_played==1 and current_player.mode_no_points_for_second_place_played==1 and current_player.mode_battle_jester_played==1 and current_player.mode_cool_under_pressure_played==1 and current_player.mode_balls_of_fire_played==0}:
    qualify_balls_of_fire

  ##############################################
  ## Mode Selection - Start Mode on Scoop Hit
  ##############################################
  
  # Mode selection based on qualified mode when scoop is hit
  s_mode_start_active{current_player.qualified_mode_number==1 and current_player.mode_rescue_cougar_played==0}:
    - start_mode_rescue_cougar
  
  s_mode_start_active{current_player.qualified_mode_number==2 and current_player.mode_balls_of_fire_played==0}:
    - start_mode_balls_of_fire
  
  s_mode_start_active{current_player.qualified_mode_number==3 and current_player.mode_cool_under_pressure_played==0}:
    - start_mode_cool_under_pressure
  
  s_mode_start_active{current_player.qualified_mode_number==4 and current_player.mode_battle_jester_played==0}:
    - start_mode_battle_jester
  
  s_mode_start_active{current_player.qualified_mode_number==5 and current_player.mode_no_points_for_second_place_played==0}:
    - start_mode_no_points_for_second_place
  
  s_mode_start_active{current_player.qualified_mode_number==6 and current_player.mode_edge_of_space_played==0}:
    - start_mode_edge_of_space
  
  s_mode_start_active{current_player.qualified_mode_number==7 and current_player.mode_below_the_hard_deck_played==0}:
    - start_mode_below_the_hard_deck
  
  s_mode_start_active{current_player.qualified_mode_number==8 and current_player.mode_canyon_run_played==0}:
    - start_mode_canyon_run
  
  s_mode_start_active{current_player.qualified_mode_number==9 and current_player.mode_rise_of_phoenix_played==0}:
    - start_mode_rise_of_phoenix
  
  s_mode_start_active{current_player.qualified_mode_number==10 and current_player.mode_no_margin_for_error_played==0}:
    - start_mode_no_margin_for_error
  
  ##############################################
  ## TOPGUN Reset Handler
  ##############################################
  
  # TOPGUN Letter Reset - triggered by any pilot mission mode starting
  reset_topgun_letters:
    - topgun_letters_reset
  
  # TOPGUN reset when any pilot mission mode starts
  mode_rescue_cougar_started:
    - reset_topgun_letters
  
  mode_balls_of_fire_started:
    - reset_topgun_letters
  
  mode_cool_under_pressure_started:
    - reset_topgun_letters
  
  mode_battle_jester_started:
    - reset_topgun_letters
  
  mode_no_points_for_second_place_started:
    - reset_topgun_letters
  
  mode_edge_of_space_started:
    - reset_topgun_letters
  
  mode_below_the_hard_deck_started:
    - reset_topgun_letters
  
  mode_canyon_run_started:
    - reset_topgun_letters
  
  mode_rise_of_phoenix_started:
    - reset_topgun_letters
  
  mode_no_margin_for_error_started:
    - reset_topgun_letters

  # Reset letters when new ball starts
  ball_will_end:
    topgun_letters_reset

##############################################
## Show Player
##############################################

show_player:
  # Pulse all shot lights when mode starts and not qualified
  mode_pilot_mission_qualifier_started{current_player.qualified_mode_number==0}:
    qualifying_shots_pulse:
      loops: -1
      speed: 1
  
  # Stop pulsing when qualified
  topgun_qualified:
    qualifying_shots_pulse:
      action: stop
  
  # Stop pulsing when letter collection paused
  player_letter_collection_paused{value==1 and current_player.qualified_mode_number==0}:
    qualifying_shots_pulse:
      action: stop
  
  # Restart pulsing when letter collection unpaused (and not yet qualified)
  player_letter_collection_paused{value==0 and current_player.qualified_mode_number==0}:
    qualifying_shots_pulse:
      loops: -1
      speed: 1
  
  # Stop pulsing during skillshot (pilot_qualifier_paused)
  player_pilot_qualifier_paused{value==1 and current_player.qualified_mode_number==0}:
    qualifying_shots_pulse:
      action: stop

  # Restart pulsing when skillshot ends (and not yet qualified)
  player_pilot_qualifier_paused{value==0 and current_player.qualified_mode_number==0}:
    qualifying_shots_pulse:
      loops: -1
      speed: 1
  
  # Stop all pulse shows so new one can start
  stop_all_mode_pulse_shows:
    rescue_cougar_pulse:
      action: stop
    balls_of_fire_pulse:
      action: stop
    cool_under_pressure_pulse:
      action: stop
    battle_jester_pulse:
      action: stop
    no_points_pulse:
      action: stop
    edge_of_space_pulse:
      action: stop
    below_hard_deck_pulse:
      action: stop
    canyon_run_pulse:
      action: stop
    rise_of_phoenix_pulse:
      action: stop
    no_margin_pulse:
      action: stop
  
  # Pulse appropriate mode light when qualified (will stop when mode starts)
  qualify_rescue_cougar:
    pulse_mode_light:
      loops: -1
      speed: 1
      show_tokens:
        led: l_mode_rescue_cougar
        color: white
      key: rescue_cougar_pulse
  
  qualify_balls_of_fire:
    pulse_mode_light:
      loops: -1
      speed: 1
      show_tokens:
        led: l_mode_balls_of_fire
        color: white
      key: balls_of_fire_pulse
  
  qualify_cool_under_pressure:
    pulse_mode_light:
      loops: -1
      speed: 1
      show_tokens:
        led: l_mode_cool_under_pressure
        color: white
      key: cool_under_pressure_pulse
  
  qualify_battle_jester:
    pulse_mode_light:
      loops: -1
      speed: 1
      show_tokens:
        led: l_mode_battle_jester
        color: white
      key: battle_jester_pulse
  
  qualify_no_points_for_second_place:
    pulse_mode_light:
      loops: -1
      speed: 1
      show_tokens:
        led: l_mode_no_points_for_second_place
        color: white
      key: no_points_pulse
  
  qualify_edge_of_space:
    pulse_mode_light:
      loops: -1
      speed: 1
      show_tokens:
        led: l_mode_edge_of_space
        color: white
      key: edge_of_space_pulse
  
  qualify_below_the_hard_deck:
    pulse_mode_light:
      loops: -1
      speed: 1
      show_tokens:
        led: l_mode_below_the_hard_deck
        color: white
      key: below_hard_deck_pulse
  
  qualify_canyon_run:
    pulse_mode_light:
      loops: -1
      speed: 1
      show_tokens:
        led: l_mode_canyon_run
        color: white
      key: canyon_run_pulse
  
  qualify_rise_of_phoenix:
    pulse_mode_light:
      loops: -1
      speed: 1
      show_tokens:
        led: l_mode_rise_of_phoenix
        color: white
      key: rise_of_phoenix_pulse
  
  qualify_no_margin_for_error:
    pulse_mode_light:
      loops: -1
      speed: 1
      show_tokens:
        led: l_mode_no_margin_for_error
        color: white
      key: no_margin_pulse
  
  # Stop pulsing when modes start (will be solid white from light_player)
  mode_rescue_cougar_started:
    rescue_cougar_pulse:
      action: stop
  
  mode_balls_of_fire_started:
    balls_of_fire_pulse:
      action: stop
  
  mode_cool_under_pressure_started:
    cool_under_pressure_pulse:
      action: stop
  
  mode_battle_jester_started:
    battle_jester_pulse:
      action: stop
  
  mode_no_points_for_second_place_started:
    no_points_pulse:
      action: stop
  
  mode_edge_of_space_started:
    edge_of_space_pulse:
      action: stop
  
  mode_below_the_hard_deck_started:
    below_hard_deck_pulse:
      action: stop
  
  mode_canyon_run_started:
    canyon_run_pulse:
      action: stop
  
  mode_rise_of_phoenix_started:
    rise_of_phoenix_pulse:
      action: stop
  
  mode_no_margin_for_error_started:
    no_margin_pulse:
      action: stop
  
  # Restore pulsing on ball start if still qualified
  restore_qualified_mode_light{current_player.qualified_mode_number==1 and current_player.mode_rescue_cougar_played==0}:
    pulse_mode_light:
      loops: -1
      speed: 1
      show_tokens:
        led: l_mode_rescue_cougar
        color: white
      key: rescue_cougar_pulse
  
  restore_qualified_mode_light{current_player.qualified_mode_number==2 and current_player.mode_balls_of_fire_played==0}:
    pulse_mode_light:
      loops: -1
      speed: 1
      show_tokens:
        led: l_mode_balls_of_fire
        color: white
      key: balls_of_fire_pulse
  
  restore_qualified_mode_light{current_player.qualified_mode_number==3 and current_player.mode_cool_under_pressure_played==0}:
    pulse_mode_light:
      loops: -1
      speed: 1
      show_tokens:
        led: l_mode_cool_under_pressure
        color: white
      key: cool_under_pressure_pulse
  
  restore_qualified_mode_light{current_player.qualified_mode_number==4 and current_player.mode_battle_jester_played==0}:
    pulse_mode_light:
      loops: -1
      speed: 1
      show_tokens:
        led: l_mode_battle_jester
        color: white
      key: battle_jester_pulse
  
  restore_qualified_mode_light{current_player.qualified_mode_number==5 and current_player.mode_no_points_for_second_place_played==0}:
    pulse_mode_light:
      loops: -1
      speed: 1
      show_tokens:
        led: l_mode_no_points_for_second_place
        color: white
      key: no_points_pulse
  
  restore_qualified_mode_light{current_player.qualified_mode_number==6 and current_player.mode_edge_of_space_played==0}:
    pulse_mode_light:
      loops: -1
      speed: 1
      show_tokens:
        led: l_mode_edge_of_space
        color: white
      key: edge_of_space_pulse
  
  restore_qualified_mode_light{current_player.qualified_mode_number==7 and current_player.mode_below_the_hard_deck_played==0}:
    pulse_mode_light:
      loops: -1
      speed: 1
      show_tokens:
        led: l_mode_below_the_hard_deck
        color: white
      key: below_hard_deck_pulse
  
  restore_qualified_mode_light{current_player.qualified_mode_number==8 and current_player.mode_canyon_run_played==0}:
    pulse_mode_light:
      loops: -1
      speed: 1
      show_tokens:
        led: l_mode_canyon_run
        color: white
      key: canyon_run_pulse
  
  restore_qualified_mode_light{current_player.qualified_mode_number==9 and current_player.mode_rise_of_phoenix_played==0}:
    pulse_mode_light:
      loops: -1
      speed: 1
      show_tokens:
        led: l_mode_rise_of_phoenix
        color: white
      key: rise_of_phoenix_pulse
  
  restore_qualified_mode_light{current_player.qualified_mode_number==10 and current_player.mode_no_margin_for_error_played==0}:
    pulse_mode_light:
      loops: -1
      speed: 1
      show_tokens:
        led: l_mode_no_margin_for_error
        color: white
      key: no_margin_pulse

shows:
  qualifying_shots_pulse:
    - duration: 0.75s
      lights:
        l_shot_left_lane: white
        l_shot_left_orbit: white
        l_shot_left_ramp: white
        l_shot_spinner: white
        l_shot_tower_ramp: white
        l_shot_upper_orbit: white
        l_shot_middle_ramp: white
        l_shot_right_orbit: white
    - duration: 0.75s
      lights:
        l_shot_left_lane: off
        l_shot_left_orbit: off
        l_shot_left_ramp: off
        l_shot_spinner: off
        l_shot_tower_ramp: off
        l_shot_upper_orbit: off
        l_shot_middle_ramp: off
        l_shot_right_orbit: off

##############################################
## Light Player
##############################################

light_player:
  # Turn on pilot mission lit indicator AND turn off all shot lights when qualified
  topgun_qualified:
    l_pilot_mission_lit:
      color: white
      fade: 0ms
    l_shot_left_lane:
      color: off
    l_shot_left_orbit:
      color: off
    l_shot_left_ramp:
      color: off
    l_shot_spinner:
      color: off
    l_shot_tower_ramp:
      color: off
    l_shot_upper_orbit:
      color: off
    l_shot_middle_ramp:
      color: off
    l_shot_right_orbit:
      color: off
  
  # Turn off pilot mission lit when mode starts ONLY if not qualified
  mode_pilot_mission_qualifier_started{current_player.qualified_mode_number==0}:
    l_pilot_mission_lit:
      color: off
  
  # Keep pilot mission lit ON when mode starts if qualified
  mode_pilot_mission_qualifier_started{current_player.qualified_mode_number>0}:
    l_pilot_mission_lit:
      color: white
      fade: 0ms
  
  # Restore solid white lights for PLAYED modes at ball start
  mode_pilot_mission_qualifier_started{current_player.mode_rescue_cougar_played==1}:
    l_mode_rescue_cougar:
      color: white
      fade: 0ms
  
  mode_pilot_mission_qualifier_started{current_player.mode_balls_of_fire_played==1}:
    l_mode_balls_of_fire:
      color: white
      fade: 0ms
  
  mode_pilot_mission_qualifier_started{current_player.mode_cool_under_pressure_played==1}:
    l_mode_cool_under_pressure:
      color: white
      fade: 0ms
  
  mode_pilot_mission_qualifier_started{current_player.mode_battle_jester_played==1}:
    l_mode_battle_jester:
      color: white
      fade: 0ms
  
  mode_pilot_mission_qualifier_started{current_player.mode_no_points_for_second_place_played==1}:
    l_mode_no_points_for_second_place:
      color: white
      fade: 0ms
  
  mode_pilot_mission_qualifier_started{current_player.mode_edge_of_space_played==1}:
    l_mode_edge_of_space:
      color: white
      fade: 0ms
  
  mode_pilot_mission_qualifier_started{current_player.mode_below_the_hard_deck_played==1}:
    l_mode_below_the_hard_deck:
      color: white
      fade: 0ms
  
  mode_pilot_mission_qualifier_started{current_player.mode_canyon_run_played==1}:
    l_mode_canyon_run:
      color: white
      fade: 0ms
  
  mode_pilot_mission_qualifier_started{current_player.mode_rise_of_phoenix_played==1}:
    l_mode_rise_of_phoenix:
      color: white
      fade: 0ms
  
  mode_pilot_mission_qualifier_started{current_player.mode_no_margin_for_error_played==1}:
    l_mode_no_margin_for_error:
      color: white
      fade: 0ms

  # Restore base mode light on ball start if qualified (pulsing handled by show_player)
  restore_qualified_mode_light{current_player.qualified_mode_number==1}:
    l_mode_rescue_cougar:
      color: white
  restore_qualified_mode_light{current_player.qualified_mode_number==2}:
    l_mode_balls_of_fire:
      color: white
  restore_qualified_mode_light{current_player.qualified_mode_number==3}:
    l_mode_cool_under_pressure:
      color: white
  restore_qualified_mode_light{current_player.qualified_mode_number==4}:
    l_mode_battle_jester:
      color: white
  restore_qualified_mode_light{current_player.qualified_mode_number==5}:
    l_mode_no_points_for_second_place:
      color: white
  restore_qualified_mode_light{current_player.qualified_mode_number==6}:
    l_mode_edge_of_space:
      color: white
  restore_qualified_mode_light{current_player.qualified_mode_number==7}:
    l_mode_below_the_hard_deck:
      color: white
  restore_qualified_mode_light{current_player.qualified_mode_number==8}:
    l_mode_canyon_run:
      color: white
  restore_qualified_mode_light{current_player.qualified_mode_number==9}:
    l_mode_rise_of_phoenix:
      color: white
  restore_qualified_mode_light{current_player.qualified_mode_number==10}:
    l_mode_no_margin_for_error:
      color: white

  # Turn off all mode lights AFTER shows are stopped
  stop_all_mode_pulse_shows:
    l_mode_rescue_cougar:
      color: off
    l_mode_balls_of_fire:
      color: off
    l_mode_cool_under_pressure:
      color: off
    l_mode_battle_jester:
      color: off
    l_mode_no_points_for_second_place:
      color: off
    l_mode_edge_of_space:
      color: off
    l_mode_below_the_hard_deck:
      color: off
    l_mode_canyon_run:
      color: off
    l_mode_rise_of_phoenix:
      color: off
    l_mode_no_margin_for_error:
      color: off

  # Restore completed mode lights to SOLID WHITE after rotation
  stop_all_mode_pulse_shows{current_player.mode_rescue_cougar_played==1}:
    l_mode_rescue_cougar:
      color: white
      fade: 0ms
  
  stop_all_mode_pulse_shows{current_player.mode_balls_of_fire_played==1}:
    l_mode_balls_of_fire:
      color: white
      fade: 0ms
  
  stop_all_mode_pulse_shows{current_player.mode_cool_under_pressure_played==1}:
    l_mode_cool_under_pressure:
      color: white
      fade: 0ms
  
  stop_all_mode_pulse_shows{current_player.mode_battle_jester_played==1}:
    l_mode_battle_jester:
      color: white
      fade: 0ms
  
  stop_all_mode_pulse_shows{current_player.mode_no_points_for_second_place_played==1}:
    l_mode_no_points_for_second_place:
      color: white
      fade: 0ms
  
  stop_all_mode_pulse_shows{current_player.mode_edge_of_space_played==1}:
    l_mode_edge_of_space:
      color: white
      fade: 0ms
  
  stop_all_mode_pulse_shows{current_player.mode_below_the_hard_deck_played==1}:
    l_mode_below_the_hard_deck:
      color: white
      fade: 0ms
  
  stop_all_mode_pulse_shows{current_player.mode_canyon_run_played==1}:
    l_mode_canyon_run:
      color: white
      fade: 0ms
  
  stop_all_mode_pulse_shows{current_player.mode_rise_of_phoenix_played==1}:
    l_mode_rise_of_phoenix:
      color: white
      fade: 0ms
  
  stop_all_mode_pulse_shows{current_player.mode_no_margin_for_error_played==1}:
    l_mode_no_margin_for_error:
      color: white
      fade: 0ms

  # Initial light when qualified (will be overridden by pulsing show)
  qualify_rescue_cougar:
    l_mode_rescue_cougar:
      color: white
  qualify_balls_of_fire:
    l_mode_balls_of_fire:
      color: white
  qualify_cool_under_pressure:
    l_mode_cool_under_pressure:
      color: white
  qualify_battle_jester:
    l_mode_battle_jester:
      color: white
  qualify_no_points_for_second_place:
    l_mode_no_points_for_second_place:
      color: white
  qualify_edge_of_space:
    l_mode_edge_of_space:
      color: white
  qualify_below_the_hard_deck:
    l_mode_below_the_hard_deck:
      color: white
  qualify_canyon_run:
    l_mode_canyon_run:
      color: white
  qualify_rise_of_phoenix:
    l_mode_rise_of_phoenix:
      color: white
  qualify_no_margin_for_error:
    l_mode_no_margin_for_error:
      color: white

  # Turn off pilot mission lit AND set mode lights to SOLID white when modes start
  mode_rescue_cougar_started:
    l_pilot_mission_lit:
      color: off
    l_mode_rescue_cougar:
      color: white
      fade: 0ms
      
  mode_balls_of_fire_started:
    l_pilot_mission_lit:
      color: off
    l_mode_balls_of_fire:
      color: white
      fade: 0ms
      
  mode_cool_under_pressure_started:
    l_pilot_mission_lit:
      color: off
    l_mode_cool_under_pressure:
      color: white
      fade: 0ms
      
  mode_battle_jester_started:
    l_pilot_mission_lit:
      color: off
    l_mode_battle_jester:
      color: white
      fade: 0ms
      
  mode_no_points_for_second_place_started:
    l_pilot_mission_lit:
      color: off
    l_mode_no_points_for_second_place:
      color: white
      fade: 0ms
      
  mode_edge_of_space_started:
    l_pilot_mission_lit:
      color: off
    l_mode_edge_of_space:
      color: white
      fade: 0ms
      
  mode_below_the_hard_deck_started:
    l_pilot_mission_lit:
      color: off
    l_mode_below_the_hard_deck:
      color: white
      fade: 0ms
      
  mode_canyon_run_started:
    l_pilot_mission_lit:
      color: off
    l_mode_canyon_run:
      color: white
      fade: 0ms
      
  mode_rise_of_phoenix_started:
    l_pilot_mission_lit:
      color: off
    l_mode_rise_of_phoenix:
      color: white
      fade: 0ms
      
  mode_no_margin_for_error_started:
    l_pilot_mission_lit:
      color: off
    l_mode_no_margin_for_error:
      color: white
      fade: 0ms

##############################################
## Sound Player (Optional - Uncomment when sounds are ready)
##############################################

##############################################
## RANDOM EVENT PLAYER
## For 5th+ qualification, randomly select one of 4 completion videos
##############################################

random_event_player:
  play_random_topgun_complete:
    force_all: false
    events:
      - play_topgun_complete_random_1
      - play_topgun_complete_random_2
      - play_topgun_complete_random_3
      - play_topgun_complete_random_4

# sound_player:
#   s_lane_left_active:
#     sfx_letter:
#       action: play
#   s_orbit_left_active:
#     sfx_letter:
#       action: play
#   s_ramp_left_exit_active:
#     sfx_letter:
#       action: play
#   s_spinner_active:
#     sfx_letter:
#       action: play
#   s_ramp_tower_exit_active:
#     sfx_letter:
#       action: play
#   s_orbit_upper_active:
#     sfx_letter:
#       action: play
#   s_ramp_inner_exit_active:
#     sfx_letter:
#       action: play
#   s_ramp_right_exit_active:
#     sfx_letter:
#       action: play
#   
#   topgun_qualified:
#     sfx_topgun_complete:
#       action: play
#   
#   rotate_qualified_mode:
#     sfx_mode_rotate:
#       action: play

# sounds:
#   sfx_letter:
#     file: letter_collect.wav
#     streaming: false
#   sfx_topgun_complete:
#     file: topgun_qualified.wav
#     streaming: false
#   sfx_mode_rotate:
#     file: mode_change.wav
#     streaming: false
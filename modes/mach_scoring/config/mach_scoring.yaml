#config_version=6
# Mach Scoring Mode - Global scoring multiplier system
# Requires 2 ramp hits within 10s to activate, then 20s countdown timer
# Slides at Layer 49(Timer and Mach Level) & 48 (Videos)

mode:
  start_events: mode_base_started
  stop_events: mode_base_stopped
  priority: 500

sounds:
  mach_scoring_soundfx_super_slow_speed:
    file: effects/mach_scoring/mach_scoring_soundfx_super_slow_speed.mp3
  mach_scoring_soundfx_slow_speed:
    file: effects/mach_scoring/mach_scoring_soundfx_slow_speed.mp3
  mach_scoring_soundfx_medium_speed:
    file: effects/mach_scoring/mach_scoring_soundfx_medium_speed.mp3
  mach_scoring_soundfx_super_fast:
    file: effects/mach_scoring/mach_scoring_soundfx_super_fast.mp3
  mach_scoring_soundfx_come_on:
    file: effects/mach_scoring/mach_scoring_soundfx_come_on.mp3
  mach_scoring_soundfx_explosion:
    file: effects/mach_scoring/mach_scoring_soundfx_explosion.mp3
  mach_scoring_soundfx_sound_barrier:
    file: effects/mach_scoring/mach_scoring_soundfx_sound_barrier.mp3
  mach_scoring_soundfx_maxed:
    file: effects/mach_scoring/mach_scoring_soundfx_maxed.mp3

shots:
  mach_ramp:
    switch: s_ramp_inner_exit

timers:
  # Qualification timer - 10 seconds to hit ramp again
  mach_qualify_timer:
    start_value: 10
    end_value: 0
    direction: down
    tick_interval: 1s
    start_running: false
    control_events:
      - action: start
        event: mach_first_hit
      - action: stop
        event: mach_qualified

  # Main countdown timer - 20 seconds at active mach level
  # Inverted perk extends by +20s (total 40s) via mach_inverted_extend_timer
  mach_timer:
    start_value: 20
    end_value: 0
    direction: down
    tick_interval: 1s
    start_running: false
    control_events:
      - action: restart
        event: mach_qualified
      - action: restart
        event: mach_level_up
      - action: restart
        event: mach_max_hit
      - action: stop
        event: timer_mach_timer_complete
      - action: add
        event: mach_inverted_extend_timer
        value: 20

event_player:
  # First hit - no mach scoring yet
  mach_ramp_hit{current_player.mach_step==0}:
    mach_first_hit:
      
  # Second hit within 10s - activate mach scoring
  mach_ramp_hit{current_player.mach_step==1}:
    mach_qualified:
    
  # Hits at active levels - check if we can level up or if at max
  mach_ramp_hit{current_player.mach_step>=2 and current_player.mach_step<9}:
    mach_level_up:
    
  # Hit at max level - just restart timer
  mach_ramp_hit{current_player.mach_step==9}:
    mach_max_hit:
    
  # Qualification timeout - reset
  timer_mach_qualify_timer_complete:
    mach_reset:
    
  # Main timer timeout - reset
  timer_mach_timer_complete:
    mach_reset:
    remove_timer_slides:
    show_explosion_video:
  
  # Clean up timer slides when restarting timer
  mach_level_up:
    remove_timer_slides:
  
  mach_max_hit:
    remove_timer_slides:
  
  # When mach 1.25 is reached, trigger video
  player_mach_level{value==1.25}:
    show_mach_1_25_video:

  ##############################################
  ## INVERTED PERK: Doubled Mach Timer (+20s)
  ## Timer restarts to 20s normally, then extends by 20 more = 40s total
  ## Fires AFTER the restart events so timing is: restart(20s) → add(+20s) = 40s
  ##############################################
  mach_qualified{current_player.inverted_perk_active==1}:
    - mach_inverted_extend_timer
  mach_level_up{current_player.inverted_perk_active==1}:
    - mach_inverted_extend_timer
  mach_max_hit{current_player.inverted_perk_active==1}:
    - mach_inverted_extend_timer
  player_mach_level{value==1.5}:
    show_mach_1_5_video:
  player_mach_level{value==1.75}:
    show_mach_1_75_video:
  player_mach_level{value==2.0}:
    show_mach_2_video:
  player_mach_level{value==2.25}:
    show_mach_2_25_video:
  player_mach_level{value==2.5}:
    show_mach_2_5_video:
  player_mach_level{value==2.75}:
    show_mach_2_75_video:
  player_mach_level{value==3.0}:
    show_mach_3_video:

variable_player:
  # First hit - start qualification
  mach_first_hit:
    mach_step:
      int: 1
      action: set
    
  # Second hit - activate at 1.25x (step 2)
  mach_qualified:
    mach_step:
      int: 2
      action: set
    mach_level:
      float: 1.25
      action: set
    score:
      action: add
      int: 25000 * current_player.total_scoring_multiplier
      block: true
    
  # Level up - increment step and set corresponding level
  mach_level_up:
    mach_step:
      int: 1
      action: add
    mach_level:
      float: 0.25
      action: add
    score:
      action: add
      int: 25000 * current_player.total_scoring_multiplier
      block: true
  
  # Reset to default
  mach_reset:
    mach_step:
      int: 0
      action: set
    mach_level:
      float: 1.0
      action: set

  ##############################################
  ## INVERTED PERK: 2x Mach Progression
  ## Extra +1 step and +0.25 level per level-up (fires in addition to normal)
  ## Normal: +0.25 per hit (9 hits to max). Perk: +0.50 per hit (5 hits to max)
  ##############################################
  mach_level_up{current_player.inverted_perk_active==1}:
    mach_step:
      int: 1
      action: add
    mach_level:
      float: 0.25
      action: add

  ## Cap at max if perk causes overshoot (step 10+ back to 9, level to 3.0)
  player_mach_step{value>9}:
    mach_step:
      action: set
      int: 9
    mach_level:
      action: set
      float: 3.0

show_player:
  # Play fire effect show when timer expires
  timer_mach_timer_complete:
    mach_scoring_ended:
      loops: 1
      speed: 65
      sync_ms: true
  
  # Play light show when mach scoring increases
  mach_level_up:
    mach_scoring_increased:
      loops: 0
      speed: 15
      sync_ms: true

  # Play light show when mach scoring starts
  mach_qualified:
    mach_scoring_increased:
      loops: 0
      speed: 15
      sync_ms: true

slide_player:
  # Show default mach_1 image when mode starts
  mode_mach_scoring_started:
    mach_1:
      action: play
      priority: 200
  
  # Update slides as mach level changes
  player_mach_level{value==1.25}:
    mach_1:
      action: remove
    mach_1_25:
      action: play
      priority: 200
  
  # Show video when reaching mach 1.25
  show_mach_1_25_video:
    mach_1_25_video:
      action: play
      priority: 300
      
  player_mach_level{value==1.50}:
    mach_1_25:
      action: remove
    mach_1_25_video:
      action: remove
    mach_1_5:
      action: play
      priority: 200
    mach_1_5_video:
      action: play
      priority: 200
      
  player_mach_level{value==1.75}:
    mach_1_5:
      action: remove
    mach_1_5_video:
      action: remove
    mach_1_75:
      action: play
      priority: 200
    mach_1_75_video:
      action: play
      priority: 200
      
  player_mach_level{value==2.0}:
    mach_1_75:
      action: remove
    mach_1_75_video:
      action: remove
    mach_2:
      action: play
      priority: 200
    mach_2_video:
      action: play
      priority: 200
      
  player_mach_level{value==2.25}:
    mach_2:
      action: remove
    mach_2_video:
      action: remove
    mach_2_25:
      action: play
      priority: 200
    mach_2_25_video:
      action: play
      priority: 200
      
  player_mach_level{value==2.50}:
    mach_2_25:
      action: remove
    mach_2_25_video:
      action: remove
    mach_2_5:
      action: play
      priority: 200
    mach_2_5_video:
      action: play
      priority: 200
      
  player_mach_level{value==2.75}:
    mach_2_5:
      action: remove
    mach_2_5_video:
      action: remove
    mach_2_75:
      action: play
      priority: 200
    mach_2_75_video:
      action: play
      priority: 200
      
  player_mach_level{value==3.0}:
    mach_2_75:
      action: remove
    mach_2_75_video:
      action: remove
    mach_3:
      action: play
      priority: 200
    mach_3_video:
      action: play
      priority: 200

  show_explosion_video:
    mach_scoring_expired_video:
      action: play
      priority: 300
      expire: 2s
  
  # Reset to mach_1 when timer expires
  player_mach_level{value==1.0}:
    mach_1_25:
      action: remove
    mach_1_25_video:
      action: remove
    mach_1_5:
      action: remove
    mach_1_5_video:
      action: remove
    mach_1_75:
      action: remove
    mach_1_75_video:
      action: remove
    mach_2:
      action: remove
    mach_2_video:
      action: remove
    mach_2_25:
      action: remove
    mach_2_25_video:
      action: remove
    mach_2_5:
      action: remove
    mach_2_5_video:
      action: remove
    mach_2_75:
      action: remove
    mach_2_75_video:
      action: remove
    mach_3:
      action: remove
    mach_3_video:
      action: remove
    mach_1:
      action: play
      priority: 200
  
  # Remove all timer slides when timer restarts
  remove_timer_slides:
    timer1:
      action: remove
    timer2:
      action: remove
    timer3:
      action: remove
    timer4:
      action: remove
    timer5:
      action: remove
    timer6:
      action: remove
    timer7:
      action: remove
    timer8:
      action: remove
    timer9:
      action: remove
    timer10:
      action: remove
    timer11:
      action: remove
    timer12:
      action: remove
    timer13:
      action: remove
    timer14:
      action: remove
    timer15:
      action: remove
    timer16:
      action: remove
    timer17:
      action: remove
    timer18:
      action: remove
    timer19:
      action: remove
    timer20:
      action: remove
  
  # Timer slides - NORMAL (no inverted perk): 1 slide per tick, ticks 20→0
  timer_mach_timer_tick{device.timers.mach_timer.ticks==20 and current_player.inverted_perk_active==0}:
    timer20:
      action: play
      priority: 200
      
  timer_mach_timer_tick{device.timers.mach_timer.ticks==19 and current_player.inverted_perk_active==0}:
    timer20:
      action: remove
    timer19:
      action: play
      priority: 200
      
  timer_mach_timer_tick{device.timers.mach_timer.ticks==18 and current_player.inverted_perk_active==0}:
    timer19:
      action: remove
    timer18:
      action: play
      priority: 200
      
  timer_mach_timer_tick{device.timers.mach_timer.ticks==17 and current_player.inverted_perk_active==0}:
    timer18:
      action: remove
    timer17:
      action: play
      priority: 200
      
  timer_mach_timer_tick{device.timers.mach_timer.ticks==16 and current_player.inverted_perk_active==0}:
    timer17:
      action: remove
    timer16:
      action: play
      priority: 200
      
  timer_mach_timer_tick{device.timers.mach_timer.ticks==15 and current_player.inverted_perk_active==0}:
    timer16:
      action: remove
    timer15:
      action: play
      priority: 200
      
  timer_mach_timer_tick{device.timers.mach_timer.ticks==14 and current_player.inverted_perk_active==0}:
    timer15:
      action: remove
    timer14:
      action: play
      priority: 200
      
  timer_mach_timer_tick{device.timers.mach_timer.ticks==13 and current_player.inverted_perk_active==0}:
    timer14:
      action: remove
    timer13:
      action: play
      priority: 200
      
  timer_mach_timer_tick{device.timers.mach_timer.ticks==12 and current_player.inverted_perk_active==0}:
    timer13:
      action: remove
    timer12:
      action: play
      priority: 200
      
  timer_mach_timer_tick{device.timers.mach_timer.ticks==11 and current_player.inverted_perk_active==0}:
    timer12:
      action: remove
    timer11:
      action: play
      priority: 200
      
  timer_mach_timer_tick{device.timers.mach_timer.ticks==10 and current_player.inverted_perk_active==0}:
    timer11:
      action: remove
    timer10:
      action: play
      priority: 200
      
  timer_mach_timer_tick{device.timers.mach_timer.ticks==9 and current_player.inverted_perk_active==0}:
    timer10:
      action: remove
    timer9:
      action: play
      priority: 200
      
  timer_mach_timer_tick{device.timers.mach_timer.ticks==8 and current_player.inverted_perk_active==0}:
    timer9:
      action: remove
    timer8:
      action: play
      priority: 200
      
  timer_mach_timer_tick{device.timers.mach_timer.ticks==7 and current_player.inverted_perk_active==0}:
    timer8:
      action: remove
    timer7:
      action: play
      priority: 200
      
  timer_mach_timer_tick{device.timers.mach_timer.ticks==6 and current_player.inverted_perk_active==0}:
    timer7:
      action: remove
    timer6:
      action: play
      priority: 200
      
  timer_mach_timer_tick{device.timers.mach_timer.ticks==5 and current_player.inverted_perk_active==0}:
    timer6:
      action: remove
    timer5:
      action: play
      priority: 200
      
  timer_mach_timer_tick{device.timers.mach_timer.ticks==4 and current_player.inverted_perk_active==0}:
    timer5:
      action: remove
    timer4:
      action: play
      priority: 200
      
  timer_mach_timer_tick{device.timers.mach_timer.ticks==3 and current_player.inverted_perk_active==0}:
    timer4:
      action: remove
    timer3:
      action: play
      priority: 200
      
  timer_mach_timer_tick{device.timers.mach_timer.ticks==2 and current_player.inverted_perk_active==0}:
    timer3:
      action: remove
    timer2:
      action: play
      priority: 200
      
  timer_mach_timer_tick{device.timers.mach_timer.ticks==1 and current_player.inverted_perk_active==0}:
    timer2:
      action: remove
    timer1:
      action: play
      priority: 200
      
  timer_mach_timer_tick{device.timers.mach_timer.ticks==0 and current_player.inverted_perk_active==0}:
    timer1:
      action: remove

  ##############################################
  ## Timer slides - INVERTED PERK: 1 slide per 2 ticks, ticks 40→0
  ## Same 20 slides but each lasts 2 seconds (timer goes down slower visually)
  ##############################################
  timer_mach_timer_tick{device.timers.mach_timer.ticks==40 and current_player.inverted_perk_active==1}:
    timer20:
      action: play
      priority: 200

  timer_mach_timer_tick{device.timers.mach_timer.ticks==38 and current_player.inverted_perk_active==1}:
    timer20:
      action: remove
    timer19:
      action: play
      priority: 200

  timer_mach_timer_tick{device.timers.mach_timer.ticks==36 and current_player.inverted_perk_active==1}:
    timer19:
      action: remove
    timer18:
      action: play
      priority: 200

  timer_mach_timer_tick{device.timers.mach_timer.ticks==34 and current_player.inverted_perk_active==1}:
    timer18:
      action: remove
    timer17:
      action: play
      priority: 200

  timer_mach_timer_tick{device.timers.mach_timer.ticks==32 and current_player.inverted_perk_active==1}:
    timer17:
      action: remove
    timer16:
      action: play
      priority: 200

  timer_mach_timer_tick{device.timers.mach_timer.ticks==30 and current_player.inverted_perk_active==1}:
    timer16:
      action: remove
    timer15:
      action: play
      priority: 200

  timer_mach_timer_tick{device.timers.mach_timer.ticks==28 and current_player.inverted_perk_active==1}:
    timer15:
      action: remove
    timer14:
      action: play
      priority: 200

  timer_mach_timer_tick{device.timers.mach_timer.ticks==26 and current_player.inverted_perk_active==1}:
    timer14:
      action: remove
    timer13:
      action: play
      priority: 200

  timer_mach_timer_tick{device.timers.mach_timer.ticks==24 and current_player.inverted_perk_active==1}:
    timer13:
      action: remove
    timer12:
      action: play
      priority: 200

  timer_mach_timer_tick{device.timers.mach_timer.ticks==22 and current_player.inverted_perk_active==1}:
    timer12:
      action: remove
    timer11:
      action: play
      priority: 200

  timer_mach_timer_tick{device.timers.mach_timer.ticks==20 and current_player.inverted_perk_active==1}:
    timer11:
      action: remove
    timer10:
      action: play
      priority: 200

  timer_mach_timer_tick{device.timers.mach_timer.ticks==18 and current_player.inverted_perk_active==1}:
    timer10:
      action: remove
    timer9:
      action: play
      priority: 200

  timer_mach_timer_tick{device.timers.mach_timer.ticks==16 and current_player.inverted_perk_active==1}:
    timer9:
      action: remove
    timer8:
      action: play
      priority: 200

  timer_mach_timer_tick{device.timers.mach_timer.ticks==14 and current_player.inverted_perk_active==1}:
    timer8:
      action: remove
    timer7:
      action: play
      priority: 200

  timer_mach_timer_tick{device.timers.mach_timer.ticks==12 and current_player.inverted_perk_active==1}:
    timer7:
      action: remove
    timer6:
      action: play
      priority: 200

  timer_mach_timer_tick{device.timers.mach_timer.ticks==10 and current_player.inverted_perk_active==1}:
    timer6:
      action: remove
    timer5:
      action: play
      priority: 200

  timer_mach_timer_tick{device.timers.mach_timer.ticks==8 and current_player.inverted_perk_active==1}:
    timer5:
      action: remove
    timer4:
      action: play
      priority: 200

  timer_mach_timer_tick{device.timers.mach_timer.ticks==6 and current_player.inverted_perk_active==1}:
    timer4:
      action: remove
    timer3:
      action: play
      priority: 200

  timer_mach_timer_tick{device.timers.mach_timer.ticks==4 and current_player.inverted_perk_active==1}:
    timer3:
      action: remove
    timer2:
      action: play
      priority: 200

  timer_mach_timer_tick{device.timers.mach_timer.ticks==2 and current_player.inverted_perk_active==1}:
    timer2:
      action: remove
    timer1:
      action: play
      priority: 200

  timer_mach_timer_tick{device.timers.mach_timer.ticks==0 and current_player.inverted_perk_active==1}:
    timer1:
      action: remove
  
  # Clean up slides when mode stops
  mode_mach_scoring_stopped:
    mach_1_25:
      action: remove
    mach_1_25_video:
      action: remove
    mach_1_5:
      action: remove
    mach_1_5_video:
      action: remove
    mach_1_75:
      action: remove
    mach_1_75_video:
      action: remove
    mach_2:
      action: remove
    mach_2_video:
      action: remove
    mach_2_25:
      action: remove
    mach_2_25_video:
      action: remove
    mach_2_5:
      action: remove
    mach_2_5_video:
      action: remove
    mach_2_75:
      action: remove
    mach_2_75_video:
      action: remove
    mach_3:
      action: remove
    mach_3_video:
      action: remove
    timer1:
      action: remove
    timer2:
      action: remove
    timer3:
      action: remove
    timer4:
      action: remove
    timer5:
      action: remove
    timer6:
      action: remove
    timer7:
      action: remove
    timer8:
      action: remove
    timer9:
      action: remove
    timer10:
      action: remove
    timer11:
      action: remove
    timer12:
      action: remove
    timer13:
      action: remove
    timer14:
      action: remove
    timer15:
      action: remove
    timer16:
      action: remove
    timer17:
      action: remove
    timer18:
      action: remove
    timer19:
      action: remove
    timer20:
      action: remove
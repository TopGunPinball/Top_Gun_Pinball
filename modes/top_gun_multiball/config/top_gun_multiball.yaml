#config_version=6
##############################################################################
# TOP GUN MULTIBALL MODE
# Priority: 400
#
# ARCHITECTURE:
#   - Godot handles: radar visuals, MIG spawning (random), movement, lock-on
#     visual, penalty selection (random), score calculation (distance-based)
#   - MPF handles: shot detection, scoring, insert lighting, GI effects,
#     flipper penalties, sound callouts, super jackpot tracking
#
# GODOT → MPF EVENTS:
#   radar_activate_mig_[id]     MIG spawned on shot
#   radar_deactivate_mig_[id]   MIG removed from shot
#   radar_mig_destroyed          MIG killed (with scoring)
#   radar_mig_destroyed_no_score MIG killed during 10% penalty
#   radar_mig_explosion          Trigger GI explosion show
#   radar_mig_lockon             MIG reached center, lock-on starts
#   radar_evasion_shot_[id]      Random evasion shot selected
#   radar_evasion_success        Player hit evasion shot
#   radar_penalty_no_hold        Penalty: no hold flippers
#   radar_penalty_reversed       Penalty: reversed flippers
#   radar_penalty_gi_off         Penalty: GI lights off
#   radar_penalty_scoring_reduced Penalty: scoring at 10%
#   radar_penalty_progress_reset Penalty: reset mig kill count
#   radar_super_jackpot_lit      Super jackpot available
#   radar_super_jackpot_collected Super jackpot hit
#   radar_wave_advance           Wave difficulty increased
#
# MPF → GODOT EVENTS:
#   multiball_mig_hit_[id]       Shot detected for active MIG
#   radar_evasion_hit            Evasion shot was hit
#   multiball_ending             Multiball ending, clean up
##############################################################################

mode:
  start_events: start_mode_top_gun_multiball
  stop_events: 
    - top_gun_multiball_ended
    - mb_multiball_final_end
  priority: 400
  game_mode: true

##############################################################################
# MULTIBALLS DEVICE - Tells MPF to expect 3 balls in play
# Without this, MPF ends the ball on the first drain during multiball.
# shoot_again provides a 15-second ball save at multiball start.
##############################################################################
multiballs:
  top_gun_multiball:
    ball_count: 3
    ball_count_type: total
    shoot_again: 15s
    start_events: mb_balls_release
    ball_locks: bd_lock_goose, bd_lock_mav
    add_a_ball_events: mb_add_a_ball_activate

  top_gun_multiball_extender:
    ball_count: 1
    ball_count_type: add
    shoot_again: 15s
    start_events: mb_extender_start

##############################################################################
# BALL SAVES - Add-a-ball and extender callout protection
##############################################################################
ball_saves:
  # 15 second ball save on each add-a-ball activation
  mb_add_a_ball_save:
    active_time: 15s
    hurry_up_time: 2s
    grace_period: 500ms
    auto_launch: true
    balls_to_save: -1
    enable_events: mb_add_a_ball_activate
    disable_events: mode_top_gun_multiball_will_stop
    debug: true

  # 5 second safety save during extender callout (protects last ball)
  mb_extender_callout_save:
    active_time: 5s
    grace_period: 500ms
    auto_launch: true
    balls_to_save: 1
    enable_events: mb_extender_activate
    disable_events:
      - mb_extender_start
      - mode_top_gun_multiball_will_stop
    debug: true

##############################################################################
# SHOWS - GI Explosion (4 seconds, red/yellow/orange flicker)
##############################################################################
shows:
  gi_mig_explosion:
    - duration: 100ms
      lights:
        l_gi_light_1: yellow
        l_gi_light_2: orange
        l_gi_light_3: red
        l_gi_light_4: yellow
        l_gi_light_5: orange
        l_gi_light_6: red
        l_gi_light_7: yellow
        l_gi_light_8: orange
        l_gi_light_9: red
        l_gi_light_10: yellow
        l_gi_light_11: orange
        l_gi_light_12: red
        l_gi_light_13: yellow
        l_gi_light_14: orange
        l_gi_light_15: red
        l_gi_light_16: yellow
        l_gi_light_17: orange
        l_gi_light_18: red
        l_gi_light_19: yellow
        l_gi_light_20: orange
        l_gi_light_21: red
        l_gi_light_22: yellow
        l_gi_light_23: orange
        l_gi_light_24: red
        l_gi_light_25: yellow
        l_gi_light_26: orange
        l_gi_light_27: red
        l_apron_light_1: yellow
        l_apron_light_2: orange
        l_apron_light_3: red
        l_apron_light_4: yellow
        l_gi_light_pop_left: red
        l_gi_light_pop_right: yellow
        l_gi_light_pop_bottom: orange
    - duration: 100ms
      lights:
        l_gi_light_1: red
        l_gi_light_2: yellow
        l_gi_light_3: orange
        l_gi_light_4: red
        l_gi_light_5: yellow
        l_gi_light_6: orange
        l_gi_light_7: red
        l_gi_light_8: yellow
        l_gi_light_9: orange
        l_gi_light_10: red
        l_gi_light_11: yellow
        l_gi_light_12: orange
        l_gi_light_13: red
        l_gi_light_14: yellow
        l_gi_light_15: orange
        l_gi_light_16: red
        l_gi_light_17: yellow
        l_gi_light_18: orange
        l_gi_light_19: red
        l_gi_light_20: yellow
        l_gi_light_21: orange
        l_gi_light_22: red
        l_gi_light_23: yellow
        l_gi_light_24: orange
        l_gi_light_25: red
        l_gi_light_26: yellow
        l_gi_light_27: orange
        l_apron_light_1: red
        l_apron_light_2: yellow
        l_apron_light_3: orange
        l_apron_light_4: red
        l_gi_light_pop_left: orange
        l_gi_light_pop_right: red
        l_gi_light_pop_bottom: yellow
    - duration: 100ms
      lights:
        l_gi_light_1: orange
        l_gi_light_2: red
        l_gi_light_3: yellow
        l_gi_light_4: orange
        l_gi_light_5: red
        l_gi_light_6: yellow
        l_gi_light_7: orange
        l_gi_light_8: red
        l_gi_light_9: yellow
        l_gi_light_10: orange
        l_gi_light_11: red
        l_gi_light_12: yellow
        l_gi_light_13: orange
        l_gi_light_14: red
        l_gi_light_15: yellow
        l_gi_light_16: orange
        l_gi_light_17: red
        l_gi_light_18: yellow
        l_gi_light_19: orange
        l_gi_light_20: red
        l_gi_light_21: yellow
        l_gi_light_22: orange
        l_gi_light_23: red
        l_gi_light_24: yellow
        l_gi_light_25: orange
        l_gi_light_26: red
        l_gi_light_27: yellow
        l_apron_light_1: orange
        l_apron_light_2: red
        l_apron_light_3: yellow
        l_apron_light_4: orange
        l_gi_light_pop_left: yellow
        l_gi_light_pop_right: orange
        l_gi_light_pop_bottom: red
    - duration: 100ms
      lights:
        l_gi_light_1: yellow
        l_gi_light_2: orange
        l_gi_light_3: red
        l_gi_light_4: yellow
        l_gi_light_5: red
        l_gi_light_6: orange
        l_gi_light_7: yellow
        l_gi_light_8: red
        l_gi_light_9: orange
        l_gi_light_10: yellow
        l_gi_light_11: orange
        l_gi_light_12: red
        l_gi_light_13: yellow
        l_gi_light_14: red
        l_gi_light_15: orange
        l_gi_light_16: yellow
        l_gi_light_17: red
        l_gi_light_18: orange
        l_gi_light_19: yellow
        l_gi_light_20: orange
        l_gi_light_21: red
        l_gi_light_22: yellow
        l_gi_light_23: red
        l_gi_light_24: orange
        l_gi_light_25: yellow
        l_gi_light_26: red
        l_gi_light_27: orange
        l_apron_light_1: yellow
        l_apron_light_2: red
        l_apron_light_3: orange
        l_apron_light_4: yellow
        l_gi_light_pop_left: red
        l_gi_light_pop_right: orange
        l_gi_light_pop_bottom: yellow
    - duration: 100ms
      lights:
        l_gi_light_1: red
        l_gi_light_2: yellow
        l_gi_light_3: orange
        l_gi_light_4: red
        l_gi_light_5: orange
        l_gi_light_6: yellow
        l_gi_light_7: red
        l_gi_light_8: orange
        l_gi_light_9: yellow
        l_gi_light_10: red
        l_gi_light_11: yellow
        l_gi_light_12: orange
        l_gi_light_13: red
        l_gi_light_14: orange
        l_gi_light_15: yellow
        l_gi_light_16: red
        l_gi_light_17: orange
        l_gi_light_18: yellow
        l_gi_light_19: red
        l_gi_light_20: yellow
        l_gi_light_21: orange
        l_gi_light_22: red
        l_gi_light_23: orange
        l_gi_light_24: yellow
        l_gi_light_25: red
        l_gi_light_26: orange
        l_gi_light_27: yellow
        l_apron_light_1: red
        l_apron_light_2: orange
        l_apron_light_3: yellow
        l_apron_light_4: red
        l_gi_light_pop_left: orange
        l_gi_light_pop_right: yellow
        l_gi_light_pop_bottom: red
    - duration: 100ms
      lights:
        l_gi_light_1: orange
        l_gi_light_2: red
        l_gi_light_3: yellow
        l_gi_light_4: orange
        l_gi_light_5: yellow
        l_gi_light_6: red
        l_gi_light_7: orange
        l_gi_light_8: yellow
        l_gi_light_9: red
        l_gi_light_10: orange
        l_gi_light_11: red
        l_gi_light_12: yellow
        l_gi_light_13: orange
        l_gi_light_14: yellow
        l_gi_light_15: red
        l_gi_light_16: orange
        l_gi_light_17: yellow
        l_gi_light_18: red
        l_gi_light_19: orange
        l_gi_light_20: red
        l_gi_light_21: yellow
        l_gi_light_22: orange
        l_gi_light_23: yellow
        l_gi_light_24: red
        l_gi_light_25: orange
        l_gi_light_26: yellow
        l_gi_light_27: red
        l_apron_light_1: orange
        l_apron_light_2: yellow
        l_apron_light_3: red
        l_apron_light_4: orange
        l_gi_light_pop_left: yellow
        l_gi_light_pop_right: red
        l_gi_light_pop_bottom: orange
    - duration: 100ms
      lights:
        l_gi_light_1: yellow
        l_gi_light_2: orange
        l_gi_light_3: red
        l_gi_light_4: yellow
        l_gi_light_5: orange
        l_gi_light_6: red
        l_gi_light_7: yellow
        l_gi_light_8: orange
        l_gi_light_9: red
        l_gi_light_10: yellow
        l_gi_light_11: orange
        l_gi_light_12: red
        l_gi_light_13: yellow
        l_gi_light_14: orange
        l_gi_light_15: red
        l_gi_light_16: yellow
        l_gi_light_17: orange
        l_gi_light_18: red
        l_gi_light_19: yellow
        l_gi_light_20: orange
        l_gi_light_21: red
        l_gi_light_22: yellow
        l_gi_light_23: orange
        l_gi_light_24: red
        l_gi_light_25: yellow
        l_gi_light_26: orange
        l_gi_light_27: red
        l_apron_light_1: yellow
        l_apron_light_2: orange
        l_apron_light_3: red
        l_apron_light_4: yellow
        l_gi_light_pop_left: red
        l_gi_light_pop_right: yellow
        l_gi_light_pop_bottom: orange

  # ICEMAN completion celebration - all letters solid orange
  # Uses a show to override light_player timing (prevents last letter staying green)
  mb_iceman_celebration:
    - duration: -1
      lights:
        l_iceman_i: orange
        l_iceman_c: orange
        l_iceman_e: orange
        l_iceman_m: orange
        l_iceman_a: orange
        l_iceman_n: orange

##############################################################################
# VARIABLE PLAYER
##############################################################################
variable_player:
  # --- MODE START: Initialize all tracking variables ---
  mode_top_gun_multiball_started:
    multiball_active:
      action: set
      int: 1
    letter_collection_paused:
      action: set
      int: 1
    pilot_qualifier_paused:
      action: set
      int: 1
    lock_collection_paused:
      action: set
      int: 1
    multiball_migs_destroyed:
      action: set
      int: 0
    multiball_migs_destroyed_wave:
      action: set
      int: 0
    multiball_jackpot_total:
      action: set
      int: 0
    multiball_last_jackpot:
      action: set
      int: 0
    multiball_wave:
      action: set
      int: 1
    multiball_super_lit:
      action: set
      int: 0
    multiball_lockon_active:
      action: set
      int: 0
    multiball_penalty_no_hold:
      action: set
      int: 0
    multiball_penalty_reversed:
      action: set
      int: 0
    multiball_penalty_gi_off:
      action: set
      int: 0
    multiball_penalty_scoring_reduced:
      action: set
      int: 0
    # Video tracking variables
    multiball_evade_toggle:
      action: set
      int: 0
    multiball_hit_index:
      action: set
      int: 0
    multiball_explosion_index:
      action: set
      int: 0
    multiball_intro_done:
      action: set
      int: 0
    # ICEMAN add-a-ball tracking (separate from main ICEMAN progress)
    mb_iceman_i:
      action: set
      int: 0
    mb_iceman_c:
      action: set
      int: 0
    mb_iceman_e:
      action: set
      int: 0
    mb_iceman_m:
      action: set
      int: 0
    mb_iceman_a:
      action: set
      int: 0
    mb_iceman_n:
      action: set
      int: 0
    mb_iceman_completions:
      action: set
      int: 0
    mb_add_a_ball_ready:
      action: set
      int: 0
    mb_add_a_balls_used:
      action: set
      int: 0
    # Multiball extender tracking
    mb_extender_used:
      action: set
      int: 0
    # Jackpot decay tracking (MPF-side scoring)
    mig_jackpot_left_orbit:
      action: set
      int: 0
    mig_jackpot_left_ramp:
      action: set
      int: 0
    mig_jackpot_spinner:
      action: set
      int: 0
    mig_jackpot_barrier:
      action: set
      int: 0
    mig_jackpot_tower:
      action: set
      int: 0
    mig_jackpot_top_orbit:
      action: set
      int: 0
    mig_jackpot_top_ramp:
      action: set
      int: 0
    mig_jackpot_right_ramp:
      action: set
      int: 0
    # Wave scoring multiplier (100 = 1x, 115 = 1.15x, etc.)
    multiball_wave_multiplier_pct:
      action: set
      int: 100
    # Evasion target tracking (set by Godot via radar_evasion_shot_[id])
    multiball_evasion_left_orbit:
      action: set
      int: 0
    multiball_evasion_left_ramp:
      action: set
      int: 0
    multiball_evasion_spinner:
      action: set
      int: 0
    multiball_evasion_barrier:
      action: set
      int: 0
    multiball_evasion_tower:
      action: set
      int: 0
    multiball_evasion_top_ramp:
      action: set
      int: 0
    multiball_evasion_right_ramp:
      action: set
      int: 0

  # --- MIG ACTIVATION: Track which MIGs are on the radar ---
  radar_activate_mig_left_orbit:
    mig_left_orbit_active:
      action: set
      int: 1
    mig_jackpot_left_orbit:
      action: set
      int: 500000 * current_player.multiball_wave_multiplier_pct / 100
  radar_deactivate_mig_left_orbit:
    mig_left_orbit_active:
      action: set
      int: 0
  radar_activate_mig_left_ramp:
    mig_left_ramp_active:
      action: set
      int: 1
    mig_jackpot_left_ramp:
      action: set
      int: 500000 * current_player.multiball_wave_multiplier_pct / 100
  radar_deactivate_mig_left_ramp:
    mig_left_ramp_active:
      action: set
      int: 0
  radar_activate_mig_spinner:
    mig_spinner_active:
      action: set
      int: 1
    mig_jackpot_spinner:
      action: set
      int: 500000 * current_player.multiball_wave_multiplier_pct / 100
  radar_deactivate_mig_spinner:
    mig_spinner_active:
      action: set
      int: 0
  radar_activate_mig_barrier:
    mig_barrier_active:
      action: set
      int: 1
    mig_jackpot_barrier:
      action: set
      int: 500000 * current_player.multiball_wave_multiplier_pct / 100
  radar_deactivate_mig_barrier:
    mig_barrier_active:
      action: set
      int: 0
  radar_activate_mig_tower:
    mig_tower_active:
      action: set
      int: 1
    mig_jackpot_tower:
      action: set
      int: 750000 * current_player.multiball_wave_multiplier_pct / 100
  radar_deactivate_mig_tower:
    mig_tower_active:
      action: set
      int: 0
  radar_activate_mig_top_orbit:
    mig_top_orbit_active:
      action: set
      int: 1
    mig_jackpot_top_orbit:
      action: set
      int: 1000000 * current_player.multiball_wave_multiplier_pct / 100
  radar_deactivate_mig_top_orbit:
    mig_top_orbit_active:
      action: set
      int: 0
  radar_activate_mig_top_ramp:
    mig_top_ramp_active:
      action: set
      int: 1
    mig_jackpot_top_ramp:
      action: set
      int: 1250000 * current_player.multiball_wave_multiplier_pct / 100
  radar_deactivate_mig_top_ramp:
    mig_top_ramp_active:
      action: set
      int: 0
  radar_activate_mig_right_ramp:
    mig_right_ramp_active:
      action: set
      int: 1
    mig_jackpot_right_ramp:
      action: set
      int: 750000 * current_player.multiball_wave_multiplier_pct / 100
  radar_deactivate_mig_right_ramp:
    mig_right_ramp_active:
      action: set
      int: 0

  # --- MIG HIT: Capture current jackpot value before Godot confirms destroy ---
  # MPF detects the shot hit BEFORE Godot posts radar_mig_destroyed.
  # Set multiball_last_jackpot so the destroy handler can score it.
  multiball_mig_hit_left_orbit:
    multiball_last_jackpot:
      action: set
      int: current_player.mig_jackpot_left_orbit
  multiball_mig_hit_left_ramp:
    multiball_last_jackpot:
      action: set
      int: current_player.mig_jackpot_left_ramp
  multiball_mig_hit_spinner:
    multiball_last_jackpot:
      action: set
      int: current_player.mig_jackpot_spinner
  multiball_mig_hit_barrier:
    multiball_last_jackpot:
      action: set
      int: current_player.mig_jackpot_barrier
  multiball_mig_hit_tower:
    multiball_last_jackpot:
      action: set
      int: current_player.mig_jackpot_tower
  multiball_mig_hit_top_orbit:
    multiball_last_jackpot:
      action: set
      int: current_player.mig_jackpot_top_orbit
  multiball_mig_hit_top_ramp:
    multiball_last_jackpot:
      action: set
      int: current_player.mig_jackpot_top_ramp
  multiball_mig_hit_right_ramp:
    multiball_last_jackpot:
      action: set
      int: current_player.mig_jackpot_right_ramp

  # --- MIG DESTROYED (multiball_last_jackpot set by hit handler above) ---
  radar_mig_destroyed:
    score:
      action: add
      int: current_player.multiball_last_jackpot * current_player.total_scoring_multiplier
    multiball_migs_destroyed:
      action: add
      int: 1
    multiball_migs_destroyed_wave:
      action: add
      int: 1
    multiball_jackpot_total:
      action: add
      int: current_player.multiball_last_jackpot
    mode_points_scored:
      action: set
      int: current_player.multiball_last_jackpot * current_player.total_scoring_multiplier

  # --- MIG DESTROYED NO SCORE (during 10% penalty, score already reduced) ---
  radar_mig_destroyed_no_score:
    multiball_migs_destroyed:
      action: add
      int: 1

  # --- EVASION TARGET ACTIVATION (Godot posts radar_evasion_shot_[id]) ---
  # Each event sets the corresponding evasion flag + clears all others
  radar_evasion_shot_left_orbit:
    multiball_evasion_left_orbit: { action: set, int: 1 }
    multiball_evasion_left_ramp: { action: set, int: 0 }
    multiball_evasion_spinner: { action: set, int: 0 }
    multiball_evasion_barrier: { action: set, int: 0 }
    multiball_evasion_tower: { action: set, int: 0 }
    multiball_evasion_top_ramp: { action: set, int: 0 }
    multiball_evasion_right_ramp: { action: set, int: 0 }
  radar_evasion_shot_left_ramp:
    multiball_evasion_left_orbit: { action: set, int: 0 }
    multiball_evasion_left_ramp: { action: set, int: 1 }
    multiball_evasion_spinner: { action: set, int: 0 }
    multiball_evasion_barrier: { action: set, int: 0 }
    multiball_evasion_tower: { action: set, int: 0 }
    multiball_evasion_top_ramp: { action: set, int: 0 }
    multiball_evasion_right_ramp: { action: set, int: 0 }
  radar_evasion_shot_spinner:
    multiball_evasion_left_orbit: { action: set, int: 0 }
    multiball_evasion_left_ramp: { action: set, int: 0 }
    multiball_evasion_spinner: { action: set, int: 1 }
    multiball_evasion_barrier: { action: set, int: 0 }
    multiball_evasion_tower: { action: set, int: 0 }
    multiball_evasion_top_ramp: { action: set, int: 0 }
    multiball_evasion_right_ramp: { action: set, int: 0 }
  radar_evasion_shot_barrier:
    multiball_evasion_left_orbit: { action: set, int: 0 }
    multiball_evasion_left_ramp: { action: set, int: 0 }
    multiball_evasion_spinner: { action: set, int: 0 }
    multiball_evasion_barrier: { action: set, int: 1 }
    multiball_evasion_tower: { action: set, int: 0 }
    multiball_evasion_top_ramp: { action: set, int: 0 }
    multiball_evasion_right_ramp: { action: set, int: 0 }
  radar_evasion_shot_tower:
    multiball_evasion_left_orbit: { action: set, int: 0 }
    multiball_evasion_left_ramp: { action: set, int: 0 }
    multiball_evasion_spinner: { action: set, int: 0 }
    multiball_evasion_barrier: { action: set, int: 0 }
    multiball_evasion_tower: { action: set, int: 1 }
    multiball_evasion_top_ramp: { action: set, int: 0 }
    multiball_evasion_right_ramp: { action: set, int: 0 }
  radar_evasion_shot_top_ramp:
    multiball_evasion_left_orbit: { action: set, int: 0 }
    multiball_evasion_left_ramp: { action: set, int: 0 }
    multiball_evasion_spinner: { action: set, int: 0 }
    multiball_evasion_barrier: { action: set, int: 0 }
    multiball_evasion_tower: { action: set, int: 0 }
    multiball_evasion_top_ramp: { action: set, int: 1 }
    multiball_evasion_right_ramp: { action: set, int: 0 }
  radar_evasion_shot_right_ramp:
    multiball_evasion_left_orbit: { action: set, int: 0 }
    multiball_evasion_left_ramp: { action: set, int: 0 }
    multiball_evasion_spinner: { action: set, int: 0 }
    multiball_evasion_barrier: { action: set, int: 0 }
    multiball_evasion_tower: { action: set, int: 0 }
    multiball_evasion_top_ramp: { action: set, int: 0 }
    multiball_evasion_right_ramp: { action: set, int: 1 }

  # --- EVASION SUCCESS ---
  radar_evasion_success:
    score:
      action: add
      int: 50000 * current_player.total_scoring_multiplier
    multiball_lockon_active:
      action: set
      int: 0
    # Clear all evasion flags
    multiball_evasion_left_orbit: { action: set, int: 0 }
    multiball_evasion_left_ramp: { action: set, int: 0 }
    multiball_evasion_spinner: { action: set, int: 0 }
    multiball_evasion_barrier: { action: set, int: 0 }
    multiball_evasion_tower: { action: set, int: 0 }
    multiball_evasion_top_ramp: { action: set, int: 0 }
    multiball_evasion_right_ramp: { action: set, int: 0 }

  # --- EVASION FAILED ---
  radar_evasion_failed:
    multiball_lockon_active:
      action: set
      int: 0
    # Clear all evasion flags
    multiball_evasion_left_orbit: { action: set, int: 0 }
    multiball_evasion_left_ramp: { action: set, int: 0 }
    multiball_evasion_spinner: { action: set, int: 0 }
    multiball_evasion_barrier: { action: set, int: 0 }
    multiball_evasion_tower: { action: set, int: 0 }
    multiball_evasion_top_ramp: { action: set, int: 0 }
    multiball_evasion_right_ramp: { action: set, int: 0 }

  # --- LOCK-ON START ---
  radar_mig_lockon:
    multiball_lockon_active:
      action: set
      int: 1

  # --- SUPER JACKPOT ---
  radar_super_jackpot_lit:
    multiball_super_lit:
      action: set
      int: 1
    # Clear lockon/evasion state (super overrides lockon)
    multiball_lockon_active:
      action: set
      int: 0
    multiball_evasion_left_orbit: { action: set, int: 0 }
    multiball_evasion_left_ramp: { action: set, int: 0 }
    multiball_evasion_spinner: { action: set, int: 0 }
    multiball_evasion_barrier: { action: set, int: 0 }
    multiball_evasion_tower: { action: set, int: 0 }
    multiball_evasion_top_ramp: { action: set, int: 0 }
    multiball_evasion_right_ramp: { action: set, int: 0 }

  radar_super_jackpot_collected:
    score:
      action: add
      int: current_player.multiball_jackpot_total * current_player.total_scoring_multiplier
    mode_points_scored:
      action: set
      int: current_player.multiball_jackpot_total * current_player.total_scoring_multiplier
    multiball_super_lit:
      action: set
      int: 0
    multiball_migs_destroyed_wave:
      action: set
      int: 0
    multiball_jackpot_total:
      action: set
      int: 0

  # --- WAVE ADVANCE ---
  radar_wave_advance:
    multiball_wave:
      action: add
      int: 1

  # Wave scoring multiplier (conditions check POST-increment value)
  # Wave 2: 15% better scoring
  radar_wave_advance{current_player.multiball_wave==2}:
    multiball_wave_multiplier_pct:
      action: set
      int: 115
  # Wave 3: 25% better
  radar_wave_advance{current_player.multiball_wave==3}:
    multiball_wave_multiplier_pct:
      action: set
      int: 125
  # Wave 4: 50% better
  radar_wave_advance{current_player.multiball_wave==4}:
    multiball_wave_multiplier_pct:
      action: set
      int: 150
  # Wave 5: 75% better
  radar_wave_advance{current_player.multiball_wave==5}:
    multiball_wave_multiplier_pct:
      action: set
      int: 175
  # Wave 6+: 2x scoring
  radar_wave_advance{current_player.multiball_wave>=6}:
    multiball_wave_multiplier_pct:
      action: set
      int: 200

  # --- JACKPOT DECAY: Reduce MIG jackpot values every second ---
  # EASY shots: 500K→100K over 30s = 13333/s decay
  timer_mig_jackpot_decay_tick{current_player.mig_left_orbit_active==1 and current_player.mig_jackpot_left_orbit>100000}:
    mig_jackpot_left_orbit:
      action: add
      int: -13333
  timer_mig_jackpot_decay_tick{current_player.mig_left_ramp_active==1 and current_player.mig_jackpot_left_ramp>100000}:
    mig_jackpot_left_ramp:
      action: add
      int: -13333
  timer_mig_jackpot_decay_tick{current_player.mig_spinner_active==1 and current_player.mig_jackpot_spinner>100000}:
    mig_jackpot_spinner:
      action: add
      int: -13333
  timer_mig_jackpot_decay_tick{current_player.mig_barrier_active==1 and current_player.mig_jackpot_barrier>100000}:
    mig_jackpot_barrier:
      action: add
      int: -13333
  # MEDIUM shots: 750K→150K over 60s = 10000/s decay
  timer_mig_jackpot_decay_tick{current_player.mig_tower_active==1 and current_player.mig_jackpot_tower>150000}:
    mig_jackpot_tower:
      action: add
      int: -10000
  timer_mig_jackpot_decay_tick{current_player.mig_right_ramp_active==1 and current_player.mig_jackpot_right_ramp>150000}:
    mig_jackpot_right_ramp:
      action: add
      int: -10000
  # HARD shot: 1M→200K over 90s = 8889/s decay
  timer_mig_jackpot_decay_tick{current_player.mig_top_orbit_active==1 and current_player.mig_jackpot_top_orbit>200000}:
    mig_jackpot_top_orbit:
      action: add
      int: -8889
  # SUPER HARD shot: 1.25M→250K over 90s = 11111/s decay
  timer_mig_jackpot_decay_tick{current_player.mig_top_ramp_active==1 and current_player.mig_jackpot_top_ramp>250000}:
    mig_jackpot_top_ramp:
      action: add
      int: -11111

  # --- PENALTY TRACKING ---
  radar_penalty_no_hold:
    multiball_penalty_no_hold:
      action: set
      int: 1
  radar_penalty_reversed:
    multiball_penalty_reversed:
      action: set
      int: 1
  radar_penalty_gi_off:
    multiball_penalty_gi_off:
      action: set
      int: 1
  radar_penalty_scoring_reduced:
    multiball_penalty_scoring_reduced:
      action: set
      int: 1
  radar_penalty_progress_reset:
    multiball_migs_destroyed_wave:
      action: set
      int: 0

  # --- PENALTY END ---
  radar_penalty_no_hold_ended:
    multiball_penalty_no_hold:
      action: set
      int: 0
  radar_penalty_reversed_ended:
    multiball_penalty_reversed:
      action: set
      int: 0
  radar_penalty_gi_off_ended:
    multiball_penalty_gi_off:
      action: set
      int: 0
  radar_penalty_scoring_reduced_ended:
    multiball_penalty_scoring_reduced:
      action: set
      int: 0

  # --- VIDEO TRACKING: Evade toggle (set on video play to avoid same-tick race) ---
  mb_play_evade_1:
    multiball_evade_toggle:
      action: set
      int: 1
  mb_play_evade_2:
    multiball_evade_toggle:
      action: set
      int: 0

  # --- VIDEO TRACKING: Hit index (cycles 0→1→2→0) ---
  mb_advance_hit_index{current_player.multiball_hit_index==0}:
    multiball_hit_index:
      action: set
      int: 1
  mb_advance_hit_index{current_player.multiball_hit_index==1}:
    multiball_hit_index:
      action: set
      int: 2
  mb_advance_hit_index{current_player.multiball_hit_index>=2}:
    multiball_hit_index:
      action: set
      int: 0

  # --- VIDEO TRACKING: Explosion index (cycles 0→1→2→0) ---
  # Advance AFTER each specific explosion plays (cascade-free)
  mb_play_explosion_1:
    multiball_explosion_index:
      action: set
      int: 1
  mb_play_explosion_2:
    multiball_explosion_index:
      action: set
      int: 2
  mb_play_explosion_3:
    multiball_explosion_index:
      action: set
      int: 0

  # --- INTRO DONE ---
  mb_gameplay_start:
    multiball_intro_done:
      action: set
      int: 1

  # --- MODE END ---
  mode_top_gun_multiball_will_stop:
    multiball_active:
      action: set
      int: 0

  ##############################################
  ## ICEMAN ADD-A-BALL LETTER COLLECTION
  ## Only collects when: add-a-ball not ready AND fewer than 2 used
  ##############################################
  s_i_iceman_target_active{current_player.mb_iceman_i==0 and current_player.mb_add_a_ball_ready==0 and current_player.mb_add_a_balls_used<2}:
    mb_iceman_i:
      action: set
      int: 1
  s_c_iceman_target_active{current_player.mb_iceman_c==0 and current_player.mb_add_a_ball_ready==0 and current_player.mb_add_a_balls_used<2}:
    mb_iceman_c:
      action: set
      int: 1
  s_e_iceman_target_active{current_player.mb_iceman_e==0 and current_player.mb_add_a_ball_ready==0 and current_player.mb_add_a_balls_used<2}:
    mb_iceman_e:
      action: set
      int: 1
  s_m_iceman_target_active{current_player.mb_iceman_m==0 and current_player.mb_add_a_ball_ready==0 and current_player.mb_add_a_balls_used<2}:
    mb_iceman_m:
      action: set
      int: 1
  s_a_iceman_target_active{current_player.mb_iceman_a==0 and current_player.mb_add_a_ball_ready==0 and current_player.mb_add_a_balls_used<2}:
    mb_iceman_a:
      action: set
      int: 1
  s_n_iceman_target_active{current_player.mb_iceman_n==0 and current_player.mb_add_a_ball_ready==0 and current_player.mb_add_a_balls_used<2}:
    mb_iceman_n:
      action: set
      int: 1

  # ICEMAN completion: increment completions, reset letters for next round
  mb_iceman_complete:
    mb_iceman_completions:
      action: add
      int: 1
    # Reset ICEMAN letters for next completion
    mb_iceman_i:
      action: set
      int: 0
    mb_iceman_c:
      action: set
      int: 0
    mb_iceman_e:
      action: set
      int: 0
    mb_iceman_m:
      action: set
      int: 0
    mb_iceman_a:
      action: set
      int: 0
    mb_iceman_n:
      action: set
      int: 0

  # Add-a-ball QUALIFIED (completions 1 and 3 only): set ready flag
  mb_add_a_ball_qualified:
    mb_add_a_ball_ready:
      action: set
      int: 1

  # Add-a-ball activated: clear ready flag, increment used, reset letters
  mb_add_a_ball_activate:
    mb_add_a_ball_ready:
      action: set
      int: 0
    mb_add_a_balls_used:
      action: add
      int: 1
    mb_iceman_i:
      action: set
      int: 0
    mb_iceman_c:
      action: set
      int: 0
    mb_iceman_e:
      action: set
      int: 0
    mb_iceman_m:
      action: set
      int: 0
    mb_iceman_a:
      action: set
      int: 0
    mb_iceman_n:
      action: set
      int: 0

  # Extender activated: mark as used
  mb_extender_activate:
    mb_extender_used:
      action: set
      int: 1

##############################################################################
# EVENT PLAYER - Shot Detection & Penalty Routing
##############################################################################
event_player:
  # ===== MIG SHOT DETECTION =====
  # Each shot checks if its MIG is active, then posts the hit event to Godot
  left_orbit_shot_hit{current_player.mig_left_orbit_active==1}:
    - multiball_mig_hit_left_orbit

  s_ramp_left_exit_active{current_player.mig_left_ramp_active==1}:
    - multiball_mig_hit_left_ramp

  spinner_shot_made{current_player.mig_spinner_active==1}:
    - multiball_mig_hit_spinner

  s_barrier_target_active{current_player.mig_barrier_active==1}:
    - multiball_mig_hit_barrier

  # Super jackpot collection - barrier target when super is lit
  # Post radar_super_jackpot_hit → Godot's _on_super() fires → 
  # Godot posts radar_super_jackpot_collected + radar_wave_advance + spawns wave 2
  s_barrier_target_active{current_player.multiball_super_lit==1}:
    - radar_super_jackpot_hit

  s_ramp_tower_exit_active{current_player.mig_tower_active==1}:
    - multiball_mig_hit_tower

  s_orbit_lower_active{current_player.mig_top_orbit_active==1}:
    - multiball_mig_hit_top_orbit

  s_ramp_inner_exit_active{current_player.mig_top_ramp_active==1}:
    - multiball_mig_hit_top_ramp

  s_ramp_right_exit_active{current_player.mig_right_ramp_active==1}:
    - multiball_mig_hit_right_ramp

  # ===== EVASION SHOT DETECTION =====
  # When a MIG locks on, Godot sets which shot is the evasion target
  # These check if the evasion flag is set for that shot
  left_orbit_shot_hit{current_player.multiball_evasion_left_orbit==1}:
    - radar_evasion_hit
  s_ramp_left_exit_active{current_player.multiball_evasion_left_ramp==1}:
    - radar_evasion_hit
  spinner_shot_made{current_player.multiball_evasion_spinner==1}:
    - radar_evasion_hit
  s_barrier_target_active{current_player.multiball_evasion_barrier==1}:
    - radar_evasion_hit
  s_ramp_tower_exit_active{current_player.multiball_evasion_tower==1}:
    - radar_evasion_hit
  s_ramp_inner_exit_active{current_player.multiball_evasion_top_ramp==1}:
    - radar_evasion_hit
  s_ramp_right_exit_active{current_player.multiball_evasion_right_ramp==1}:
    - radar_evasion_hit

  # ===== PENALTY: NO HOLD FLIPPERS =====
  radar_penalty_no_hold:
    - disable_flippers
    - enable_no_hold_flippers
  timer_penalty_no_hold_timer_complete:
    - disable_no_hold_flippers
    - enable_flippers
    - radar_penalty_no_hold_ended

  # ===== PENALTY: REVERSED FLIPPERS =====
  radar_penalty_reversed:
    - disable_flippers
    - enable_reversed_flippers
  timer_penalty_reversed_timer_complete:
    - disable_reversed_flippers
    - enable_flippers
    - radar_penalty_reversed_ended

  # ===== PENALTY: GI OFF =====
  # (light_player handles the actual GI control below)
  timer_penalty_gi_off_timer_complete:
    - radar_penalty_gi_off_ended

  # ===== PENALTY: SCORING REDUCED =====
  timer_penalty_scoring_reduced_timer_complete:
    - radar_penalty_scoring_reduced_ended

  # ===== MODE CLEANUP =====
  mode_top_gun_multiball_will_stop:
    - disable_reversed_flippers
    - disable_no_hold_flippers
    - enable_flippers

  # ===== INTRO VIDEO FLOW =====
  # If no pilot mission active: play intro video, raise barrier
  # If pilot mission active: skip intro, go straight to gameplay
  mode_top_gun_multiball_started{current_player.pilot_mode_active==0}:
    - mb_intro_start
    - barrier_raise

  mode_top_gun_multiball_started{current_player.pilot_mode_active==1}:
    - mb_gameplay_start
    - mb_balls_release
    - mb_start_music
    - mb_play_intro_instructions

  # ===== SKIP INTRO (both flippers) =====
  s_flipper_left_active{current_player.multiball_intro_done==0 and device.timers.mb_intro_video_delay.running}:
    - mb_check_skip_intro
  s_flipper_right_active{current_player.multiball_intro_done==0 and device.timers.mb_intro_video_delay.running}:
    - mb_check_skip_intro
  mb_check_skip_intro{device.switches.s_flipper_left.state and device.switches.s_flipper_right.state}:
    - mb_skip_intro

  # Skip path: drop barrier, release balls, start music + gameplay
  mb_skip_intro:
    - barrier_drop
    - mb_gameplay_start
    - mb_balls_release
    - mb_start_music
    - mb_stop_preview_lights

  # Music starts at 56 seconds into intro video
  timer_mb_intro_music_delay_complete:
    - mb_start_music

  # Normal path: intro video finishes → drop barrier, release, start
  timer_mb_intro_video_delay_complete:
    - barrier_drop
    - mb_gameplay_start
    - mb_balls_release
    - mb_stop_preview_lights

  # Barrier raise after scoop ball clears
  timer_mb_barrier_delay_complete:
    - barrier_raise

  # ===== EVADE VIDEOS (toggle evade_1 / evade_2) =====
  # Toggle moves to variable_player on mb_play_evade events to prevent same-tick race
  radar_evasion_success{current_player.multiball_evade_toggle==0}:
    - mb_play_evade_1
  radar_evasion_success{current_player.multiball_evade_toggle==1}:
    - mb_play_evade_2

  # ===== HIT VIDEOS (cycle hit_1/hit_2/hit_3 after 3s callout delay) =====
  timer_mb_hit_video_delay_complete{current_player.multiball_hit_index==0}:
    - mb_play_hit_1
    - mb_advance_hit_index
  timer_mb_hit_video_delay_complete{current_player.multiball_hit_index==1}:
    - mb_play_hit_2
    - mb_advance_hit_index
  timer_mb_hit_video_delay_complete{current_player.multiball_hit_index>=2}:
    - mb_play_hit_3
    - mb_advance_hit_index

  # ===== EXPLOSION VIDEOS (cycle 1/2/3 with cooldown) =====
  # Only play if cooldown timer is NOT running (prevents overlap)
  radar_mig_destroyed{device.timers.mb_explosion_cooldown.running==False}:
    - mb_play_explosion_video
  radar_mig_destroyed_no_score{device.timers.mb_explosion_cooldown.running==False}:
    - mb_play_explosion_video

  # Route to correct video based on index (advance handled by variable_player on play events)
  mb_play_explosion_video{current_player.multiball_explosion_index==0}:
    - mb_play_explosion_1
  mb_play_explosion_video{current_player.multiball_explosion_index==1}:
    - mb_play_explosion_2
  mb_play_explosion_video{current_player.multiball_explosion_index>=2}:
    - mb_play_explosion_3

  # GI explosion show triggers 1.25 seconds after video starts
  timer_mb_explosion_gi_delay_complete:
    - radar_mig_explosion

  # GI explosion show stops 3 seconds after it starts
  timer_mb_explosion_gi_stop_complete:
    - mb_stop_explosion_gi

  # ===== INTRO PREVIEW LIGHT TIMERS =====
  # At 23.5s: light RR + TWR preview
  timer_mb_intro_preview_2_complete:
    - mb_preview_group_2

  # At 34s: light SP preview
  timer_mb_intro_preview_3_complete:
    - mb_preview_group_3

  # At 38s: play instructions voice callout
  timer_mb_intro_instructions_delay_complete:
    - mb_play_intro_instructions

  # ===== ICEMAN ADD-A-BALL COMPLETION CHECK =====
  # Each letter check: the letter being hit is 0, other 5 must be 1
  s_i_iceman_target_active{current_player.mb_iceman_i==0 and current_player.mb_iceman_c==1 and current_player.mb_iceman_e==1 and current_player.mb_iceman_m==1 and current_player.mb_iceman_a==1 and current_player.mb_iceman_n==1 and current_player.mb_add_a_ball_ready==0 and current_player.mb_add_a_balls_used<2}:
    - mb_iceman_complete
  s_c_iceman_target_active{current_player.mb_iceman_i==1 and current_player.mb_iceman_c==0 and current_player.mb_iceman_e==1 and current_player.mb_iceman_m==1 and current_player.mb_iceman_a==1 and current_player.mb_iceman_n==1 and current_player.mb_add_a_ball_ready==0 and current_player.mb_add_a_balls_used<2}:
    - mb_iceman_complete
  s_e_iceman_target_active{current_player.mb_iceman_i==1 and current_player.mb_iceman_c==1 and current_player.mb_iceman_e==0 and current_player.mb_iceman_m==1 and current_player.mb_iceman_a==1 and current_player.mb_iceman_n==1 and current_player.mb_add_a_ball_ready==0 and current_player.mb_add_a_balls_used<2}:
    - mb_iceman_complete
  s_m_iceman_target_active{current_player.mb_iceman_i==1 and current_player.mb_iceman_c==1 and current_player.mb_iceman_e==1 and current_player.mb_iceman_m==0 and current_player.mb_iceman_a==1 and current_player.mb_iceman_n==1 and current_player.mb_add_a_ball_ready==0 and current_player.mb_add_a_balls_used<2}:
    - mb_iceman_complete
  s_a_iceman_target_active{current_player.mb_iceman_i==1 and current_player.mb_iceman_c==1 and current_player.mb_iceman_e==1 and current_player.mb_iceman_m==1 and current_player.mb_iceman_a==0 and current_player.mb_iceman_n==1 and current_player.mb_add_a_ball_ready==0 and current_player.mb_add_a_balls_used<2}:
    - mb_iceman_complete
  s_n_iceman_target_active{current_player.mb_iceman_i==1 and current_player.mb_iceman_c==1 and current_player.mb_iceman_e==1 and current_player.mb_iceman_m==1 and current_player.mb_iceman_a==1 and current_player.mb_iceman_n==0 and current_player.mb_add_a_ball_ready==0 and current_player.mb_add_a_balls_used<2}:
    - mb_iceman_complete

  # ===== PILOT GEAR TARGET: ACTIVATE ADD-A-BALL =====
  s_flight_gear_target_active{current_player.mb_add_a_ball_ready==1}:
    - mb_add_a_ball_activate

  # Add-a-ball QUALIFIES on completions 1 and 3 (like inverted pattern)
  # Uses player variable change event which fires AFTER the increment
  player_mb_iceman_completions{value==1}:
    - mb_add_a_ball_qualified
  player_mb_iceman_completions{value==3}:
    - mb_add_a_ball_qualified

  # ICEMAN celebration timer complete: reset lights ONLY if NOT qualified
  # When qualified (ready=1), lights stay orange until pilot gear hit
  timer_mb_iceman_celebration_timer_complete{current_player.mb_add_a_ball_ready==0 and current_player.mb_add_a_balls_used<2}:
    - mb_iceman_reset_lights

  # ===== MULTIBALL END ROUTING (Extender Perk) =====
  # Normal end: no wingman perk or extender already used
  multiball_top_gun_multiball_ended{current_player.wingman_perk_active==0 or current_player.mb_extender_used==1}:
    - mb_multiball_final_end

  # Extender perk active and not yet used: activate extension
  multiball_top_gun_multiball_ended{current_player.wingman_perk_active==1 and current_player.mb_extender_used==0}:
    - mb_extender_activate

  # Extender callout delay complete: start extender multiball
  timer_mb_extender_callout_delay_complete:
    - mb_extender_start

  # Extender multiball ends: mode is truly over
  multiball_top_gun_multiball_extender_ended:
    - mb_multiball_final_end

##############################################################################
# TIMERS - One per stackable penalty
##############################################################################
timers:
  penalty_no_hold_timer:
    start_value: 20
    end_value: 0
    direction: down
    tick_interval: 1s
    start_running: false
    control_events:
      - event: radar_penalty_no_hold
        action: restart

  penalty_reversed_timer:
    start_value: 20
    end_value: 0
    direction: down
    tick_interval: 1s
    start_running: false
    control_events:
      - event: radar_penalty_reversed
        action: restart

  penalty_gi_off_timer:
    start_value: 20
    end_value: 0
    direction: down
    tick_interval: 1s
    start_running: false
    control_events:
      - event: radar_penalty_gi_off
        action: restart

  penalty_scoring_reduced_timer:
    start_value: 20
    end_value: 0
    direction: down
    tick_interval: 1s
    start_running: false
    control_events:
      - event: radar_penalty_scoring_reduced
        action: restart

  ##############################################################################
  # INTRO VIDEO TIMER - 78 seconds (full video length)
  ##############################################################################
  mb_intro_video_delay:
    start_value: 0
    end_value: 78
    direction: up
    tick_interval: 1s
    start_running: false
    control_events:
      - event: mb_intro_start
        action: start
      - event: mb_skip_intro
        action: stop
      - event: mode_top_gun_multiball_will_stop
        action: stop

  # Music starts at 56 seconds into intro video
  mb_intro_music_delay:
    start_value: 0
    end_value: 56
    direction: up
    tick_interval: 1s
    start_running: false
    control_events:
      - event: mb_intro_start
        action: start
      - event: mb_skip_intro
        action: stop
      - event: mode_top_gun_multiball_will_stop
        action: stop

  ##############################################################################
  # HIT VIDEO DELAY - 3 seconds after penalty (let callout finish)
  ##############################################################################
  mb_hit_video_delay:
    start_value: 0
    end_value: 3
    direction: up
    tick_interval: 1s
    start_running: false
    control_events:
      - event: radar_evasion_failed
        action: restart
      - event: mode_top_gun_multiball_will_stop
        action: stop

  ##############################################################################
  # EXPLOSION VIDEO COOLDOWN - 4 seconds (prevents overlap of 3.1s videos)
  ##############################################################################
  mb_explosion_cooldown:
    start_value: 0
    end_value: 4
    direction: up
    tick_interval: 1s
    start_running: false
    control_events:
      - event: mb_play_explosion_video
        action: restart
      - event: mode_top_gun_multiball_will_stop
        action: stop

  # GI explosion delay - 1.75 seconds after explosion video starts
  mb_explosion_gi_delay:
    start_value: 0
    end_value: 1750
    direction: up
    tick_interval: 1ms
    start_running: false
    control_events:
      - event: mb_play_explosion_video
        action: restart
      - event: mode_top_gun_multiball_will_stop
        action: stop

  # GI explosion stop - 3 seconds after GI explosion starts
  mb_explosion_gi_stop:
    start_value: 0
    end_value: 3
    direction: up
    tick_interval: 1s
    start_running: false
    control_events:
      - event: radar_mig_explosion
        action: restart
      - event: mode_top_gun_multiball_will_stop
        action: stop

  ##############################################################################
  # BARRIER DELAY - After scoop eject during MB start (rescue_cougar pattern)
  ##############################################################################
  mb_barrier_delay:
    start_value: 0
    end_value: 750
    direction: up
    tick_interval: 1ms
    start_running: false
    control_events:
      - event: timer_mb_eject_debounce_complete
        action: restart

  mb_eject_debounce:
    start_value: 0
    end_value: 150
    direction: up
    tick_interval: 1ms
    start_running: false
    control_events:
      - event: s_mode_start_inactive{current_player.multiball_intro_done==1}
        action: restart
      - event: s_mode_start_active
        action: stop

  ##############################################################################
  # JACKPOT DECAY TIMER - Ticks every 1s to reduce MIG jackpot values
  # Posts timer_mig_jackpot_decay_tick each second during multiball gameplay
  ##############################################################################
  mig_jackpot_decay:
    start_value: 0
    end_value: 999
    direction: up
    tick_interval: 1s
    start_running: false
    control_events:
      - event: mb_gameplay_start
        action: start
      - event: mode_top_gun_multiball_will_stop
        action: stop
      # Pause decay during lockon (MIGs are paused in Godot too)
      - event: radar_mig_lockon
        action: stop
      - event: radar_evasion_success
        action: start
      - event: radar_evasion_failed
        action: start
      - event: radar_super_jackpot_lit
        action: start

  ##############################################################################
  # INTRO PREVIEW TIMERS - Stagger shot insert lighting during intro video
  ##############################################################################

  # Preview group 2 at 23.5 seconds (RR + TWR)
  mb_intro_preview_2:
    start_value: 0
    end_value: 47
    direction: up
    tick_interval: 500ms
    start_running: false
    control_events:
      - event: mb_intro_start
        action: start
      - event: mb_skip_intro
        action: stop
      - event: mode_top_gun_multiball_will_stop
        action: stop

  # Preview group 3 at 34 seconds (SP)
  mb_intro_preview_3:
    start_value: 0
    end_value: 68
    direction: up
    tick_interval: 500ms
    start_running: false
    control_events:
      - event: mb_intro_start
        action: start
      - event: mb_skip_intro
        action: stop
      - event: mode_top_gun_multiball_will_stop
        action: stop

  # Instructions voice callout at 38 seconds
  mb_intro_instructions_delay:
    start_value: 0
    end_value: 76
    direction: up
    tick_interval: 500ms
    start_running: false
    control_events:
      - event: mb_intro_start
        action: start
      - event: mb_skip_intro
        action: stop
      - event: mode_top_gun_multiball_will_stop
        action: stop

  ##############################################################################
  # ICEMAN CELEBRATION TIMER - 1 second flash before resetting lights
  ##############################################################################
  mb_iceman_celebration_timer:
    start_value: 0
    end_value: 1
    direction: up
    tick_interval: 1s
    start_running: false
    control_events:
      - event: mb_iceman_complete
        action: restart
      - event: mode_top_gun_multiball_will_stop
        action: stop

  ##############################################################################
  # EXTENDER CALLOUT DELAY - 5 seconds for voice + slide before adding ball
  ##############################################################################
  mb_extender_callout_delay:
    start_value: 0
    end_value: 5
    direction: up
    tick_interval: 1s
    start_running: false
    control_events:
      - event: mb_extender_activate
        action: start
      - event: mode_top_gun_multiball_will_stop
        action: stop

  ##############################################################################
  # AUTO-PLUNGER DELAY - 1 second after ball settles on shooter lane
  # Handles add-a-ball and ball save balls returning to shooter lane
  ##############################################################################
  mb_auto_plunger_delay:
    start_value: 0
    end_value: 1
    direction: up
    tick_interval: 1s
    start_running: false
    control_events:
      - event: s_shooter_lane_active
        action: restart
      - event: s_shooter_lane_inactive
        action: stop
      - event: mode_top_gun_multiball_will_stop
        action: stop

##############################################################################
# SHOW PLAYER - MIG Insert Pulsing + GI Explosion
##############################################################################
show_player:
  # --- MIG INSERT PULSING (red, using sync_flash_mb) ---
  radar_activate_mig_left_orbit:
    mig_lo_flash:
      show: sync_flash_mb
      key: mb_l_shot_left_orbit
      sync_ms: 1000
      loops: -1
      show_tokens:
        led: l_shot_left_orbit
        color: red
  radar_deactivate_mig_left_orbit:
    mig_lo_stop:
      show: sync_flash_mb
      action: stop
      key: mb_l_shot_left_orbit

  radar_activate_mig_left_ramp:
    mig_lr_flash:
      show: sync_flash_mb
      key: mb_l_shot_left_ramp
      sync_ms: 1000
      loops: -1
      show_tokens:
        led: l_shot_left_ramp
        color: red
  radar_deactivate_mig_left_ramp:
    mig_lr_stop:
      show: sync_flash_mb
      action: stop
      key: mb_l_shot_left_ramp

  radar_activate_mig_spinner:
    mig_sp_flash:
      show: sync_flash_mb
      key: mb_l_shot_spinner
      sync_ms: 1000
      loops: -1
      show_tokens:
        led: l_shot_spinner
        color: red
  radar_deactivate_mig_spinner:
    mig_sp_stop:
      show: sync_flash_mb
      action: stop
      key: mb_l_shot_spinner

  radar_activate_mig_barrier:
    mig_cnt_flash:
      show: sync_flash_mb
      key: mb_l_shot_barrier
      sync_ms: 1000
      loops: -1
      show_tokens:
        led: l_shot_barrier
        color: red
  radar_deactivate_mig_barrier:
    mig_cnt_stop:
      show: sync_flash_mb
      action: stop
      key: mb_l_shot_barrier

  radar_activate_mig_tower:
    mig_twr_flash:
      show: sync_flash_mb
      key: mb_l_shot_tower_ramp
      sync_ms: 1000
      loops: -1
      show_tokens:
        led: l_shot_tower_ramp
        color: red
  radar_deactivate_mig_tower:
    mig_twr_stop:
      show: sync_flash_mb
      action: stop
      key: mb_l_shot_tower_ramp

  radar_activate_mig_top_orbit:
    mig_to_flash:
      show: sync_flash_mb
      key: mb_l_shot_middle_ramp_to
      sync_ms: 1000
      loops: -1
      show_tokens:
        led: l_shot_middle_ramp
        color: red
  radar_deactivate_mig_top_orbit:
    mig_to_stop:
      show: sync_flash_mb
      action: stop
      key: mb_l_shot_middle_ramp_to

  radar_activate_mig_top_ramp:
    mig_tr_flash:
      show: sync_flash_mb
      key: mb_l_shot_middle_ramp_tr
      sync_ms: 1000
      loops: -1
      show_tokens:
        led: l_shot_middle_ramp
        color: red
  radar_deactivate_mig_top_ramp:
    mig_tr_stop:
      show: sync_flash_mb
      action: stop
      key: mb_l_shot_middle_ramp_tr

  radar_activate_mig_right_ramp:
    mig_rr_flash:
      show: sync_flash_mb
      key: mb_l_shot_right_orbit
      sync_ms: 1000
      loops: -1
      show_tokens:
        led: l_shot_right_orbit
        color: red
  radar_deactivate_mig_right_ramp:
    mig_rr_stop:
      show: sync_flash_mb
      action: stop
      key: mb_l_shot_right_orbit

  # --- GI EXPLOSION ON MIG KILL (missiles-style cycling, ~3 seconds) ---
  radar_mig_explosion:
    gi_boom:
      show: gi_mig_explosion
      key: mb_gi_explosion
      loops: -1
      priority: 200

  # --- INTRO PREVIEW LIGHTS (dark military green, additive) ---
  # Group 1: LO + LR (immediate on intro start)
  mb_intro_start:
    preview_lo_flash:
      show: sync_flash_mb
      key: mb_preview_l_shot_left_orbit
      sync_ms: 1000
      loops: -1
      show_tokens:
        led: l_shot_left_orbit
        color: "006400"
    preview_lr_flash:
      show: sync_flash_mb
      key: mb_preview_l_shot_left_ramp
      sync_ms: 1000
      loops: -1
      show_tokens:
        led: l_shot_left_ramp
        color: "006400"

  # Group 2: RR + TWR (at 23.5 seconds)
  mb_preview_group_2:
    preview_rr_flash:
      show: sync_flash_mb
      key: mb_preview_l_shot_right_orbit
      sync_ms: 1000
      loops: -1
      show_tokens:
        led: l_shot_right_orbit
        color: "006400"
    preview_twr_flash:
      show: sync_flash_mb
      key: mb_preview_l_shot_tower_ramp
      sync_ms: 1000
      loops: -1
      show_tokens:
        led: l_shot_tower_ramp
        color: "006400"

  # Group 3: SP (at 34 seconds)
  mb_preview_group_3:
    preview_sp_flash:
      show: sync_flash_mb
      key: mb_preview_l_shot_spinner
      sync_ms: 1000
      loops: -1
      show_tokens:
        led: l_shot_spinner
        color: "006400"

  # Stop all preview lights (on skip or normal intro complete)
  mb_stop_preview_lights:
    stop_preview_lo:
      show: sync_flash_mb
      action: stop
      key: mb_preview_l_shot_left_orbit
    stop_preview_lr:
      show: sync_flash_mb
      action: stop
      key: mb_preview_l_shot_left_ramp
    stop_preview_rr:
      show: sync_flash_mb
      action: stop
      key: mb_preview_l_shot_right_orbit
    stop_preview_twr:
      show: sync_flash_mb
      action: stop
      key: mb_preview_l_shot_tower_ramp
    stop_preview_sp:
      show: sync_flash_mb
      action: stop
      key: mb_preview_l_shot_spinner

  # --- ICEMAN COMPLETION: play celebration show (all orange, overrides green) ---
  # Priority 10 ensures show (at 610) beats the green light_player entry (at 600)
  # that fires from player_mb_iceman_X{value==1} AFTER mb_iceman_complete
  mb_iceman_complete:
    iceman_celebration:
      show: mb_iceman_celebration
      key: mb_iceman_celebration
      loops: 0
      priority: 10

  # --- ICEMAN COMPLETION: pilot gear flash only on QUALIFIED completions (1 and 3) ---
  mb_add_a_ball_qualified:
    pilot_gear_flash:
      show: sync_flash_mb
      key: mb_pilot_gear_flash
      sync_ms: 400
      loops: -1
      priority: 10
      show_tokens:
        led: l_shot_pilot_gear
        color: orange

  # Stop pilot gear flash + celebration show when add-a-ball is used
  mb_add_a_ball_activate:
    stop_pilot_gear:
      show: sync_flash_mb
      action: stop
      key: mb_pilot_gear_flash
    stop_celebration:
      show: mb_iceman_celebration
      action: stop
      key: mb_iceman_celebration

  # --- BALL SAVE: flash l_shoot_again during multiball ball save ---
  multiball_top_gun_multiball_started:
    shoot_again_flash:
      show: sync_flash_mb
      key: mb_shoot_again_flash
      sync_ms: 500
      loops: -1
      priority: 10
      show_tokens:
        led: l_shoot_again
        color: white

  multiball_top_gun_multiball_shoot_again_ended:
    shoot_again_stop:
      show: sync_flash_mb
      action: stop
      key: mb_shoot_again_flash

  # Stop celebration show when lights reset (non-qualifying completions)
  mb_iceman_reset_lights:
    stop_celebration_reset:
      show: mb_iceman_celebration
      action: stop
      key: mb_iceman_celebration

  mb_stop_explosion_gi:
    gi_stop:
      show: gi_mig_explosion
      action: stop
      key: mb_gi_explosion

  # Also stop explosion on mode end (safety)
  mode_top_gun_multiball_will_stop:
    gi_cleanup:
      show: gi_mig_explosion
      action: stop
      key: mb_gi_explosion

  # --- SUPER JACKPOT LIT FLASH ---
  radar_super_jackpot_lit:
    super_flash:
      show: sync_flash_mb
      key: mb_super_flash
      sync_ms: 500
      loops: -1
      show_tokens:
        led: l_shot_barrier
        color: yellow
    # Stop any active evade flash (super overrides lockon)
    evade_stop_on_super:
      show: sync_flash_mb
      action: stop
      key: mb_evade_flash

  radar_super_jackpot_collected:
    super_stop:
      show: sync_flash_mb
      action: stop
      key: mb_super_flash

  # --- EVASION TARGET FLASH (green, fast pulse) ---
  # Single key mb_evade_flash: each new target replaces previous
  radar_evasion_shot_left_orbit:
    evade_flash:
      show: sync_flash_mb
      key: mb_evade_flash
      sync_ms: 400
      loops: -1
      show_tokens:
        led: l_shot_left_orbit
        color: lime
  radar_evasion_shot_left_ramp:
    evade_flash:
      show: sync_flash_mb
      key: mb_evade_flash
      sync_ms: 400
      loops: -1
      show_tokens:
        led: l_shot_left_ramp
        color: lime
  radar_evasion_shot_spinner:
    evade_flash:
      show: sync_flash_mb
      key: mb_evade_flash
      sync_ms: 400
      loops: -1
      show_tokens:
        led: l_shot_spinner
        color: lime
  radar_evasion_shot_barrier:
    evade_flash:
      show: sync_flash_mb
      key: mb_evade_flash
      sync_ms: 400
      loops: -1
      show_tokens:
        led: l_shot_barrier
        color: lime
  radar_evasion_shot_tower:
    evade_flash:
      show: sync_flash_mb
      key: mb_evade_flash
      sync_ms: 400
      loops: -1
      show_tokens:
        led: l_shot_tower_ramp
        color: lime
  radar_evasion_shot_top_ramp:
    evade_flash:
      show: sync_flash_mb
      key: mb_evade_flash
      sync_ms: 400
      loops: -1
      show_tokens:
        led: l_shot_middle_ramp
        color: lime
  radar_evasion_shot_right_ramp:
    evade_flash:
      show: sync_flash_mb
      key: mb_evade_flash
      sync_ms: 400
      loops: -1
      show_tokens:
        led: l_shot_right_orbit
        color: lime

  # Stop evasion flash on success or failure
  radar_evasion_success:
    evade_stop:
      show: sync_flash_mb
      action: stop
      key: mb_evade_flash
  radar_evasion_failed:
    evade_stop:
      show: sync_flash_mb
      action: stop
      key: mb_evade_flash

##############################################################################
# LIGHT PLAYER - GI Control
##############################################################################
light_player:
  # GI turns red during multiball (including pop bumper lights)
  # Clear ICEMAN lights for add-a-ball tracking
  mode_top_gun_multiball_started:
    gi_lights:
      color: red
      fade: 500ms
    l_gi_light_pop_left:
      color: red
      fade: 500ms
    l_gi_light_pop_right:
      color: red
      fade: 500ms
    l_gi_light_pop_bottom:
      color: red
      fade: 500ms
    l_iceman_i:
      color: off
      fade: 0ms
    l_iceman_c:
      color: off
      fade: 0ms
    l_iceman_e:
      color: off
      fade: 0ms
    l_iceman_m:
      color: off
      fade: 0ms
    l_iceman_a:
      color: off
      fade: 0ms
    l_iceman_n:
      color: off
      fade: 0ms
    l_shot_pilot_gear:
      color: off
      fade: 0ms
    l_shoot_again:
      color: off
      fade: 0ms

  # GI penalty: turn off (including pops)
  radar_penalty_gi_off:
    gi_lights:
      color: off
      fade: 0ms
    l_gi_light_pop_left:
      color: off
      fade: 0ms
    l_gi_light_pop_right:
      color: off
      fade: 0ms
    l_gi_light_pop_bottom:
      color: off
      fade: 0ms

  # GI penalty end: restore to red (including pops)
  radar_penalty_gi_off_ended:
    gi_lights:
      color: red
      fade: 200ms
    l_gi_light_pop_left:
      color: red
      fade: 200ms
    l_gi_light_pop_right:
      color: red
      fade: 200ms
    l_gi_light_pop_bottom:
      color: red
      fade: 200ms

  # Restore GI on mode stop (including pops)
  mode_top_gun_multiball_will_stop:
    gi_lights:
      color: white
      fade: 0ms
    l_gi_light_pop_left:
      color: white
      fade: 0ms
    l_gi_light_pop_right:
      color: white
      fade: 0ms
    l_gi_light_pop_bottom:
      color: white
      fade: 0ms
    # Clear ICEMAN lights on mode stop
    l_iceman_i:
      color: off
      fade: 0ms
    l_iceman_c:
      color: off
      fade: 0ms
    l_iceman_e:
      color: off
      fade: 0ms
    l_iceman_m:
      color: off
      fade: 0ms
    l_iceman_a:
      color: off
      fade: 0ms
    l_iceman_n:
      color: off
      fade: 0ms
    # Clear pilot gear light
    l_shot_pilot_gear:
      color: off
      fade: 0ms
    # Clear shoot again light
    l_shoot_again:
      color: off
      fade: 0ms

  # ICEMAN letter collection: green inserts (player variable change events)
  player_mb_iceman_i{value==1 and current_player.mb_add_a_balls_used<2}:
    l_iceman_i:
      color: green
      fade: 0ms
  player_mb_iceman_c{value==1 and current_player.mb_add_a_balls_used<2}:
    l_iceman_c:
      color: green
      fade: 0ms
  player_mb_iceman_e{value==1 and current_player.mb_add_a_balls_used<2}:
    l_iceman_e:
      color: green
      fade: 0ms
  player_mb_iceman_m{value==1 and current_player.mb_add_a_balls_used<2}:
    l_iceman_m:
      color: green
      fade: 0ms
  player_mb_iceman_a{value==1 and current_player.mb_add_a_balls_used<2}:
    l_iceman_a:
      color: green
      fade: 0ms
  player_mb_iceman_n{value==1 and current_player.mb_add_a_balls_used<2}:
    l_iceman_n:
      color: green
      fade: 0ms

  # ICEMAN completion: all letters flash orange (handled by show, then light_player sets static)
  mb_iceman_complete:
    l_iceman_i:
      color: orange
      fade: 0ms
    l_iceman_c:
      color: orange
      fade: 0ms
    l_iceman_e:
      color: orange
      fade: 0ms
    l_iceman_m:
      color: orange
      fade: 0ms
    l_iceman_a:
      color: orange
      fade: 0ms
    l_iceman_n:
      color: orange
      fade: 0ms

  # Reset ICEMAN lights after celebration (if more add-a-balls available)
  mb_iceman_reset_lights:
    l_iceman_i:
      color: off
      fade: 0ms
    l_iceman_c:
      color: off
      fade: 0ms
    l_iceman_e:
      color: off
      fade: 0ms
    l_iceman_m:
      color: off
      fade: 0ms
    l_iceman_a:
      color: off
      fade: 0ms
    l_iceman_n:
      color: off
      fade: 0ms

  # After 1st add-a-ball used: reset ICEMAN lights for next collection round
  player_mb_add_a_balls_used{value==1}:
    l_iceman_i:
      color: off
      fade: 0ms
    l_iceman_c:
      color: off
      fade: 0ms
    l_iceman_e:
      color: off
      fade: 0ms
    l_iceman_m:
      color: off
      fade: 0ms
    l_iceman_a:
      color: off
      fade: 0ms
    l_iceman_n:
      color: off
      fade: 0ms

  # After 2nd add-a-ball used: all ICEMAN lights stay solid orange permanently
  player_mb_add_a_balls_used{value>=2}:
    l_iceman_i:
      color: orange
      fade: 0ms
    l_iceman_c:
      color: orange
      fade: 0ms
    l_iceman_e:
      color: orange
      fade: 0ms
    l_iceman_m:
      color: orange
      fade: 0ms
    l_iceman_a:
      color: orange
      fade: 0ms
    l_iceman_n:
      color: orange
      fade: 0ms

  # Add-a-ball activated: turn off pilot gear light
  mb_add_a_ball_activate:
    l_shot_pilot_gear:
      color: off
      fade: 0ms

##############################################################################
# SOUND PLAYER - Callouts
# SOUND FILES NEEDED:
#   top_gun_mb_instructions.ogg        - "Shoot the MIGs!" (plays when gameplay starts)
#   top_gun_mb_evade.ogg               - "You've been locked on!"
#   top_gun_mb_hit_no_hold_flippers.ogg
#   top_gun_mb_hit_reversed_flippers.ogg
#   top_gun_mb_hit_gi_off.ogg
#   top_gun_mb_hit_scoring_reduced.ogg
#   top_gun_mb_hit_progress_reset.ogg
#   top_gun_mb_super_jackpot_lit.ogg
#   top_gun_mb_super_hit.ogg
##############################################################################
sound_player:
  # Instructions callout at 38 seconds into intro video
  mb_play_intro_instructions:
    top_gun_mb_instructions:
      bus: voice
      loops: 0

  # Stop instructions voice if player skips intro
  mb_skip_intro:
    top_gun_mb_instructions:
      action: stop

  # "You've been locked on!"
  radar_mig_lockon:
    top_gun_mb_evade:
      bus: voice
      loops: 0

  # Penalty callouts (one per penalty type)
  radar_penalty_no_hold:
    top_gun_mb_hit_no_hold_flippers:
      bus: voice
      loops: 0

  radar_penalty_reversed:
    top_gun_mb_hit_reversed_flippers:
      bus: voice
      loops: 0

  radar_penalty_gi_off:
    top_gun_mb_hit_gi_off:
      bus: voice
      loops: 0

  radar_penalty_scoring_reduced:
    top_gun_mb_hit_scoring_reduced:
      bus: voice
      loops: 0

  radar_penalty_progress_reset:
    top_gun_mb_hit_progress_reset:
      bus: voice
      loops: 0

  # "Super jackpot is lit!"
  radar_super_jackpot_lit:
    top_gun_mb_super_jackpot_lit:
      bus: voice
      loops: 0

  # Super jackpot collected
  radar_super_jackpot_collected:
    top_gun_mb_super_hit:
      bus: voice
      loops: 0

  # Add-a-ball activated via pilot gear target
  mb_add_a_ball_activate:
    multiball_ball_added:
      bus: voice
      loops: 0

  # Multiball extender activated (wingman perk)
  mb_extender_activate:
    multiball_extended_voice:
      bus: voice
      loops: 0

##############################################################################
# SLIDE PLAYER - Radar display + Videos
##############################################################################
slide_player:
  # Radar display starts when gameplay begins (after intro or immediately if stacked)
  mb_gameplay_start:
    top_gun_multiball:
      action: play
      priority: 500
  mode_top_gun_multiball_will_stop:
    top_gun_multiball:
      action: remove

  # --- INTRO VIDEO (plays over radar until dismissed) ---
  mb_intro_start:
    top_gun_multiball_intro_video:
      action: play
      priority: 900
  mb_skip_intro:
    top_gun_multiball_intro_video:
      action: remove
  timer_mb_intro_video_delay_complete:
    top_gun_multiball_intro_video:
      action: remove

  # --- EVADE VIDEOS (alternating) ---
  mb_play_evade_1:
    evade_1:
      action: play
      priority: 800
      expire: 4s
  mb_play_evade_2:
    evade_2:
      action: play
      priority: 800
      expire: 4s

  # --- HIT VIDEOS (cycling, plays 3s after penalty callout) ---
  mb_play_hit_1:
    hit_1:
      action: play
      priority: 800
      expire: 4s
  mb_play_hit_2:
    hit_2:
      action: play
      priority: 800
      expire: 4s
  mb_play_hit_3:
    hit_3:
      action: play
      priority: 800
      expire: 4s

  # --- EXPLOSION VIDEOS (3.1s each, with cooldown) ---
  mb_play_explosion_1:
    mig_explosion_1:
      action: play
      priority: 800
      expire: 4s
    mode_points_scored:
      action: play
      priority: 840
  mb_play_explosion_2:
    mig_explosion_2:
      action: play
      priority: 800
      expire: 4s
    mode_points_scored:
      action: play
      priority: 840
  mb_play_explosion_3:
    mig_explosion_3:
      action: play
      priority: 800
      expire: 4s
    mode_points_scored:
      action: play
      priority: 840

  # Super jackpot collected - show points
  radar_super_jackpot_collected:
    mode_points_scored:
      action: play
      priority: 840

  # Add-a-ball activated - show slide
  mb_add_a_ball_activate:
    multiball_add_a_ball:
      action: play
      priority: 850
      expire: 3s

  # Multiball extender activated - show slide
  mb_extender_activate:
    multiball_extended:
      action: play
      priority: 850
      expire: 5s

##############################################################################
# COIL PLAYER - Auto-plunger for add-a-ball and ball saves
##############################################################################
coil_player:
  # Auto-plunger: fires 1 second after ball settles on shooter lane
  # Handles add-a-ball launches and saved balls returning to shooter lane
  timer_mb_auto_plunger_delay_complete:
    c_plunger:
      action: pulse
#config_version=6

##############################################################################
## EJECTION SEAT MODE - Magnet Ball Save (SAFE VERSION)
##############################################################################
##
## SEQUENCE:
## 1. Mode starts → "eject" scene plays immediately
## 2. After ACTIVATION_DELAY → Magnet enables (grabs ball)
## 3. Player has FLIPPER_WINDOW seconds to press both flippers
## 4a. Both flippers pressed → Fling sequence → Success
## 4b. Timer expires → Magnet off → Ball drains → Failure
##
## FLING SEQUENCE (explicit control, no pulse):
## 1. Disable magnet (ball starts to drop)
## 2. Wait 200ms (ball drops away from magnet)
## 3. Enable magnet at 0.75 power (pulls ball, gives momentum)
## 4. Wait 75ms (turns off before ball reaches magnet center)
## 5. Disable magnet (ball continues with momentum)
## 6. Success!
##
##############################################################################
## TUNABLE PARAMETERS
##############################################################################
##
## TIMING (in this file):
##   - ejection_activation_delay: end_value = 750ms (time for ball to reach magnet)
##   - ejection_flipper_window: end_value = 5 seconds
##   - ejection_fling_drop_delay: end_value = 200ms (time for ball to drop)
##   - ejection_fling_pull_duration: end_value = 75ms (brief magnet pull)
##
## POWER (in coil_player section):
##   - ejection_fling_pull: hold_power = 0.75 (pull strength)
##
##############################################################################

mode:
  start_events: start_mode_ejection_seat
  stop_events: 
    - ejection_seat_cleanup_complete
  priority: 600
  game_mode: true

##############################################################################
## TIMERS
##############################################################################

timers:
  # Delay before magnet activates (gives ball time to reach magnet area)
  # TUNABLE: Change end_value to adjust delay (in milliseconds)
  ejection_activation_delay:
    start_value: 0
    end_value: 500
    direction: up
    tick_interval: 1ms
    control_events:
      - event: mode_ejection_seat_started
        action: start

  # Window for player to press both flippers
  # TUNABLE: Change end_value to adjust window (in seconds)
  ejection_flipper_window:
    start_value: 0
    end_value: 5
    direction: up
    tick_interval: 1s
    control_events:
      - event: ejection_magnet_activated
        action: start
      - event: ejection_fling_started
        action: stop

  # Safety timeout - forces magnet off even if something goes wrong
  ejection_safety_timeout:
    start_value: 0
    end_value: 7
    direction: up
    tick_interval: 1s
    control_events:
      - event: ejection_magnet_activated
        action: start
      - event: ejection_fling_started
        action: stop
      - event: ejection_failed
        action: stop

  # FLING STEP 1: Time for ball to drop away from magnet
  # TUNABLE: Increase if ball gets re-caught, decrease if fling is weak
  ejection_fling_drop_delay:
    start_value: 0
    end_value: 200
    direction: up
    tick_interval: 1ms
    control_events:
      - event: ejection_fling_started
        action: start

  # FLING STEP 2: Brief magnet pull duration
  # TUNABLE: Increase for stronger fling, decrease if ball gets stuck
  ejection_fling_pull_duration:
    start_value: 0
    end_value: 30
    direction: up
    tick_interval: 1ms
    control_events:
      - event: ejection_fling_pull
        action: start

  # Cleanup delay to let videos play before mode stops
  ejection_success_cleanup_delay:
    start_value: 0
    end_value: 3
    direction: up
    tick_interval: 1s
    control_events:
      - event: ejection_success
        action: start

  ejection_failed_cleanup_delay:
    start_value: 0
    end_value: 3
    direction: up
    tick_interval: 1s
    control_events:
      - event: ejection_failed
        action: start

##############################################################################
## EVENT PLAYER
##############################################################################

event_player:
  # When activation delay completes, activate the magnet
  timer_ejection_activation_delay_complete:
    - ejection_magnet_activated
    - ball_search_block

  # Flipper detection - check if both flippers are held
  s_flipper_left_active{device.timers.ejection_flipper_window.running}:
    - ejection_check_flippers

  s_flipper_right_active{device.timers.ejection_flipper_window.running}:
    - ejection_check_flippers

  # If both flippers are held, start fling sequence
  ejection_check_flippers{device.switches.s_flipper_left.state and device.switches.s_flipper_right.state}:
    - ejection_fling_started

  # FLING SEQUENCE:
  # Step 1: ejection_fling_started → Magnet OFF (ball drops) - handled in coil_player
  
  # Step 2: After drop delay, briefly enable magnet (pull)
  timer_ejection_fling_drop_delay_complete:
    - ejection_fling_pull

  # Step 3: After pull duration, disable magnet and trigger success
  timer_ejection_fling_pull_duration_complete:
    - ejection_fling_release
    - ejection_success

  # Flipper window expired without both flippers - failure
  timer_ejection_flipper_window_complete:
    - ejection_failed

  # Safety timeout - force failure if something is stuck
  timer_ejection_safety_timeout_complete:
    - ejection_safety_triggered
    - ejection_failed

  # Cleanup delays complete - signal mode can stop
  timer_ejection_success_cleanup_delay_complete:
    - ejection_seat_cleanup_complete
    - ball_search_unblock

  timer_ejection_failed_cleanup_delay_complete:
    - ejection_seat_cleanup_complete
    - ball_search_unblock

##############################################################################
## VARIABLE PLAYER
##############################################################################

variable_player:
  # Reset qualification when mode completes (success or failure)
  ejection_success:
    eject_mode_qualified:
      action: set
      int: 0
    score:
      action: add
      int: 250000 * current_player.total_scoring_multiplier

  ejection_failed:
    eject_mode_qualified:
      action: set
      int: 0

##############################################################################
## COIL PLAYER - MAGNET CONTROL (EXPLICIT ENABLE/DISABLE)
##############################################################################

coil_player:
  # GRAB: Enable magnet when activation delay completes
  ejection_magnet_activated:
    c_ejection_seat_magnet:
      action: enable

  # FLING STEP 1: Disable magnet (ball starts to drop)
  ejection_fling_started:
    c_ejection_seat_magnet:
      action: disable

  # FLING STEP 2: Briefly enable magnet (pulls ball, gives momentum)
  # Using higher power for stronger pull
  ejection_fling_pull:
    c_ejection_seat_magnet:
      action: enable
      hold_power: 0.75

  # FLING STEP 3: Disable magnet (ball continues with momentum)
  ejection_fling_release:
    c_ejection_seat_magnet:
      action: disable

  # SAFETY: Ensure magnet is off on success (belt and suspenders)
  ejection_success:
    c_ejection_seat_magnet:
      action: disable

  # SAFETY: Ensure magnet is off on failure
  ejection_failed:
    c_ejection_seat_magnet:
      action: disable

  # SAFETY: Ensure magnet is off when mode stops
  mode_ejection_seat_stopped:
    c_ejection_seat_magnet:
      action: disable

  # SAFETY: Ensure magnet is off if safety timeout triggers
  ejection_safety_triggered:
    c_ejection_seat_magnet:
      action: disable

##############################################################################
## SLIDE PLAYER - GODOT SCENES
##############################################################################

slide_player:
  # Play "eject" scene immediately when mode starts
  mode_ejection_seat_started:
    eject:
      action: play
      priority: 700

  # Play success scene
  ejection_success:
    eject:
      action: remove
    ejection_success:
      action: play
      priority: 700

  # Play failure scene  
  ejection_failed:
    eject:
      action: remove
    ejection_failed:
      action: play
      priority: 700

  # Clean up slides when mode stops
  mode_ejection_seat_stopped:
    eject:
      action: remove
    ejection_success:
      action: remove
    ejection_failed:
      action: remove

##############################################################################
## LIGHT PLAYER
##############################################################################

light_player:
  # Turn off eject light when mode starts (no longer qualified during mode)
  mode_ejection_seat_started:
    l_eject:
      color: off

##############################################################################
## SOUND PLAYER (Optional - uncomment and customize)
##############################################################################

# sound_player:
#   mode_ejection_seat_started:
#     sfx_ejection_alert:
#       bus: sfx
#   
#   ejection_magnet_activated:
#     sfx_magnet_hum:
#       bus: sfx
#       loops: -1
#   
#   ejection_fling_started:
#     sfx_magnet_hum:
#       action: stop
#   
#   ejection_success:
#     sfx_ejection_success:
#       bus: sfx
#   
#   ejection_failed:
#     sfx_ejection_failed:
#       bus: sfx